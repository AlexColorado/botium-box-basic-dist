!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("node-cache"),require("path"),require("botium-core/src/scripting/Constants"),require("botium-core/src/Source"),require("botium-core/src/repos/GitRepo"),require("botium-core/src/Capabilities"),require("natural"),require("fs"),require("mkdirp"),require("rimraf"),require("botium-core"),require("uuid/v1"),require("ioredis"),require("better-queue"),require("url"),require("jsonwebtoken"),require("watson-developer-cloud/assistant/v1"),require("botium-core/src/scripting/CompilerTxt"),require("passport"),require("passport-local"),require("passport-ldapauth"),require("kue"),require("randomatic"),require("bcryptjs"),require("graphql-yoga"),require("graphql-tools"),require("graphql"),require("util"),require("express-jwt"),require("body-parser"),require("botium-connector-fbpagereceiver/src/proxy"),require("request-promise-native"),require("slugify"),require("moment"),require("lodash"),require("debug"),require("xml"),require("pdfkit"),require("concat-stream"),require("dotenv-flow"),require("graphql-redis-subscriptions"),require("prisma-binding"),require("express"),require("connect-history-api-fallback")):"function"==typeof define&&define.amd?define(["node-cache","path","botium-core/src/scripting/Constants","botium-core/src/Source","botium-core/src/repos/GitRepo","botium-core/src/Capabilities","natural","fs","mkdirp","rimraf","botium-core","uuid/v1","ioredis","better-queue","url","jsonwebtoken","watson-developer-cloud/assistant/v1","botium-core/src/scripting/CompilerTxt","passport","passport-local","passport-ldapauth","kue","randomatic","bcryptjs","graphql-yoga","graphql-tools","graphql","util","express-jwt","body-parser","botium-connector-fbpagereceiver/src/proxy","request-promise-native","slugify","moment","lodash","debug","xml","pdfkit","concat-stream","dotenv-flow","graphql-redis-subscriptions","prisma-binding","express","connect-history-api-fallback"],t):e.main=t(e.nodeCache,e.path,e.Constants,e.Source,e.GitRepo,e.Capabilities,e.natural,e.fs,e.mkdirp,e.rimraf,e.botiumCore,e.v1,e.ioredis,e.betterQueue,e.url,e.jsonwebtoken,e.v1$1,e.CompilerTxt,e.passport,e.passportLocal,e.passportLdapauth,e.kue,e.randomatic,e.bcryptjs,e.graphqlYoga,e.graphqlTools,e.graphql,e.util,e.expressJwt,e.bodyParser,e.proxy,e.requestPromiseNative,e.slugify,e.moment,e.lodash,e.debug,e.xml,e.pdfkit,e.concatStream,e.dotenvFlow,e.graphqlRedisSubscriptions,e.prismaBinding,e.express,e.connectHistoryApiFallback)}(this,function(e,t,s,a,r,n,o,i,c,d,l,u,p,h,S,m,f,T,b,y,g,E,w,C,v,I,O,A,R,P,$,N,D,_,x,k,B,q,j,L,U,F,M,J){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t,s=s&&s.hasOwnProperty("default")?s.default:s,a=a&&a.hasOwnProperty("default")?a.default:a,r=r&&r.hasOwnProperty("default")?r.default:r,n=n&&n.hasOwnProperty("default")?n.default:n,o=o&&o.hasOwnProperty("default")?o.default:o,i=i&&i.hasOwnProperty("default")?i.default:i,c=c&&c.hasOwnProperty("default")?c.default:c,d=d&&d.hasOwnProperty("default")?d.default:d,l=l&&l.hasOwnProperty("default")?l.default:l,u=u&&u.hasOwnProperty("default")?u.default:u,p=p&&p.hasOwnProperty("default")?p.default:p,h=h&&h.hasOwnProperty("default")?h.default:h,S=S&&S.hasOwnProperty("default")?S.default:S,m=m&&m.hasOwnProperty("default")?m.default:m,f=f&&f.hasOwnProperty("default")?f.default:f,T=T&&T.hasOwnProperty("default")?T.default:T,b=b&&b.hasOwnProperty("default")?b.default:b,y=y&&y.hasOwnProperty("default")?y.default:y,g=g&&g.hasOwnProperty("default")?g.default:g,E=E&&E.hasOwnProperty("default")?E.default:E,w=w&&w.hasOwnProperty("default")?w.default:w,C=C&&C.hasOwnProperty("default")?C.default:C,v=v&&v.hasOwnProperty("default")?v.default:v,I=I&&I.hasOwnProperty("default")?I.default:I,O=O&&O.hasOwnProperty("default")?O.default:O,A=A&&A.hasOwnProperty("default")?A.default:A,R=R&&R.hasOwnProperty("default")?R.default:R,P=P&&P.hasOwnProperty("default")?P.default:P,$=$&&$.hasOwnProperty("default")?$.default:$,N=N&&N.hasOwnProperty("default")?N.default:N,D=D&&D.hasOwnProperty("default")?D.default:D,_=_&&_.hasOwnProperty("default")?_.default:_,x=x&&x.hasOwnProperty("default")?x.default:x,k=k&&k.hasOwnProperty("default")?k.default:k,B=B&&B.hasOwnProperty("default")?B.default:B,q=q&&q.hasOwnProperty("default")?q.default:q,j=j&&j.hasOwnProperty("default")?j.default:j,L=L&&L.hasOwnProperty("default")?L.default:L,U=U&&U.hasOwnProperty("default")?U.default:U,F=F&&F.hasOwnProperty("default")?F.default:F,M=M&&M.hasOwnProperty("default")?M.default:M,J=J&&J.hasOwnProperty("default")?J.default:J;const G={buildTarget:"COMMUNITY EDITION",buildBranch:"release/1.4.0",buildRevision:"4a101e74173a039d425bc70ede3542288cef1897",buildDate:"2019-03-31T22:00:12+02:00"};var V=G,H=()=>{console.log("BOTIUM BOX - SERVER"),console.log(`BUILD_TARGET: ${G.buildTarget}`),console.log(`BUILD_BRANCH: ${G.buildBranch}`),console.log(`BUILD_REVISION: ${G.buildRevision}`),console.log(`BUILD_TIMESTAMP: ${G.buildDate}`)};const z=k("botium-box-server-cache");var W=class{constructor(t){this.cache=new e({stdTTL:t,checkperiod:.2*t,useClones:!1}),this.loading={}}get(e,t){const s=this.cache.get(e);if(s)return z(`Serving key ${e} from cache`),Promise.resolve(s);if(this.loading[e]){return z(`Load process for key ${e} already running, waiting ...`),new Promise((t,s)=>{this.loading[e].listeners.push({resolve:t,reject:s})})}this.loading[e]=this.loading[e]||{listeners:[]};const a=new Promise((t,s)=>{this.loading[e].listeners.push({resolve:t,reject:s})});return z(`Load process for key ${e} started, waiting ...`),t().then(t=>{z(`Load process for key ${e} ready, notifying listeners ...`),this.cache.set(e,t),this.loading[e].listeners.forEach(({resolve:e})=>e(t)),delete this.loading[e]}).catch(t=>{this.loading[e].listeners.forEach(({reject:e})=>e(t)),delete this.loading[e]}),a}del(e){this.cache.del(e)}delStartWith(e=""){if(!e)return;const t=this.cache.keys();for(const s of t)0===s.indexOf(e)&&this.del(s)}flush(){this.cache.flushAll()}};var X={FindFullTestSet:(e,t)=>e.query.testSet({where:{id:t}}),RetrieveTestSetDetails:e=>({id:e.id,name:e.name,expandConvos:e.expandConvos,expandUtterancesToConvos:e.expandUtterancesToConvos,expandUtterancesIncomprehension:e.expandUtterancesIncomprehension,convos:e.scripts&&e.scripts.filter(e=>"SCRIPTING_TYPE_CONVO"===e.scriptType).map(t=>({format:"SCRIPTING_FORMAT_TXT",content:t.script,sourceTag:{testSetId:e.id,testSetScriptId:t.id}})),pconvos:e.scripts&&e.scripts.filter(e=>"SCRIPTING_TYPE_PCONVO"===e.scriptType).map(t=>({format:"SCRIPTING_FORMAT_TXT",content:t.script,sourceTag:{testSetId:e.id,testSetScriptId:t.id}})),utterances:e.scripts&&e.scripts.filter(e=>"SCRIPTING_TYPE_UTTERANCES"===e.scriptType).map(t=>({format:"SCRIPTING_FORMAT_TXT",content:t.script,sourceTag:{testSetId:e.id,testSetScriptId:t.id}})),folders:e.folders&&e.folders.map(t=>({id:t.id,path:t.path,globFilter:t.globFilter,sourceTag:{testSetId:e.id,testSetFolderId:t.id}})),excels:e.excels&&e.excels.map(t=>({id:t.id,filename:t.filename,filecontent:t.filecontent,hasConvos:t.hasConvos,hasPartialConvos:t.hasPartialConvos,hasUtterances:t.hasUtterances,worksheetsConvos:t.worksheetsConvos,worksheetsPartialConvos:t.worksheetsPartialConvos,worksheetsUtterances:t.worksheetsUtterances,startRow:t.startRow,startCol:t.startCol,sourceTag:{testSetId:e.id,testSetExcelId:t.id}}))})};const K=k("botium-retrieve-all-test-cases");var Y=(e,t,a,r)=>{e.convos&&e.convos.forEach(a=>{let r=[];try{a.format===s.SCRIPTING_FORMAT_TXT&&(r=t.Compile(a.content,s.SCRIPTING_FORMAT_TXT,s.SCRIPTING_TYPE_CONVO)),r&&r.forEach(e=>{e.sourceTag=a.sourceTag})}catch(t){throw K(t),new Error(`${e.name}: Convo Script compilation failed: ${A.inspect(t)}`)}}),e.pconvos&&e.pconvos.forEach(a=>{let r=[];try{a.format===s.SCRIPTING_FORMAT_TXT&&(r=t.Compile(a.content,s.SCRIPTING_FORMAT_TXT,s.SCRIPTING_TYPE_PCONVO)),r&&r.forEach(e=>{e.sourceTag=a.sourceTag})}catch(t){throw K(t),new Error(`${e.name}: Partial Convo Script compilation failed: ${A.inspect(t)}`)}}),e.utterances&&e.utterances.forEach(a=>{let r=[];try{a.format===s.SCRIPTING_FORMAT_TXT&&(r=t.Compile(a.content,s.SCRIPTING_FORMAT_TXT,s.SCRIPTING_TYPE_UTTERANCES)),r&&r.forEach(e=>{e.sourceTag=a.sourceTag})}catch(t){throw K(t),new Error(`${e.name}: Utterance script compilation failed: ${A.inspect(t)}`)}}),e.folders&&e.folders.forEach(s=>{try{const{convos:a,pconvos:r,utterances:n}=t.ReadScriptsFromDirectory(s.path,s.globFilter);a&&a.forEach(e=>{e.sourceTag=Object.assign({},e.sourceTag,s.sourceTag)}),r&&r.forEach(e=>{e.sourceTag=Object.assign({},e.sourceTag,s.sourceTag)}),n&&n.forEach(e=>{e.sourceTag=Object.assign({},e.sourceTag,s.sourceTag)})}catch(t){throw K(t),new Error(`${e.name}: Folder ${s} script compilation failed: ${A.inspect(t)}`)}});let o=Promise.resolve();e.excels&&e.excels.length>0&&(o=Promise.all(e.excels.map(({id:e,filename:a,filecontent:r,hasConvos:o,hasPartialConvos:i,hasUtterances:c,worksheetsConvos:d,worksheetsPartialConvos:l,worksheetsUtterances:u,startRow:p,startCol:h,sourceTag:S})=>new Promise(e=>{const a=Buffer.from(r,"base64");let m=[],f=[],T=[];o&&(d&&(t.caps[n.SCRIPTING_XLSX_SHEETNAMES]=d),isNaN(p)||(t.caps[n.SCRIPTING_XLSX_STARTROW]=p),isNaN(h)||(t.caps[n.SCRIPTING_XLSX_STARTCOL]=h),m=t.Compile(a,s.SCRIPTING_FORMAT_XSLX,s.SCRIPTING_TYPE_CONVO)),i&&(l&&(t.caps[n.SCRIPTING_XLSX_SHEETNAMES_PCONVOS]=l),isNaN(p)||(t.caps[n.SCRIPTING_XLSX_STARTROW]=p),isNaN(h)||(t.caps[n.SCRIPTING_XLSX_STARTCOL]=h),f=t.Compile(a,s.SCRIPTING_FORMAT_XSLX,s.SCRIPTING_TYPE_PCONVO)),c&&(u&&(t.caps[n.SCRIPTING_XLSX_SHEETNAMES_UTTERANCES]=u),isNaN(p)||(t.caps[n.SCRIPTING_XLSX_STARTROW]=p),isNaN(h)||(t.caps[n.SCRIPTING_XLSX_STARTCOL]=h),T=t.Compile(a,s.SCRIPTING_FORMAT_XSLX,s.SCRIPTING_TYPE_UTTERANCES)),m&&m.forEach(e=>{e.sourceTag=Object.assign({},e.sourceTag,S)}),f&&f.forEach(e=>{e.sourceTag=Object.assign({},e.sourceTag,S)}),T&&T.forEach(e=>{e.sourceTag=Object.assign({},e.sourceTag,S)}),e()}))));let i=Promise.resolve();return Promise.all([i,o])};const Q=new o.RegexpTokenizer({pattern:/([A-zÀ-ÿ-$]+|[0-9._]+|.|!|\?|'|"|:|;|,|-)/i}),Z=e=>Q.tokenize(e),ee=e=>Z(e).filter(e=>!se(e));const te=(e,t,s)=>[e.substr(0,t),s,e.substr(t+1)].join("");const se=e=>e&&e.length>1&&e.startsWith("$");var ae={tokenize:ee,evaluateProbability:e=>Math.random()<e,getLongestToken:e=>{const t=ee(e).sort((e,t)=>t.length-e.length);return t.length?t[0]:""},replaceCharAtCaseSensitive:(e,t,s)=>{const a=(e=>e===e.toLocaleLowerCase())(e.charAt(t))?s.toLocaleLowerCase():s.toLocaleUpperCase();return te(e,t,a)},replaceCharAt:te,insertAt:(e,t,s)=>[e.substr(0,t),s,e.substr(t)].join(""),replaceWith:(e,t,s)=>{const a=e.indexOf(t);return[e.substr(0,a),s,e.substr(a+t.length)].join("")},reverse:e=>{return e.split("").reverse().join("")},keymap:{1:["2","q"],2:["1","q","w","3"],3:["2","w","e","4"],4:["3","e","r","5"],5:["4","r","t","6"],6:["5","t","y","z","7"],7:["6","y","z","u","8"],8:["7","u","i","9"],9:["8","i","o","0"],0:["9","o","p"],q:["1","2","w","a"],w:["q","a","s","e","3","2"],e:["w","s","d","r","4","3"],r:["e","d","f","t","5","4"],t:["r","f","g","y","z","6","5"],y:["t","g","h","u","7","6","x","s","a"],u:["y","z","h","j","i","8","7"],i:["u","j","k","o","9","8"],o:["i","k","l","p","0","9"],p:["o","l","0"],a:["y","z","s","w","q"],s:["a","y","z","x","d","e","w"],d:["s","x","c","f","r","e"],f:["d","c","v","g","t","r"],g:["f","v","b","h","y","z","t"],h:["g","b","n","j","u","y","z"],j:["h","n","m","k","i","u"],k:["j","m","l","o","i"],l:["k","p","o"],z:["x","s","a","t","g","h","u","7","6"],x:["y","z","c","d","s"],c:["x","v","f","d"],v:["c","b","g","f"],b:["v","n","h","g"],n:["b","m","j","h"],m:["n","k","j"],"ö":["l","p","ü","ä","-","."],"ä":["-","ö","ü","+","#"],"ü":["p","ö","ä","+","´","ß"],"ß":["ü","p","0"]},normalizeNumberOfResult:(e,t=3)=>{if(e.length<=t)return e;const s=[],a=(e.length-t)/t/2;for(let r=0;r<t;r++)s.push(e[Math.round(a+r*(e.length/t))]);return s},isModifiableWord:(e,t)=>{const s=((e,t)=>{const s=Z(e).sort((e,t)=>t.length-e.length);for(let a=0;a<s.length;a++){const r=s[a];let n=0;do{if((n=e.indexOf(r,n))>=0){if(n<=t&&t<n+r.length)return r;n++}}while(n>=0)}return null})(e,t);return!!s&&!se(s)}};const{normalizeNumberOfResult:re,isModifiableWord:ne}=ae;var oe={execute:e=>{let t=[""];const s=e.toLocaleLowerCase();for(let a=0;a<e.length;a++){const r=e.charAt(a)!==s.charAt(a)&&ne(e,a);r&&(t=t.concat(t));for(let n=0;n<t.length;n++){const o=r&&n<t.length/2;t[n]=t[n].concat(o?s.charAt(a):e.charAt(a))}}return t=t.slice(1),re(t)},metadata:{id:"Case sensitivity"}};const{normalizeNumberOfResult:ie}=ae;var ce={execute:e=>{const t=e.split(/(?<! ) (?! )/);let s=[t[0]];for(let e=1;e<t.length;e++){s=s.concat(s);for(let a=0;a<s.length;a++)s[a]=s[a]+(a<s.length/2?" ":"  "),s[a]=s[a]+t[e]}return s=s.slice(1),ie(s)},metadata:{id:"Duplicate space"}},de={execute:e=>[e+" :)"],metadata:{id:"Emojis"}};const{normalizeNumberOfResult:le}=ae;var ue=[oe,ce,de,{execute:e=>{let t=[""];const s=e.replace(/(.) /g,"$1\n");for(let a=0;a<e.length;a++){e.charAt(a)!==s.charAt(a)&&(t=t.concat(t));for(let r=0;r<t.length;r++)t[r]=t[r].concat(r<t.length/2?e.charAt(a):s.charAt(a))}return t=t.slice(1),le(t)},metadata:{id:"Enter instead of space"}},{execute:e=>[e.replace(" ,"," ").replace(", "," ").replace(","," ")],metadata:{id:"Missing punctiation mark"}}];const{getLongestToken:pe,insertAt:he,replaceWith:Se}=ae;const me=e=>{const t=[];let s=e;return[2,e.length-2].forEach(a=>{t.push(he(e,a,e[a])),s=he(s,a,s[a])}),t.push(s),t};var fe={execute:e=>{const t=[],s=pe(e);return s.length<5?t:(me(s).forEach(a=>{t.push(Se(e,s,a))}),t)},metadata:{id:"Double character"}};const{getLongestToken:Te,replaceWith:be,reverse:ye}=ae;const ge=e=>{const t=new Set([e]);return[1,2].forEach(s=>{let a=s,r=!1;do{const s=e.substr(a,3),n=be(e,s,ye(s));t.has(n)||(t.add(n),r=!0),++a>=e.length-2&&(r=!0)}while(!r)}),t.delete(e),t};var Ee={execute:e=>{const t=[],s=Te(e);return s.length<7?t:(ge(s).forEach(a=>{t.push(be(e,s,a))}),t)},metadata:{id:"Duplicate space"}};const{tokenize:we,replaceWith:Ce}=ae,ve=["Aale, Ahle","Ai, Ei","Annalen, analen","aß, Aas","Bad, bat","bald, ballt","Bällen, bellen","Band, bannt","Beete, bete","bis, Biss","Block, Blog","Boot, bot","Boote, Bote","Bug, buk","Bund, bunt","Chor, Korps","Code, Kot","das, dass","dehnen, denen","erhält, erhellt","Fähre, faire","Fälle, Felle","fällt, Feld","Färse, Ferse, Verse","fast, fasst","fetter, Vetter","fiel, viel","fließt, fliehst, fliest","frisst, Frist","Fühler, Phyla","Geld, gellt","Gewand, gewandt","Grad, Grat","Graf, Graph","Halt, hallt","hallte, halte","hält, Held, hellt","Hämmer, Hemmer","hängst, Hengst","harrt, hart","hasst, hast","Häute, heute","Heer, hehr, her","Hemd, hemmt","hohl, hol","Hund, Hunt","isst, ist","kannte, Kante","konnten, Konten","Kuh, Coup","küsste, Küste","Laib, Leib","Laie, Leihe","laichen, Leichen","lasst, Last","läuten, Leuten","Lärche, Lerche","Leere, Lehre","leeren, lehren","Leerstelle, Lehrstelle","Leid, leiht","Lid, Lied","lies, ließ","liest, least","Mahl, Mal","Mähre, Märe, Meere","mahlen, malen","man, Mann","Märkte, merkte","Meer, mehr","Miene, Mine","misst, Mist","Mohr, Moor","mühten, Mythen","Mund, Munt","Nachnahme, Nachname","nahmen, Namen","packt, Pakt","pisste, Piste","rächen, Rechen","rächt, Recht","Rad, Rat","Rain, rein","Rede, Reede","Reis, reiß","reist, reißt","ruhte, Rute, Route","säen, sähen","Sämann, Seemann","Sätzen, setzen","Saite, Seite","seid, seit","schafft, Schaft","schallten, schalten","Schänke, schenke","schellte, Schelte","Schlächter, schlechter","Schlämme, schlemme","Schwälle, Schwelle","Schwämme, Schwemme","Seen, sehen","seid, seiht, seit","sie, sieh","Siegel, Sigel","Sohle, Sole","Sold, sollt","späht, spät","Stadt, statt","Städte, Stätte","Ställe, Stelle","starrt, Start","stehlen, Stelen","stiehl, Stiel, Stil","Tod, tot","Trend, trennt","Uhrzeit, Urzeit","Verband, verbannt","Verben, werben","verließ, Verlies","verwaist, verweist","Villen, Willen","Waage, vage","Waagen, wagen","Wahl, Wal","wahr, war","wahre, Ware","Waise, Weise","Wald, wallt","Wälle, Welle","Wände, Wende","Weck, weg","Wehr, wer","wehrt, Wert","weiht, weit","weis, weiß","weist, weißt","wieder, wider","wird, Wirt","Zunahme, Zuname","accept,except","acclamation,acclimation","acts,ax,axe","adolescence,adolescents","aeration,erration","aerie,airy","affect,effect","aid,aide","ail,ale","air,heir,err,ere","aisle,isle,I'll","all,awl","allowed,aloud","allude,elude","altar,alter","appose,oppose","arc,ark","are,our","ascent,assent","ate,eight","away,aweigh","aye,I,eye","bade,bayed","bail,bale","bait,bate","bald,bawled,balled","ball,bawl","band,banned","bard,barred","bare,bear","baron,barren","base,bass","based,baste","bazaar,bizarre","be,bee","beach,beech","bean,been","beat,beet","been,bin","beer,bier","bell,belle","berry,bury","berth,birth","better,bettor","bight,bite","billed,build","bird,burred","blew,blue","boar,bore,boor","board,bored","boarder,border","bode,bowed","bold,bowled","bolder,boulder,bowlder","bole,bowl","boos,booze","bough,bow","boy,buoy","braid,brayed","braise,braze,brays,braize","brake,break","breach,breech","bread,bred","brewed,brood","brews,bruise","bridal,bridle","burro,burrow","bus,buss","bused,bust","but,butt","buy,bye,by","cache,cash","callous,callus","can't,cant","cannon,canon","canter,cantor","carat,carrot,caret","caries,carries","cast,caste","cede,seed","cell,sell","cellar,seller","censor,sensor","cent,sent,scent","cents,sense,scents","cereal,serial","cession,session","chaise,chase","chalk,chock","chance,chants","chased,chaste","cheap,cheep","chews,choose","chic,sheik","choir,quire","chord,cored,cord","chute,shoot","cite,site,sight","clause,claws","click,clique","close,clothes","coal,cole","coaled,cold","coarse,course","coated,coded","cocks,cox","complement,compliment","contingence,contingents","coo,coup","coop,coupe","correspondence,correspondents","cosign,cosine","council,counsel","councilor,counselor","creak,creek","crewed,crude","crews,cruise","cue,queue","currant,current","curser,cursor","dam,damn","Dane,deign","days,daze","dear,deer","dense,dents","dependence,dependents","dew,due,do","die,dye","dire,dyer","discreet,discrete","doe,dough","does,doze,doughs","done,dun","dual,duel","ducked,duct","earn,urn","either,ether","emigrant,immigrant","eutopia,utopia","ewe,you,yew","eyed,I'd","fain,feign","faint,feint","fair,fare","fairy,ferry","fate,fete","faze,phase","feat,feet","feudal,futile","find,fined","finish,Finnish","fir,fur","flair,flare","flea,flee","flecks,flex","flew,flue","flour,flower","foaled,fold","for,four,fore","forego,forgo","foreword,forward","forth,fourth","foul,fowl","frees,frieze,freeze","friar,fryer","gage,gauge","gait,gate","gel,jell","gene,jean","gild,guild","gneiss,nice","gored,gourd","grade,grayed,greyed","grate,great","grays,greys,graze","grisly,grizzly","groan,grown","guessed,guest","guide,guyed","guise,guys","hail,hale","hair,hare","hairy,harry","hall,haul","halve,have","hangar,hanger","hay,hey","hays,haze","he'd,heed","he'll,heel,heal","hear,here","heard,herd","heated,heeded","hew,hue","hi,high","higher,hire","him,hymn","ho,hoe","hoar,whore","hoard,horde","hoarse,horse","hoes,hose","hold,holed","hole,whole","holey,wholly,holy","hostel,hostile","hour,our","idle,idol","immanent,imminent","in,inn","incidence,incidents","incite,insight","instance,instants","intense,intents","intension,intention","it's,its","jam,jamb","knave,nave","knead,need,kneed","knew,new","knight,night","knit,nit","knot,not,naught","know,no","knows,nose","lacks,lax","lade,laid","lain,lane","lair,layer","lam,lamb","laps,lapse","lay,lei","lays,laze","leach,leech","lead,led","leak,leek","lean,lien","leased,least","lends,lens","lessen,lesson","lesser,lessor","let's,lets","levee,levy","liar,lyre","lichen,liken","lickerish,licorice","lie,lye","links,lynx","lo,low","load,lode","loan,lone","loch,lock","locks,lox","loop,loupe","loos,lose","lose,loose","made,maid","mail,male","main,mane","maize,maze,Mays","mall,maul","manner,manor","marshal,martial","massed,mast","mat,matte","mean,mien","meat,mete,meet","medal,mettle,meddle,metal","might,mite","mince,mints","mind,mined","miner,minor","missed,mist","moat,mote","mood,mooed","moor,more","morning,mourning","muscle,mussel","mussed,must","naval,navel","nay,neigh","nicks,nix","none,nun","oar,ore,or","ode,owed","oh,owe","once,wants","one,won","oohs,ooze","overseas,oversees","paced,paste","packed,pact","pail,pale","pain,pane","pair,pear,pare","palate,pallet,palette","parish,perish","passed,past","patience,patients","pause,paws","peace,piece","peak,pique,peek","peal,peel","pearl,purl","pedal,petal,peddle","peer,pier","penance,pennants","per,purr","pi,pie","plain,plane","plainer,planer,planar","plait,plate","pleas,please","pole,poll","poor,pour,pore","populace,populous","praise,preys,prays","pray,prey","precedence,precedents","premier,premiere","presence,presents","pride,pried","prier,prior","pries,prize","prince,prints","principal,principle","profit,prophet","rack,wrack","raid,rayed","rail,rale","rain,rein,reign","raise,raze,rays","rap,wrap","rapt,wrapped,wrapt","re-cover,recover","re-lay,relay","read,red","read,reed","real,reel","recede,reseed","reek,wreak","residence,residents","rest,wrest","retch,wretch","rhyme,rime","right,write,rite,wright","ring,wring","ringer,wringer","rise,ryes","road,rowed,rode","roe,row","roil,royal","role,roll","roomer,rumor,rumour","root,route","rose,rows","rote,wrote","rude,rued","rues,ruse","rung,wrung","rye,wry","sail,sale","scene,seen","sea,see","seam,seem","sear,seer","seas,seize,sees","sects,sex","sew,sow,so","shake,sheik","shear,sheer","shoe,shoo","sic,sick","sics,six","side,sighed","sighs,size","sign,sine","slay,sleigh","sleight,slight","slew,slough","soar,sore","soared,sword","sold,soled","sole,soul","some,sum","son,sun","stair,stare","stake,steak","steal,steel","step,steppe","storey,story","straight,strait","suite,sweet","tacked,tact","tacks,tax","tail,tale","taper,tapir","tarry,terry","taught,taut","tea,tee","team,teem","tears,tiers","teas,tees,tease","tense,tents","than,then","there,they're,their","threw,through","throne,thrown","thyme,time","tide,tied","tier,tire","tighten,titan","to,two,too","toad,towed,toed","toe,tow","told,tolled","tracked,tract","tray,trey","udder,utter","vain,vein,vane","vale,veil","vial,vile","vice,vise","wade,weighed","wail,whale","waist,waste","wait,weight","waive,wave","waiver,waver","wale,whale","war,wore","ward,warred","ware,where,wear","warn,worn","wax,whacks","way,whey,weigh","we,wee","we'd,weed","we'll,wheel,weal,wheal","we're,weir,were","we're,whir","we've,weave","weak,week","wearer,where're","weather,whether","wet,whet","wheeled,wield","which,witch","while,wile","whiled,wild","whine,wine","whined,wined,wind","whirled,world","whit,wit","whither,wither","who's,whose","whoa,woe","wood,would","yack,yak","yaw,your,yore,you're","yoke,yolk","yore,your,you're","you'll,Yule","aahed,odd","adieu,ado","ant,aunt","aural,oral","marry,merry","rout,route","seated,seeded","shone,shown","tidal,title","trader,traitor","vary and very"];let Ie;const Oe=()=>{if(Ie)return Ie;const e=ve.map(function(e){return e.toLocaleLowerCase().trim().split(",")});return Ie=[],e.forEach(function(e){e.forEach(function(t){Ie[t]=e.filter(e=>e!==t)})}),Ie},Ae=e=>{const t=Oe();if((e=e.toLocaleLowerCase())in t)return t[e][0]};var Re={execute:e=>{const t=we(e);let s=e;return t.forEach(e=>{const t=Ae(e);t&&(s=Ce(s,e,t))}),s!==e?[s]:[]},metadata:{id:"Homophones"}};const{getLongestToken:Pe,replaceCharAtCaseSensitive:$e,replaceWith:Ne,keymap:De}=ae;const _e=e=>{const t=[];return[2,e.length-2].forEach(s=>{const a=e[s].toLocaleLowerCase();if(a in De){const r=De[a];[r[0],r[r.length-1]].forEach(a=>{t.push($e(e,s,a))})}}),t};var xe={execute:e=>{const t=[],s=Pe(e);return s.length<5?t:(_e(s).forEach(a=>{t.push(Ne(e,s,a))}),t)},metadata:{id:"Mishit"}};const{getLongestToken:ke,replaceCharAtCaseSensitive:Be,replaceWith:qe}=ae;const je=e=>{const t=[];return[2,e.length-2].forEach(s=>{t.push(Be(e,s,""))}),t};var Le={execute:e=>{const t=[],s=ke(e);return s.length<5?t:(je(s).forEach(a=>{t.push(qe(e,s,a))}),t)},metadata:{id:"Missing character"}};const{getLongestToken:Ue,replaceWith:Fe,reverse:Me}=ae;const Je=e=>{const t=new Set([e]);return[2,e.length-2].forEach(s=>{let a=s,r=!1;do{const s=e.substr(a,2),n=Fe(e,s,Me(s));t.has(n)||(t.add(n),r=!0),++a>=e.length-2&&(r=!0)}while(!r)}),t.delete(e),t};var Ge={execute:e=>{const t=[],s=Ue(e);return s.length<5?t:(Je(s).forEach(a=>{t.push(Fe(e,s,a))}),t)},metadata:{id:"Mixing character"}};const{replaceCharAt:Ve}=ae,He={z:"y",Z:"Y",y:"z",Y:"Z"};var ze={execute:e=>{let t=e;for(let e=0;e<t.length;e++){const s=t.charAt(e);s in He&&(t=Ve(t,e,He[s]))}return t===e?[]:[t]},metadata:{id:"qwertz vs qwerty keyboard"}};const{getLongestToken:We,replaceCharAtCaseSensitive:Xe,replaceWith:Ke,keymap:Ye}=ae;const Qe=e=>{const t=[],s=Math.round(e.length/2),a=e[s].toLocaleLowerCase();if(a in Ye){const r=Ye[a];[r[0],r[r.length-1]].forEach(a=>{t.push(Xe(e,s,e[s]+a))})}return t};var Ze={execute:e=>{const t=[],s=We(e);return s.length<5?t:(Qe(s).forEach(a=>{t.push(Ke(e,s,a))}),t)},metadata:{id:"Sausage fingers"}};const{getLongestToken:et,replaceWith:tt}=ae;const st=e=>{const t=new Set([e]);return[1,2].forEach(s=>{let a=s,r=!1;do{const s=e.substr(a,3).split("");let n=Array.from(s);n.push(n[0]),n.shift();const o=tt(e,s.join(""),n.join(""));t.has(o)||(t.add(o),r=!0),++a>=e.length-2&&(r=!0)}while(!r)}),t.delete(e),t};var at=[fe,Ee,Re,xe,Le,Ge,ze,Ze,{execute:e=>{const t=[],s=et(e);return s.length<7?t:(st(s).forEach(a=>{t.push(tt(e,s,a))}),t)},metadata:{id:"Shift characters"}}];const rt=ue.concat(at),nt={};rt.forEach(e=>{nt[e.metadata.id]=e});const ot={};ue.forEach(e=>{ot[e.metadata.id]="habits"}),at.forEach(e=>{ot[e.metadata.id]="typo"});var it={GetMutatorById:e=>{if(!(e in ot))throw Error(`Unknown ID: ${e}`);return nt[e]},allMutatorNames:Object.keys(nt),pipelineAllMutatorCombined:[[ue,at],[ue],[at]],pipelineAllMutatorNotCombined:[[ue],[at]]};const{pipelineAllMutatorCombined:ct,pipelineAllMutatorNotCombined:dt,GetMutatorById:lt,allMutatorNames:ut}=it;const pt=(e,t)=>{let s=new Set;for(const a of t){let t=[e];for(const e of a){let s=[];for(const a of e)for(const e of t)s=s.concat(a.execute(e));t=s}for(const e of t)s.has(e)?console.log("duplicate utterance : <"+e+"> created by "+JSON.stringify(a,2)):s.add(e)}return[...s]};const ht=e=>{if(!e.humanifiersToExecute||!e.humanifiersToExecute.length)return[[dt]];return[[(e=>e.map(e=>lt(e)))(e.humanifiersToExecute)]]};var St={pipelineAllMutatorCombined:ct,pipelineAllMutatorNotCombined:dt,allHumanifiers:ut,Execute:(e,t)=>{const s=ht(t);return pt(e,s)},ExecutePipeline:pt};const mt=k("botium-box-clone-testset"),{BotDriver:ft}=l,{RetrieveTestSetDetails:Tt}=X;const bt=(e,a)=>{const r=t.join(process.env.TESTSETDIR,`${D(a)}_CLONED_${w("Aa0",5)}`);c.sync(r);const n=Object.keys(e.utterances);for(let s=0;s<n.length;s++){let a=[n[s]].concat(e.utterances[n[s]].utterances).join("\r\n");i.writeFile(t.join(r,`${n[s]}.utterances.txt`),a,function(e){if(e)throw e})}const o=e.GetCompiler(s.SCRIPTING_FORMAT_TXT);for(let s=0;s<e.convos.length;s++){let a=o.Decompile([e.convos[s]]);i.writeFile(t.join(r,`c${s}.convo.txt`),a,function(e){if(e)throw e})}return r},yt=(e,t)=>{const s={all:e.utterances,me:new Set,bot:new Set,both:null,neither:null,toHumanify:{},allUtteranceCount:0,utterancesToHumanifyCount:0};s.neither=new Set(Object.keys(s.all)),e.convos.forEach(e=>{e.conversation.forEach(e=>{e.messageText&&e.messageText in s.all&&(s[e.sender].add(e.messageText),s.neither.delete(e.messageText))})});const a=x.uniq(Array.from(s.me)).filter(e=>s.bot.has(e));s.both=new Set(a);const r={};let n=0,o=0;return t.humanifiersToExecute&&t.humanifiersToExecute.length&&[...s.me,...a,...s.neither].forEach(e=>{o+=s.all[e].utterances.length;let a=Math.round(o*t.percentToHumanify-n);0===n&&0===a&&(a=1),r[e]=a,n+=a}),s.toHumanify=r,s.allUtteranceCount=o,s.utterancesToHumanifyCount=n,s},gt=(e,t,s)=>{t.both.forEach(s=>{if(t.toHumanify[s]){let t=s+"_JUST_BOT";if(t in e.utterances)throw new Error(`There is already an utterance ${t} in the testset!`)}});const a={humanifiedRefs:[],humanifiedRefCount:0,humanifiedUtterancesCount:0,duplicates:0};t.both.forEach(s=>{t.toHumanify[s]&&(e.utterances[s+"_JUST_BOT"]=x.cloneDeep(e.utterances[s]))});Object.keys(t.toHumanify).forEach(r=>{if(t.toHumanify[r]){const n=(a=>{e.utterances[a].utterances=x.uniq(e.utterances[a].utterances);const r=t.toHumanify[a],n=e.utterances[a].utterances;let o=0;for(let t=0;t<r;t++){const r=St.Execute(n[t],{humanifiersToExecute:s.humanifiersToExecute});e.utterances[a].utterances=e.utterances[a].utterances.concat(r),o+=r.length}let i=e.utterances[a].utterances.length;return e.utterances[a].utterances=x.uniq(e.utterances[a].utterances),{humanifiedRefCount:r,humanifiedUtterancesCount:o,duplicates:i-e.utterances[a].length}})(r);a.humanifiedRefs.push(r),a.humanifiedRefCount+=n.humanifiedRefCount,a.humanifiedUtterancesCount+=n.humanifiedUtterancesCount,a.duplicates+=n.duplicates}});const r=[];return e.convos.forEach(e=>{((e,t)=>(e.conversation.forEach(e=>{if(e.messageText&&t.both.has(e.messageText))return!0}),!1))(e,t)}),e.convos=e.convos.concat(r),a.clonedConvoCount=r.length,a};var Et={possibleOptions:{humanifiers:St.allHumanifiers},CloneTestset:(e,s)=>{const a=new ft,r=a.BuildCompiler(),n=t.join(process.env.BOTIUM_TEMPDIR,`${D(e.name)}_CLONED_${w("Aa0",5)}`);return c.sync(n),Y(Tt(e),r,0,a.sources).then(()=>{d(n,e=>{e&&mt(`Failed rimraf ${n}: ${e}`)});const t={},a=yt(r,s);return t.utterances={all:Object.keys(a.all).length,me:a.me.size,bot:a.bot.size,both:a.both.size,neither:a.neither.size,toHumanify:Object.values(a.toHumanify).filter(e=>e).length,allUtteranceCount:a.allUtteranceCount,utterancesToHumanifyCount:a.utterancesToHumanifyCount},t.process=gt(r,a,s),mt(`Cloning finished: ${JSON.stringify(t)}`),bt(r,e.name)})}};const{BotDriver:wt}=l,{RetrieveTestSetDetails:Ct}=X,vt=k("botium-box-mutate-testset"),It=" \n{\n  id\n  name\n  client { id }\n  expandConvos\n  expandUtterancesToConvos\n  expandUtterancesIncomprehension\n  tags\n  scripts { id script scriptType }\n  repositories { id giturl gitbranch gitdir globFilter }\n  folders { id path globFilter }\n  excels { id filename filecontent hasConvos hasPartialConvos hasUtterances worksheetsConvos worksheetsPartialConvos worksheetsUtterances startRow startCol }\n}";var Ot={createTestSet:async(e,{testSet:t},s,a)=>s.db.mutation.createTestSet({data:t},a),async updateTestSet(e,{id:t,testSet:s},a,r){if(!await a.db.exists.TestSet({id:t}))throw new Error(`TestSet not found ${t}`);return a.db.mutation.updateTestSet({where:{id:t},data:s},r)},deleteTestSet:async(e,{id:t},s)=>new Promise((e,a)=>{s.db.mutation.deleteTestSet({where:{id:t}},"{id}").then(()=>e(!0)).catch(e=>a(e))}),createTestSetScript:async(e,{testSetScript:t},s,a)=>s.db.mutation.createTestSetScript({data:t},a),async updateTestSetScript(e,{id:t,testSetScript:s},a,r){if(!await a.db.exists.TestSetScript({id:t}))throw new Error(`TestSetScript not found ${t}`);return a.db.mutation.updateTestSetScript({where:{id:t},data:s},r)},deleteTestSetScript:async(e,{id:t},s)=>new Promise((e,a)=>{s.db.mutation.deleteTestSetScript({where:{id:t}},"{id}").then(()=>e(!0)).catch(e=>a(e))}),async createTestSetRepository(e,{testSetRepository:t},s,a){},async updateTestSetRepository(e,{id:t,testSetRepository:s},a,r){},async deleteTestSetRepository(e,{id:t},s){},createTestSetFolder:async(e,{testSetFolder:t},s,a)=>s.db.mutation.createTestSetFolder({data:t},a),async updateTestSetFolder(e,{id:t,testSetFolder:s},a,r){if(!await a.db.exists.TestSetFolder({id:t}))throw new Error(`TestSetFolder not found ${t}`);return a.db.mutation.updateTestSetFolder({where:{id:t},data:s},r)},deleteTestSetFolder:async(e,{id:t},s)=>new Promise((e,a)=>{s.db.mutation.deleteTestSetFolder({where:{id:t}},"{id}").then(()=>e(!0)).catch(e=>a(e))}),createTestSetExcel:async(e,{testSetExcel:t},s,a)=>s.db.mutation.createTestSetExcel({data:t},a),async updateTestSetExcel(e,{id:t,testSetExcel:s},a,r){if(!await a.db.exists.TestSetExcel({id:t}))throw new Error(`TestSetExcel not found ${t}`);return a.db.mutation.updateTestSetExcel({where:{id:t},data:s},r)},deleteTestSetExcel:async(e,{id:t},s)=>new Promise((e,a)=>{s.db.mutation.deleteTestSetExcel({where:{id:t}},"{id}").then(()=>e(!0)).catch(e=>a(e))}),async cloneTestSet(e,{id:s,options:a},r,n){const o=await r.db.query.testSet({where:{id:s}},It);if(!o)throw new Error(`TestSet not found ${s}`);const i=await Et.CloneTestset(o,a),c=`${o.name}/${t.basename(i)}`,d=`${o.name} cloned to "${t.basename(i)}", Humanifiers "${a.humanifiersToExecute&&a.humanifiersToExecute.join(", ")}", percentage ${a.percentToHumanify}.`,l={data:{...o,name:c,client:o.client&&{connect:{id:o.client.id}}||null,description:d,tags:{set:o.tags?[...o.tags,"Cloned"]:["Cloned"]},folders:{create:[{name:"cloned",path:t.resolve(i)}]},repositories:{},scripts:[],excels:{}}};return delete l.data.id,r.db.mutation.createTestSet(l,n)},async updateTestSetStats(e,{id:s},a,r){const n=await a.db.query.testSet({where:{id:s}},It);if(!n)throw new Error(`TestSet not found ${s}`);const o=new wt,i=o.BuildCompiler(),l=t.join(process.env.BOTIUM_TEMPDIR,`${D(n.name)}_STATS_${w("Aa0",5)}`);c.sync(l);const u=Ct(n);try{await Y(u,i,0,o.sources);const e=i.convos&&i.convos.map(e=>({name:e.header.name,order:e.header.order,description:e.header.description,sourceTag:JSON.stringify(e.sourceTag),stepCount:e.conversation&&e.conversation.length||0}))||[],t=i.partialConvos&&Object.values(i.partialConvos).map(e=>({name:e.header.name,description:e.header.description,sourceTag:JSON.stringify(e.sourceTag),stepCount:e.conversation&&e.conversation.length||0}))||[],n=e.length,c=t.length,p=Object.keys(i.utterances).reduce((e,t)=>e+i.utterances[t].utterances.length,0),h=await a.db.query.testSet({where:{id:s}},"{ statsCompiledConvos { id } }");return await a.db.mutation.updateTestSet({where:{id:s},data:{statsUpdatedAt:new Date,statsConvoCount:n||0,statsPartialConvoCount:c||0,statsUtterancesCount:p||0,statsCompiledConvos:{create:e.concat(t),deleteMany:{id_in:h.statsCompiledConvos&&h.statsCompiledConvos.map(e=>e.id)||[]}}}},r)}finally{d(l,e=>{e&&vt(`Failed rimraf ${l}: ${e}`)})}}};const{updateTestSetStats:At}=Ot,Rt=k("botium-box-testset-scanner"),Pt=(e,s)=>process.env.TESTSETDIR_PUBLIC?t.resolve(process.env.TESTSETDIR_PUBLIC,s):t.resolve(e,s),$t=(e,s)=>i.readdirSync(e).reduce((a,r)=>{const n=t.join(e,r);return s(n)&&a.push(r),a},[]),Nt=async(e,s,a)=>{const r=t.join(s,a);Rt(`scanDirForTestSets scanning ${r} ...`);const n=(e=>$t(e,e=>i.statSync(e).isDirectory()))(r),o=(e=>$t(e,e=>i.statSync(e).isFile()))(r);if(n&&n.length>0)await n.forEach(async r=>{const n=Pt(s,t.join(a,r));await(async(e,s)=>{let a=await e.query.testSetFolders({where:{path:s}},"{ id name testSet { id name } }");return a&&0!==a.length||(a=await e.query.testSetFolders({where:{path:s+t.sep}},"{ id name testSet { id name } }")),!!(a&&a.length>0)&&(Rt(`Folder ${s} already in use - ${a[0].name} in Test Set ${a[0].testSet.name}`),!0)})(e,n)||await Nt(e,s,t.join(a,r))});else if(o&&o.length>0){const n={data:{name:a.split(t.sep).join("/"),description:`Imported from directory ${r}, ${o.length} files`,expandConvos:!0,expandUtterancesToConvos:!0,tags:{set:a.split(t.sep)},folders:{create:[{name:a,path:Pt(s,a)}]}}};try{const t=await e.mutation.createTestSet(n,"{ id }");Rt(`scanDirForTestSets ${a} Imported Test Set ${t.id} with ${o.length} files`),await At(void 0,{id:t.id},{db:e}),Rt(`scanDirForTestSets ${a} Updated Test Set Stats ${t.id}`)}catch(e){Rt(`scanDirForTestSets ${a} Failed to create ${n.data}: ${e}`)}}};var Dt=e=>{(async()=>{Nt(e,process.env.TESTSETDIR,".")})().catch(e=>{Rt(`scanForTestSets failed: ${e}`)})};const _t=k("botium-box-server-livechat"),xt=l.BotDriver,kt=process.env.BOTIUMBOX_LIVECHAT_IDLE_TIMEOUT||3e5,Bt={},qt={},jt=({conversationId:e,queueSettings:t,pubsub:s})=>{qt[e]&&clearTimeout(qt[e]),qt[e]=setTimeout(async()=>{const a=new p(t.redis);_t(`Auto cleanup of conversation ${e} after ${kt}ms idle time`),Lt(e),await a.del(e),s.publish(e,{liveChatConvoStepAdded:{err:`Automatically closed chatbot connection after ${kt}ms idle time`}})},kt)},Lt=async e=>{qt[e]&&clearTimeout(qt[e]),delete qt[e];const t=Bt[e];if(t){try{await t.Stop()}catch(t){_t(`stopConversation(${e}) Stop failed: ${t}`)}try{await t.Clean()}catch(t){_t(`stopConversation(${e}) Clean failed: ${t}`)}_t(`stopConversation(${e}) container stopped.`),delete Bt[e]}},Ut=async({conversationId:e},{queueSettings:t})=>{const s=new p(t.redis),a=await s.get(e);return a&&JSON.parse(a)},Ft=async(e,t,s)=>{await s.set(e,JSON.stringify(t)),await s.expire(e,kt/1e3);const a=await s.ttl(e);_t(`updateConversation(${e}) TTL(seconds): ${a}`)};var Mt={startListeners:async({db:e,pubsub:t,queueSettings:s})=>new Promise((e,a)=>{const r=new p(s.redis);r.subscribe("livechat.send","livechat.stop",(t,s)=>{t?a(new Error(`Redis subscribe failed: ${t}`)):(_t(`Livechat Redis connected to ${s} channels.`),e())}),r.on("message",async(e,s)=>{const{conversationId:a,convoStep:r}=JSON.parse(s);if(!Bt[a])return;const n=Bt[a];if("livechat.send"===e){_t(`liveChatSendToBot(${a}) sending convoStep ${r}`);try{await n.UserSays(r)}catch(e){_t(`liveChatSendToBot UserSays failed: ${e}`),t.publish(a,{liveChatConvoStepAdded:{err:`${e}`}})}}else"livechat.stop"===e&&Lt(a)})}),startBot:async({caps:e},{pubsub:t,queueSettings:s})=>{const a=new p(s.redis),r=u(),n=new xt(e);var o=new h(async(e,n)=>{try{const n=await Ut({conversationId:r},{queueSettings:s}),o=n.length,i=JSON.stringify(Object.assign(e,{convoStepIndex:o}));t.publish(r,{liveChatConvoStepAdded:{convoStep:i}}),n.push(i),Ft(r,n,a),jt({conversationId:r,queueSettings:s,pubsub:t})}catch(e){_t(`listenerQueue err: ${e}`)}n()});n.on("MESSAGE_SENTTOBOT",(e,t)=>o.push(t)),n.on("MESSAGE_RECEIVEDFROMBOT",(e,t)=>o.push(t));const i=await n.Build();return Bt[r]=i,_t(`liveChatStartBot(${r}) container built, now starting`),await i.Start(),_t(`liveChatStartBot(${r}) container started.`),Ft(r,[],a),jt({conversationId:r,queueSettings:s,pubsub:t}),r},sendToBot:async({conversationId:e,convoStep:t},{queueSettings:s})=>{new p(s.redis).publish("livechat.send",JSON.stringify({conversationId:e,convoStep:t}))},stopBot:async({conversationId:e},{queueSettings:t})=>{new p(t.redis).publish("livechat.stop",JSON.stringify({conversationId:e}))},getConversation:Ut,getConversationScript:async({caps:e,conversationId:t,testCaseName:s},{queueSettings:a})=>{const r=await Ut({conversationId:t},{queueSettings:a});if(!x.isArray(r))throw new Error("Conversation not available (anymore).");const n=new xt(e).BuildCompiler(),o={header:{name:s},conversation:r.map(e=>JSON.parse(e))},i=n.Decompile([o],"SCRIPTING_FORMAT_TXT");return _t(`Decompiled script: ${i}`),i}};const Jt=k("botium-box-server-agents-utils");const Gt=e=>({ref:e.ref,src:e.src,global:e.global,args:e.args&&JSON.parse(e.args)});var Vt={getServerDefaultCapabilities:e=>({FBPAGERECEIVER_REDISURL:e&&e.queueSettings&&e.queueSettings.redis}),getAttachment:(e,t)=>e.query.testSessionTestCaseResultAttachment({where:{id:t}},"{ id name mimeType base64 testSessionTestCaseResult { testSession { client { id } } } }"),getExcel:(e,t)=>e.query.testSetExcel({where:{id:t}},"{ id filename filecontent testSet { client { id } } }"),lookupApiKey:(e,t)=>{const s=new Date(Date.now()).toISOString();if(!t)return;const a={where:{AND:[{key:t},{OR:[{validFrom:null},{validFrom_lte:s}]},{OR:[{validTo:null},{validTo_gte:s}]}]}};return e.query.apiKeys(a,"{ id name clients { id name } }").then(e=>e&&0!==e.length?(e[0].roles=[{id:"APIKEY",name:"APIKEY",permissions:["*"]}],e[0]):null)},findFullTestSession:(e,t)=>e.query.testSession({where:{id:t}},"{ \n    id \n    name\n    client { id name }\n    description\n    createdAt\n    tags\n    batchCount\n    chatbot { \n      id \n      name\n      description \n      tags\n      capabilities { name type stringValue intValue booleanValue jsonValue } \n      sources { name type stringValue intValue booleanValue jsonValue } \n      envs { name type stringValue intValue booleanValue jsonValue } \n    } \n    testSets { \n      id \n      name\n      description \n      tags\n      expandConvos\n      expandUtterancesToConvos\n      expandUtterancesIncomprehension\n      scripts { id name script scriptType } \n      repositories { id name giturl gitbranch gitdir globFilter } \n      folders { id name path globFilter }\n      excels { id name filename filecontent hasConvos hasPartialConvos hasUtterances worksheetsConvos worksheetsPartialConvos worksheetsUtterances startRow startCol }\n    }\n    deviceSets { id name description tags provider { id name type url username password } devices { id name capabilities } } \n    testProject { id name description tags capabilities { name type stringValue intValue booleanValue jsonValue } }\n    registeredComponents { id name type default src ref global args }\n    agent { id name } \n    capabilities { name type stringValue intValue booleanValue jsonValue } \n    sources { name type stringValue intValue booleanValue jsonValue } \n    envs { name type stringValue intValue booleanValue jsonValue } \n    }"),findSimpleTestSessionResults:(e,t)=>e.query.testSession({where:{id:t}},"{ id name status createdAt\n    client { id name }\n    results { \n      id testcaseName createdAt testcaseSource success err duration \n      testSet { id name tags } \n      testSetRepository { id name gitbranch }\n      testSetFolder { id name }\n      testSetExcel { id name }\n      testSetFilename\n    } }"),findAgentFromJobData:(e,t,s)=>{if(!t.data.name||!t.data.group){const e=`invalid agent event, name or group not given ${t.data}`;return Jt(e),Promise.reject(e)}return e.query.agent({where:{name:t.data.name}},s||"{ id, name, capabilities { name type stringValue intValue booleanValue jsonValue } }")},combineRegisteredComponents:(...e)=>{const t={ASSERTERS:[],LOGIC_HOOKS:[],USER_INPUTS:[]},s={ASSERTER:"ASSERTERS",LOGICHOOK:"LOGIC_HOOKS",USERINPUT:"USER_INPUTS"};return e&&e.forEach(e=>{e&&e.forEach(e=>{const a=s[e.type];if(!a)return;const r=t[a].findIndex(t=>t.ref===e.ref);r>=0?t[a][r]=Gt(e):t[a].push(Gt(e))})}),t},composeBotiumCapabilities:e=>e&&e.reduce((e,t)=>("STRING"!==t.type&&"TEXT"!==t.type||(e[t.name]=t.stringValue?t.stringValue.replace(/\\n/g,"\n"):""),"INT"===t.type&&(e[t.name]=parseInt(t.intValue)),"BOOLEAN"===t.type&&(e[t.name]=!!t.booleanValue),"JSON"===t.type&&(e[t.name]=t.jsonValue),e),{}),combineBotiumCapabilities:(...e)=>{const t={};return e&&e.forEach(e=>{e&&Object.keys(e).forEach(s=>{t[s]=e[s]})}),t}};const Ht=k("botium-box-server-charts-mutation");var zt={updateChartCacheForTestSession:(e,{testSessionId:t},s,a)=>s.db.query.testSession({where:{id:t}},"{ id status results { success testSet { id } } jobs { status totalCount failedCount successCount } }").then(e=>{if(!e)return;const a={};return"READY"===e.status||"FAILED"===e.status?(a.totalCount=e.jobs.filter(e=>"READY"===e.status||"FAILED"===e.status).reduce((e,t)=>e+(t.totalCount||0),0)||0,a.failedCount=e.jobs.filter(e=>"READY"===e.status||"FAILED"===e.status).reduce((e,t)=>e+(t.failedCount||0),0)||0,a.successCount=e.jobs.filter(e=>"READY"===e.status||"FAILED"===e.status).reduce((e,t)=>e+(t.successCount||0),0)||0):(a.totalCount=e.results.length,a.failedCount=e.results.filter(e=>!e.success).length,a.successCount=e.results.filter(e=>e.success).length),a.countByTestSetId=e.results.reduce((e,t)=>{const s=t.testSet?t.testSet.id:"NULL";return e[s]||(e[s]={totalCount:0,failedCount:0,successCount:0}),e[s].totalCount++,t.success?e[s].successCount++:e[s].failedCount++,e},{}),a.countByDeviceSetId=e.results.reduce((e,t)=>{const s=t.deviceSet?t.deviceSet.id:"NULL";return e[s]||(e[s]={totalCount:0,failedCount:0,successCount:0}),e[s].totalCount++,t.success?e[s].successCount++:e[s].failedCount++,e},{}),Ht(`updateChartCacheForTestSession ${t} chartData updated: ${A.inspect(a)}`),s.db.mutation.updateTestSession({where:{id:e.id},data:{chartData:JSON.stringify(a)}}).then(()=>a)}).then(e=>(s.chartsCache.flush(),e))};const{URL:Wt}=S,Xt=k("botium-box-server-agents-testsession"),{RetrieveTestSetDetails:Kt}=X,{updateChartCacheForTestSession:Yt}=zt;const Qt=new h(async(e,t)=>{const s=x.uniq(e.map(e=>e.testSessionId));Xt(`sendProgressProcessingQueue for testSessionIds: ${s}`),s.forEach(async t=>{try{await Yt(null,{testSessionId:t},e[0].ctx)}catch(e){Xt(`updateChartCacheForTestSession failed: ${e}`)}e[0].ctx.pubsub.publish("TEST_SESSION_PROGRESS",{testSessionProgress:{id:t}})}),t()},{batchSize:1e3,batchDelay:3e3}),Zt=(e,t)=>{Qt.push({testSessionId:t,ctx:e})};var es={startTestSession:async(e,{testSessionId:t})=>{try{const s=await Vt.findFullTestSession(e.db,t);if(!s)throw new Error(`Test Session ${t} not configured`);const a=s.agent?"process.run."+s.agent.name:"process.run";Xt(`startTestSession ${s.id} queueToSend: ${a}`);const r=await e.db.query.registeredComponents({where:{default:!0}}),n=Vt.combineRegisteredComponents(r,s.registeredComponents),o=Vt.combineBotiumCapabilities(n,{PROJECTNAME:s.name},Vt.composeBotiumCapabilities(s.chatbot.capabilities),s.testProject&&Vt.composeBotiumCapabilities(s.testProject.capabilities)||[],Vt.composeBotiumCapabilities(s.capabilities),Vt.getServerDefaultCapabilities(e));Xt(`startTestSession ${s.id} testSessionCaps: ${JSON.stringify(o)}`);const i=Vt.combineBotiumCapabilities(Vt.composeBotiumCapabilities(s.chatbot.sources),Vt.composeBotiumCapabilities(s.sources));Xt(`startTestSession ${s.id} testSessionSources: ${JSON.stringify(i)}`);const c=Vt.combineBotiumCapabilities(Vt.composeBotiumCapabilities(s.chatbot.envs),Vt.composeBotiumCapabilities(s.envs));Xt(`startTestSession ${s.id} testSessionEnvs: ${JSON.stringify(c)}`);const d=s.testSets.map(e=>Kt(e));Xt(`startTestSession ${s.id} testSessionTestSets: ${JSON.stringify(d)}`);let l=1;const u=async(t,r)=>{for(let n=1;n<=l;n++){const o=await e.db.mutation.createTestSessionJob({data:{status:"PENDING",progressPercent:0,testSession:{connect:{id:s.id}}}},"{ id }"),d=e.queueConnector.create(a,{title:`Processing Job #${n}/${l} for Test Session ${s.name}`,testSessionId:s.id,testSessionName:s.name,testSessionJobId:o.id,botium:{Capabilities:t,Sources:i,Envs:c},testSets:r,batchNum:n,batchCount:l}).removeOnComplete(!0).save(t=>{if(t)return Xt(`Saving batchJob failed: ${t}`);const a=d.id;e.db.mutation.updateTestSessionJob({data:{jobId:a},where:{id:o.id}}).then(()=>{Xt(`TestSessionJob for TestSession ${s.name} registered (jobId: ${a} id: ${o.id})`)}).catch(e=>{Xt(`TestSessionJob for TestSession ${s.name} registration failed (jobId: ${a}): ${e}`)})})}};if(s.deviceSets&&s.deviceSets.length>0){const e=s.deviceSets.reduce((e,t)=>[...e,...t.devices.map(e=>{const a=t.provider.url&&new Wt(t.provider.url),r=a?{protocol:a&&a.protocol.replace(":",""),host:a&&a.host,port:a&&a.port,path:a&&a.pathname}:{};return"SAUCELABS"===t.provider.type?{deviceSetId:t.id,deviceName:e.name,deviceOptions:Object.assign({desiredCapabilities:Object.assign({},JSON.parse(e.capabilities),{name:s.name,username:t.provider.username,accessKey:t.provider.password})},r)}:"TESTOBJECTS"===t.provider.type?{deviceSetId:t.id,deviceName:e.name,deviceOptions:Object.assign({desiredCapabilities:Object.assign({},JSON.parse(e.capabilities),{testobject_suite_name:s.name,testobject_api_key:t.provider.password})},r)}:"LOCALSELENIUM"===t.provider.type?{deviceSetId:t.id,deviceName:e.name,deviceOptions:Object.assign({desiredCapabilities:Object.assign({},JSON.parse(e.capabilities),{name:s.name})},r)}:("INTEGRATED"===t.provider.type&&(Xt(`startTestSession ${s.id} adding capability for starting integrated PhantomJS`),o.WEBDRIVERIO_START_PHANTOMJS=!0),{deviceSetId:t.id,deviceName:e.name,deviceOptions:Object.assign({desiredCapabilities:Object.assign({},JSON.parse(e.capabilities),{name:s.name})},r)})})],[]);Xt(`startTestSession ${s.id} testSessionDevices: ${JSON.stringify(e,null,2)}`);let t=Promise.resolve();e.forEach(e=>{const s=t=>t&&t.forEach(t=>{t.sourceTag=Object.assign({},t.sourceTag,{deviceSetId:e.deviceSetId,deviceName:e.deviceName})}),a=x.cloneDeep(d);a.forEach(e=>{s(e.convos),s(e.utterances),s(e.repositories),s(e.folders),s(e.excels)});const r=Object.assign({},o,{WEBDRIVERIO_OPTIONS:e.deviceOptions});t=t.then(()=>u(r,a))}),await t}else await u(o,d)}catch(e){throw Xt(`startTestSession failed: ${e}`),e}},testSessionLog:async(e,{testSessionJobId:t,log:s})=>{try{await e.db.mutation.createTestSessionJobLog({data:{log:s,testSessionJob:{connect:{id:t}}}},"{ id }")}catch(e){throw Xt(`testSessionJobCompleted failed: ${e}`),e}},testSessionProgress:async(e,{testSessionId:t,testSessionJobId:s,batchNum:a,progress:r,...n})=>{try{const{count:r}=await e.db.mutation.updateManyTestSessions({data:{status:"RUNNING"},where:{id:t,status:"PENDING"}});r>0&&Xt(`Test Session Job ${s}/#${a} set Test Session ${t} RUNNING.`)}catch(e){throw Xt(`Test Session Job ${s}/#${a} set Test Session ${t} RUNNING failed: ${e}`),e}try{const{count:n}=await e.db.mutation.updateManyTestSessionJobs({data:{status:"RUNNING",started:new Date(Date.now()).toISOString(),progressPercent:x.isNumber(r)&&r},where:{id:s,status:"PENDING"}});n>0&&Xt(`Test Session Job ${s}/#${a} set Test Session ${t} Job RUNNING.`)}catch(e){throw Xt(`Test Session Job ${s}/#${a} set Test Session ${t} Job RUNNING failed: ${e}`),e}if(x.isNumber(r))try{const{count:t}=await e.db.mutation.updateManyTestSessionJobs({data:{progressPercent:r},where:{id:s,progressPercent_lt:r}});t>0&&Xt(`Test Session Job ${s}/#${a} set Test Session Job progressPercent ${r}.`)}catch(e){throw Xt(`Test Session Job ${s}/#${a} set Test Session Job progressPercent ${r} failed: ${e}`),e}if(n.testcase){const r={testcaseName:n.testcase,testcaseSource:n.source,success:n.success,err:n.err,testSession:{connect:{id:t}}};n.transcript&&(n.transcript.convoBegin&&n.transcript.convoEnd&&(r.duration=_(n.transcript.convoEnd).diff(n.transcript.convoBegin)),n.transcript.steps&&(r.steps={create:n.transcript.steps.map((e,t)=>({step:t,sender:e.expected&&e.expected.sender,expected:x.isString(e.expected)?e.expected:JSON.stringify(e.expected),not:!!e.not,actual:x.isString(e.actual)?e.actual:JSON.stringify(e.actual),stepDuration:e.stepBegin&&e.stepEnd&&_(e.stepEnd).diff(e.stepBegin),botDuration:e.botBegin&&e.botEnd&&_(e.botEnd).diff(e.botBegin),err:e.err}))})),n.sourceTag&&(n.sourceTag.filename&&(r.testSetFilename=n.sourceTag.filename),n.sourceTag.testSetId&&(r.testSet={connect:{id:n.sourceTag.testSetId}}),n.sourceTag.testSetScriptId&&(r.testSetScript={connect:{id:n.sourceTag.testSetScriptId}}),n.sourceTag.testSetRepositoryId&&(r.testSetRepository={connect:{id:n.sourceTag.testSetRepositoryId}}),n.sourceTag.testSetFolderId&&(r.testSetFolder={connect:{id:n.sourceTag.testSetFolderId}}),n.sourceTag.testSetExcelId&&(r.testSetExcel={connect:{id:n.sourceTag.testSetExcelId}}),n.sourceTag.deviceSetId&&(r.deviceSet={connect:{id:n.sourceTag.deviceSetId}}),n.sourceTag.deviceName&&(r.deviceName=n.sourceTag.deviceName)),n.attachments&&(r.attachments={create:n.attachments.map(e=>({name:e.name,mimeType:e.mimeType,base64:e.base64}))});try{const o=await e.db.mutation.createTestSessionTestCaseResult({data:r},"{ id }");Xt(`TestResult for TestCase "${n.testcase}" in TestSession "${t}" registered (jobId: ${s}/#${a} id: ${o.id})`)}catch(e){throw Xt(`TestResult for TestCase "${n.testcase}" in TestSession "${t}" registration failed (jobId: ${s}/#${a}): ${e}`),e}}Xt(`testSessionProgress - Testsession "${t}", Job ${s}/#${a}, progress ${r}, ready.`),Zt(e,t)},testSessionSetJobCompletedResult:async(e,{testSessionId:t,testSessionJobId:s,result:a})=>{try{Xt(`Test Session Job ${s}/${t} completed: ${JSON.stringify(a)}`),await e.db.mutation.updateTestSessionJob({data:{status:"READY",finished:new Date(Date.now()).toISOString(),progressPercent:100,totalCount:a&&a.totalCount,failedCount:a&&a.failedCount,successCount:a&&a.successCount},where:{id:s}},"{ id }"),await e.db.mutation.createTestSessionJobLog({data:{log:"Job completed",testSessionJob:{connect:{id:s}}}},"{ id }"),Zt(e,t)}catch(e){throw Xt(`testSessionJobCompleted failed: ${e}`),e}},testSessionSetJobFailedErr:async(e,{testSessionId:t,testSessionJobId:s,result:a,err:r})=>{try{Xt(`Test Session Job ${s}/${t} failed: ${r}.`),await e.db.mutation.updateTestSessionJob({data:{status:"FAILED",finished:new Date(Date.now()).toISOString(),progressPercent:100,totalCount:a&&a.totalCount,failedCount:a&&a.failedCount,successCount:a&&a.successCount,err:r},where:{id:s}},"{ id }"),await e.db.mutation.createTestSessionJobLog({data:{log:`Job failed: ${r}`,testSessionJob:{connect:{id:s}}}},"{ id }"),Zt(e,t)}catch(r){throw Xt(`testSessionJobFailed failed: ${r}`),r}},testSessionCheckFinished:async(e,{testSessionId:t,testSessionJobId:s})=>{try{const a=await e.db.query.testSession({where:{id:t}},"{ id name status jobs { status finished failedCount } }");if(!a)return;if(a.jobs&&a.jobs.find(e=>"READY"!==e.status&&"FAILED"!==e.status))return void Xt(`Test Session testSessionCheckFinished ${t}/${s} waiting for other jobs to finish.`);const r=a.jobs&&!!a.jobs.find(e=>"FAILED"===e.status),n=a.jobs&&!!a.jobs.find(e=>e.failedCount>0);r||n?(Xt(`testSessionCheckFinished test session ${t}/${a.name} failed (job failed: ${r}, result failed: ${n})`),await e.db.mutation.updateTestSession({where:{id:t},data:{status:"FAILED"}})):(Xt(`testSessionCheckFinished test session ${t}/${a.name} success`),await e.db.mutation.updateTestSession({where:{id:t},data:{status:"READY"}})),Zt(e,t)}catch(e){throw Xt(`testSessionCheckFinished ${t} failed: ${e}`),e}}};const ts=k("botium-box-server-agents-heartbeat");const ss=k("botium-box-server-agents-registeragent");const as=k("botium-box-server-agents"),{startTestSession:rs,testSessionSetJobCompletedResult:ns,testSessionSetJobFailedErr:os,testSessionLog:is,testSessionProgress:cs,testSessionCheckFinished:ds}=es;const ls=k("botium-box-server-testcasecleanup"),us=async(e,t,s,a)=>{const r=await e.db.query.testSessionTestCaseResults({where:{createdAt_lte:t,success:a,attachments_some:{base64_not:""}}},"{ id attachments { id } }");r.length>0?(ls(`Found ${r.length} screenshots to cleanup for ${s} (older than ${t}`),await e.db.mutation.deleteManyTestSessionTestCaseResultAttachments({where:{id_in:r.reduce((e,t)=>e.concat(t.attachments.map(e=>e.id)),[])}})):ls(`Found no screenshots to cleanup for ${s} (older than ${t}`)},ps=async(e,t,s,a)=>{const r=await e.db.query.testSessionTestCaseResults({where:{createdAt_lte:t,success:a,steps_some:{expected_not:""}}},"{ id steps { id } }");r.length>0?(ls(`Found ${r.length} transcripts to cleanup for ${s} (older than ${t}`),await e.db.mutation.deleteManyTestSessionTestCaseResultTranscripts({where:{id_in:r.reduce((e,t)=>e.concat(t.steps.map(e=>e.id)),[])}})):ls(`Found no transcripts to cleanup for ${s} (older than ${t}`)},hs=async(e,t,s,a)=>{const r=await e.db.query.testSessionTestCaseResults({where:{createdAt_lte:t,success:a,testcaseSource_not:""}},"{ id }");r.length>0?(ls(`Found ${r.length} results to cleanup for ${s} (older than ${t}`),await e.db.mutation.updateManyTestSessionTestCaseResults({data:{testcaseSource:""},where:{id_in:r.map(e=>e.id)}})):ls(`Found no results to cleanup for ${s} (older than ${t}`)},Ss=async(e,t)=>{const s=await e.db.query.systemSettingses();if(isNaN(t)&&(!s||!s[0].cleanupJobIntervalMinutes))return void ls("cleanupJobIntervalMinutes not configured, not scheduling cleanup task.");const a=isNaN(t)?60*s[0].cleanupJobIntervalMinutes*1e3:t;let r=[];try{r=await A.promisify(E.Job.rangeByType)("box.testcasecleanup","delayed",0,10,"")}catch(e){ls(`error checking job states: ${e}`)}if(r&&r.length)for(const e of r)try{await A.promisify(e.remove).bind(e)(),ls(`Removed duplicate Scheduled Test Case Cleanup Job ${e.id}.`)}catch(t){return ls(`Removing Scheduled Test Case Cleanup Job ${e.id} failed: ${t}`),void ls("Skipping cleanup job removal.")}return new Promise(t=>{const s=e.queueConnector.create("box.testcasecleanup",{title:"Scheduled Test Case Cleanup Job"}).removeOnComplete(!0).delay(a).save(e=>{if(e)ls(`Scheduling Test Case Cleanup Job failed: ${e}`);else{const e=s.id;ls(`Scheduled Test Case Cleanup Job ${e}, next run delay: ${a}`)}return t()})})};var ms=async e=>{e.queueConnector.process("box.testcasecleanup",async(t,s)=>{try{await(async e=>{ls("runCleanup started ...");const t=await e.db.query.systemSettingses();if(t&&!isNaN(t[0].keepTestCaseSuccessScreenshotsDays)){const s=_().subtract(t[0].keepTestCaseSuccessScreenshotsDays,"days").startOf("day").toDate();try{await us(e,s,"keepTestCaseSuccessScreenshotsDays",!0)}catch(e){ls(`runCleanupScreenshots keepTestCaseSuccessScreenshotsDays failed: ${e}`)}}if(t&&!isNaN(t[0].keepTestCaseFailedScreenshotsDays)){const s=_().subtract(t[0].keepTestCaseFailedScreenshotsDays,"days").startOf("day").toDate();try{await us(e,s,"keepTestCaseFailedScreenshotsDays",!1)}catch(e){ls(`runCleanupScreenshots keepTestCaseFailedScreenshotsDays failed: ${e}`)}}if(t&&!isNaN(t[0].keepTestCaseSuccessConversationDays)){const s=_().subtract(t[0].keepTestCaseSuccessConversationDays,"days").startOf("day").toDate();try{await ps(e,s,"keepTestCaseSuccessConversationDays",!0)}catch(e){ls(`runCleanupTranscripts keepTestCaseSuccessConversationDays failed: ${e}`)}try{await hs(e,s,"keepTestCaseSuccessConversationDays",!0)}catch(e){ls(`runCleanupDetails keepTestCaseSuccessConversationDays failed: ${e}`)}}if(t&&!isNaN(t[0].keepTestCaseFailedConversationDays)){const s=_().subtract(t[0].keepTestCaseFailedConversationDays,"days").startOf("day").toDate();try{await ps(e,s,"keepTestCaseFailedConversationDays",!1)}catch(e){ls(`runCleanupTranscripts keepTestCaseFailedConversationDays failed: ${e}`)}try{await hs(e,s,"keepTestCaseFailedConversationDays",!1)}catch(e){ls(`runCleanupDetails keepTestCaseFailedConversationDays failed: ${e}`)}}})(e),ls("Test Case Cleanup ready."),s(),await Ss(e)}catch(t){ls(`Test Case Cleanup failed: ${t}`),s(),await Ss(e)}}),await Ss(e,0)};const fs=e=>({id:e}),Ts=e=>e&&e.id;var bs={jwtSettings:()=>({secret:process.env.JWT_SECRET,audience:process.env.JWT_AUDIENCE||"botiumbox",issuer:process.env.JWT_ISSUER||"botiumbox"}),userIdToToken:fs,tokenToUserId:Ts,generateToken:e=>m.sign(fs(e.id),process.env.JWT_SECRET,{expiresIn:86400*(process.env.JWT_EXPIRY_DAYS||30),audience:process.env.JWT_AUDIENCE||"botiumbox",issuer:process.env.JWT_ISSUER||"botiumbox",subject:e.id.toString()}),validateToken:async(e,t)=>{const s=m.verify(e,process.env.JWT_SECRET,{audience:process.env.JWT_AUDIENCE||"botiumbox",issuer:process.env.JWT_ISSUER||"botiumbox"});return await t.query.user({where:{id:Ts(s)}},"{ id name email roles { id name permissions } clients { id name } }")}};const{generateToken:ys}=bs;var gs={me:async(e,t,s,a)=>s.request&&s.request.user,async autologin(e,t,s,a){if(s.request&&s.request.user)return{user:s.request.user,token:ys(s.request.user)}}},Es={agents:(e,{where:t,orderBy:s,skip:a,first:r},n,o)=>(s=s||"name_ASC",n.db.query.agents({where:t,orderBy:s,skip:a,first:r},o)),agent:(e,{id:t},s,a)=>s.db.query.agent({where:{id:t}},a)};const ws=k("botium-box-server-resolvers-chatbots");var Cs={chatbots:(e,{where:t,orderBy:s,skip:a,first:r},n,o)=>(s=s||"name_ASC",n.db.query.chatbots({where:t,orderBy:s,skip:a,first:r},o)),chatbot:(e,{id:t},s,a)=>s.db.query.chatbot({where:{id:t}},a),availablewatsonworkspaces:(e,{url:t,version:s,apikey:a,username:r,password:n})=>new Promise((e,o)=>{const i={url:t,version:s};a?Object.assign(i,{iam_apikey:a}):Object.assign(i,{username:r,password:n}),ws(`listWorkspaces for watson assistant: ${JSON.stringify(i)}`),new f(i).listWorkspaces((t,s)=>{if(t)o(t);else{const t=s.workspaces.map(e=>({name:e.name,description:e.description,value:e.workspace_id}));e(t)}})})};const vs=(e,t)=>{if(!e)return!1;if(!e.roles)return!1;if("admin"!==e.name&&process&&process.env&&process.env.BOTIUMBOX_DISABLE_PERMISSIONS&&process.env.BOTIUMBOX_DISABLE_PERMISSIONS.indexOf(t)>=0)return!1;for(const s of e.roles)if(s.permissions)for(const e of s.permissions)if(e.endsWith("*")){if(t.startsWith(e.substr(0,e.length-1)))return!0}else if(e.startsWith("*")){if(t.endsWith(e.substr(1)))return!0}else if(e===t)return!0;return!1};var Is={permissionTypes:{AGENTS_SELECT:"AGENTS_SELECT",AGENTS_CREATE:"AGENTS_CREATE",AGENTS_UPDATE:"AGENTS_UPDATE",AGENTS_DELETE:"AGENTS_DELETE",CHATBOTS_SELECT:"CHATBOTS_SELECT",CHATBOTS_CREATE:"CHATBOTS_CREATE",CHATBOTS_UPDATE:"CHATBOTS_UPDATE",CHATBOTS_DELETE:"CHATBOTS_DELETE",CHATBOTS_LIVECHAT:"CHATBOTS_LIVECHAT",DEVICESETS_SELECT:"DEVICESETS_SELECT",DEVICESETS_CREATE:"DEVICESETS_CREATE",DEVICESETS_UPDATE:"DEVICESETS_UPDATE",DEVICESETS_DELETE:"DEVICESETS_DELETE",TESTPROJECTS_SELECT:"TESTPROJECTS_SELECT",TESTPROJECTS_CREATE:"TESTPROJECTS_CREATE",TESTPROJECTS_UPDATE:"TESTPROJECTS_UPDATE",TESTPROJECTS_DELETE:"TESTPROJECTS_DELETE",TESTSETS_SELECT:"TESTSETS_SELECT",TESTSETS_CREATE:"TESTSETS_CREATE",TESTSETS_UPDATE:"TESTSETS_UPDATE",TESTSETS_DELETE:"TESTSETS_DELETE",TESTSESSIONS_SELECT:"TESTSESSIONS_SELECT",TESTSESSIONS_CREATE:"TESTSESSIONS_CREATE",TESTSESSIONS_DELETE:"TESTSESSIONS_DELETE",TESTSESSIONS_REPORTS:"TESTSESSIONS_REPORTS",APIKEYS_SELECT:"APIKEYS_SELECT",APIKEYS_MANAGE:"APIKEYS_MANAGE",DEVICEPROVIDERS_SELECT:"DEVICEPROVIDERS_SELECT",DEVICEPROVIDERS_MANAGE:"DEVICEPROVIDERS_MANAGE",REGISTEREDCOMPONENTS_SELECT:"REGISTEREDCOMPONENTS_SELECT",REGISTEREDCOMPONENTS_MANAGE:"REGISTEREDCOMPONENTS_MANAGE",USERS_MANAGE:"USERS_MANAGE",SYSTEMSETTINGS_MANAGE:"SYSTEMSETTINGS_MANAGE"},hasPermission:vs,hasAnyPermission:(e,t)=>{for(const s of t)if(vs(e,s))return!0;return!1},hasAllPermissions:(e,t)=>{for(const s of t)if(!vs(e,s))return!1;return!0}};var Os={isLoggedIn:e=>{const t=(e=>x.get(e,"request.user"))(e),s=(e=>x.get(e,"request.apiKey"))(e),a=(e=>x.get(e,"connection.context.user"))(e);if(!t&&!s&&!a)throw new Error("Not logged in");return t||s||a},getClientIdFilter:e=>{return null},withClientConnect:(e,t,s)=>{if(s&&!e.client&&(e.client={connect:{id:s}}),e.client&&e.client.connect&&e.client.connect.id){if(!t)throw new Error("Unauthorized, missing client access");if(!t.find(t=>t.id===e.client.connect.id))throw new Error("Unauthorized, missing client access")}return e},withClientFilter:(e,t,s)=>{return{AND:[e||{}]}},assertClient:(e,t)=>{if(e&&(!t||!t.find(t=>t.id===e)))throw new Error("Unauthorized, missing client access")}};const As=k("botium-box-server-livechat"),{hasPermission:Rs}=Is,{isLoggedIn:Ps,getClientIdFilter:$s,withClientConnect:Ns}=Os,{startBot:Ds,sendToBot:_s,stopBot:xs,getConversation:ks,getConversationScript:Bs}=Mt,{composeBotiumCapabilities:qs,combineBotiumCapabilities:js,getServerDefaultCapabilities:Ls}=Vt,Us=async(e,t,s)=>{const a=await t.query.chatbot({where:{id:e}},"{ id name capabilities { name type stringValue intValue booleanValue jsonValue } }");return js(qs(a.capabilities),Ls({queueSettings:s}))};var Fs={liveChatConvoStepAdded:{subscribe:(e,{conversationId:t},{pubsub:s})=>s.asyncIterator(t)}},Ms={async liveChatConvoSteps(e,{conversationId:t},s){try{return ks({conversationId:t},s)}catch(e){throw As(e),new Error(`Conversation ${t} not available.`)}}},Js={async liveChatStartBot(e,{chatbotId:t},{db:s,pubsub:a,queueSettings:r}){const n=await Us(t,s,r);return await Ds({caps:n},{pubsub:a,queueSettings:r})},liveChatSendToBot:async(e,{conversationId:t,convoStep:s},{queueSettings:a})=>(await _s({conversationId:t,convoStep:JSON.parse(s)},{queueSettings:a}),!0),liveChatStopBot:async(e,{conversationId:t},{queueSettings:s})=>(await xs({conversationId:t},{queueSettings:s}),!0),async liveChatSaveConvoSteps(e,{chatbotId:t,conversationId:s,testSetId:a,newTestSetName:r,testCaseName:n},o){const i=Ps(o),c=await Us(t,o.db,o.queueSettings);let d=null;if(r){if(!Rs(i,"TESTSETS_CREATE"))throw new Error("Missing permission TESTSETS_CREATE");d=await o.db.mutation.createTestSet({data:Ns({name:r},i.clients,$s(o))},"{ id name }")}else d=await o.db.query.testSet({where:{id:a}},"{ id name }");As(`liveChatSaveConvoSteps(${s}) saving test case for test set ${d.id}/${d.name}`);const l=await Bs({caps:c,conversationId:s,testCaseName:n},o);let u=await o.db.mutation.createTestSetScript({data:{name:n,script:l,scriptType:"SCRIPTING_TYPE_CONVO",testSet:{connect:{id:d.id}}}},"{ id name }");return As(`liveChatSaveConvoSteps(${s}) saved test case for test set ${d.id}/${d.name} - ${u.id}/${u.name}`),u.id}},Gs={testsessions:(e,{where:t,orderBy:s,skip:a,first:r},n,o)=>(s=s||"createdAt_DESC",a=isNaN(a)?0:a,r=isNaN(r)?100:r,n.db.query.testSessions({where:t,orderBy:s,skip:a,first:r},o)),testsession:(e,{id:t},s,a)=>s.db.query.testSession({where:{id:t}},a),testsessiontestcaseresult:(e,{id:t},s,a)=>s.db.query.testSessionTestCaseResult({where:{id:t}},a),testsessionjoblogs:(e,{jobId:t,orderBy:s,skip:a,first:r},n,o)=>n.db.query.testSessionJobLogs({where:{testSessionJob:{id:t}},orderBy:s,skip:a,first:r},o)},Vs={testsets:(e,{where:t,orderBy:s,skip:a,first:r},n,o)=>(s=s||"name_ASC",n.db.query.testSets({where:t,orderBy:s,skip:a,first:r},o)),testset:(e,{id:t},s,a)=>s.db.query.testSet({where:{id:t}},a),testsetscripts:(e,{testSetId:t,skip:s,first:a},r,n)=>r.db.query.testSetScripts({where:{testSet:{id:t}},skip:s,first:a},n),testsetscript:(e,{id:t},s,a)=>s.db.query.testSetScript({where:{id:t}},a),validatetestsetscript(e,{script:t,scriptType:s}){const a=new T({AddConvos:()=>{},AddPartialConvos:()=>{},AddUtterances:()=>{},IsAsserterValid:()=>!0,IsUserInputValid:()=>!0,scriptingEvents:{}},{SCRIPTING_TXT_EOL:"\n"}).Compile(t,s);return a&&a.length>0?"SCRIPTING_TYPE_UTTERANCES"===s?Promise.resolve({name:a[0].name,description:"Utterances",script:t,scriptType:s}):Promise.resolve({name:a[0].header.name,description:a[0].header.description,script:t,scriptType:s}):Promise.reject(new Error("no script provided"))},testsetrepositories:(e,{testSetId:t,skip:s,first:a},r,n)=>r.db.query.testSetRepositories({where:{testSet:{id:t}},skip:s,first:a},n),testsetrepository:(e,{id:t},s,a)=>s.db.query.testSetRepository({where:{id:t}},a),testsetfolders:(e,{testSetId:t,skip:s,first:a},r,n)=>r.db.query.testSetFolders({where:{testSet:{id:t}},skip:s,first:a},n),testsetfolder:(e,{id:t},s,a)=>s.db.query.testSetFolder({where:{id:t}},a),testsetexcels:(e,{testSetId:t,skip:s,first:a},r,n)=>r.db.query.testSetExcels({where:{testSet:{id:t}},skip:s,first:a},n),testsetexcel:(e,{id:t},s,a)=>s.db.query.testSetExcel({where:{id:t}},a),clonetestsetoptions:(e,t,s,a)=>Et.possibleOptions};const Hs=new W(3600);var zs={devicesets:(e,{where:t,orderBy:s,skip:a,first:r},n,o)=>(s=s||"name_ASC",n.db.query.deviceSets({where:t,orderBy:s,skip:a,first:r},o)),deviceset:(e,{id:t},s,a)=>s.db.query.deviceSet({where:{id:t}},a),async availabledevices(e,{provider:t},s){const a=await s.db.query.deviceProvider({where:{id:t}});return a?"SAUCELABS"===a.type?Hs.get("SAUCELABS",()=>N({url:"https://saucelabs.com/rest/v1/info/platforms/all",json:!0}).then(e=>{const t=e.filter(e=>!e.device).map(e=>({name:`${e.long_name} ${e.short_version}, ${e.os}`,value:JSON.stringify({type:"DESKTOP",capabilities:{browserName:e.api_name,platform:e.os,version:e.short_version}})})).concat(e.filter(e=>e.device).map(e=>({name:`${e.long_name}, ${e.short_version}`,value:JSON.stringify({type:"MOBILEBROWSER",capabilities:{browserName:["iphone","ipad"].indexOf(e.api_name)>=0?"Safari":"Chrome",deviceName:e.device,platformName:["iphone","ipad"].indexOf(e.api_name)>=0?"iOS":"Android",platformVersion:e.short_version}})})));return x.uniqBy(x.orderBy(t,"name","asc"),"name")})):"TESTOBJECTS"===a.type?a.username&&a.password?Hs.get("TESTOBJECTS_"+a.url,()=>N({url:"https://app.testobject.com/api/rest/v2/devices",json:!0}).auth(a.username,a.password).then(e=>{const t=e[a.url.includes("eu1")?"EU":"US"].map(e=>({name:`${e.name}, ${e.os}, ${e.osVersion}`,value:JSON.stringify({type:"MOBILEAPP",capabilities:{deviceName:e.name,platformName:e.os,platformVersion:e.osVersion}})}));return x.uniqBy(x.orderBy(t,"name","asc"),"name")})):[]:"LOCALSELENIUM"===a.type?Hs.get("LOCALSELENIUM",()=>Promise.resolve([{name:"PhantomJS Virtual Browser",value:JSON.stringify({type:"DESKTOP",capabilities:{browserName:"phantomjs"}})},{name:"Generic Browser (manually set capabilities)",value:JSON.stringify({type:"DESKTOP",capabilities:{}})},{name:"Google Chrome (Headless)",value:JSON.stringify({type:"DESKTOP",capabilities:{browserName:"chrome",chromeOptions:{args:["--headless","--disable-gpu"]}}})}])):"INTEGRATED"===a.type?Promise.resolve([{name:"PhantomJS Virtual Browser",value:JSON.stringify({type:"DESKTOP",capabilities:{browserName:"phantomjs"}})}]):void 0:[]}},Ws={testprojects:(e,{where:t,orderBy:s,skip:a,first:r},n,o)=>(s=s||"name_ASC",n.db.query.testProjects({where:t,orderBy:s,skip:a,first:r},o)),testproject:(e,{id:t},s,a)=>s.db.query.testProject({where:{id:t}},a)},Xs={users:(e,{where:t,orderBy:s,skip:a,first:r},n,o)=>(s=s||"name_ASC",n.db.query.users({where:t,orderBy:s,skip:a,first:r},o)),user:(e,{id:t},s,a)=>s.db.query.user({where:{id:t}},a),userroles:(e,{where:t,orderBy:s,skip:a,first:r},n,o)=>(s=s||"name_ASC",n.db.query.userRoles({where:t,orderBy:s,skip:a,first:r},o)),clients:(e,{where:t,orderBy:s,skip:a,first:r},n,o)=>(s=s||"name_ASC",n.db.query.clients({where:t,orderBy:s,skip:a,first:r},o)),apikeys:(e,{where:t,orderBy:s,skip:a,first:r},n,o)=>(s=s||"name_ASC",n.db.query.apiKeys({where:t,orderBy:s,skip:a,first:r},o)),apikey:(e,{id:t},s,a)=>s.db.query.apiKey({where:{id:t}},a),deviceproviders:(e,{where:t,orderBy:s,skip:a,first:r},n,o)=>(s=s||"name_ASC",n.db.query.deviceProviders({where:t,orderBy:s,skip:a,first:r},o).then(e=>(e&&e.forEach(e=>{delete e.password}),e))),deviceprovider:(e,{id:t},s,a)=>s.db.query.deviceProvider({where:{id:t}},a).then(e=>(e&&delete e.password,e)),registeredcomponents:(e,{where:t,orderBy:s,skip:a,first:r},n,o)=>(s=s||"name_ASC",n.db.query.registeredComponents({where:t,orderBy:s,skip:a,first:r},o)),registeredcomponent:(e,{id:t},s,a)=>s.db.query.registeredComponent({where:{id:t}},a),systemsettings:(e,t,s,a)=>s.db.query.systemSettingses({skip:0,first:1},a).then(e=>e&&e.length&&e[0]),availableconnectors(e,t,s,a){const r=[{name:"echo",description:"Botium Sample Chatbot (Echo)"},{name:"watson",description:"IBM Watson Assistant API"},{name:"directline3",description:"Microsoft Bot Framework (Directline 3)"},{name:"dialogflow",description:"Google Dialogflow"},{name:"koreai-webhook",description:"Kore.ai"},{name:"fbpagereceiver",description:"Facebook Messenger Bots"},{name:"botkit",description:"Botkit Anywhere"},{name:"botpress",description:"Botpress.io"},{name:"simplerest",description:"Generic HTTP/JSON Interface"},{name:"lex",description:"Amazon Lex"},{name:"alexa-avs",description:"Alexa Voice Service"},{name:"alexa-smapi",description:"Alexa Skill Management API"},{name:"luis",description:"Microsoft LUIS"},{name:"google-assistant",description:"Google Assistant"},{name:"wechat",description:"Wechat Webhook"},{name:"webdriverio",description:"WebdriverIO (Selenium or Appium)"}],n=[{name:"docker",description:"Dockerize Facebook/Slack/Botkit Chatbot"},{name:"fbdirect",description:"Connect Live Facebook Chatbot"},{name:"webspeech",description:"Webspeech (Talk/Listen)"}];if(process.env.BOTIUMBOX_DISABLE_CONNECTORS){process.env.BOTIUMBOX_DISABLE_CONNECTORS.split(",").forEach(e=>r.findIndex(t=>t.name===e)>=0&&r.splice(r.findIndex(t=>t.name===e),1))}if(process.env.BOTIUMBOX_ENABLE_CONNECTORS){process.env.BOTIUMBOX_ENABLE_CONNECTORS.split(",").forEach(e=>{r.findIndex(t=>t.name===e)>=0||(n.findIndex(t=>t.name===e)>=0?r.push(n.find(t=>t.name===e)):r.push({name:e,value:e,description:e}))})}return r.forEach(e=>{e.value=e.name}),x.sortBy(r,"description")}};const Ks=k("botium-box-server-charts-query"),{updateChartCacheForTestSession:Ys}=zt,{isLoggedIn:Qs,getClientIdFilter:Zs,withClientFilter:ea}=Os,ta=e=>"TODAY"===e?_().utc().startOf("day"):"LASTWEEK"===e?_().utc().subtract(6,"days").startOf("day"):"LAST2WEEKS"===e?_().utc().subtract(13,"days").startOf("day"):"LASTMONTH"===e?_().utc().subtract(30,"days").startOf("day"):"LAST2MONTHS"===e?_().utc().subtract(60,"days").startOf("day"):void 0,sa=e=>_().utc().endOf("day"),aa=(e,t)=>{let s=Promise.resolve();return t&&t.forEach(t=>{s=s.then(()=>{if(!t.chartData)return Ys(null,{testSessionId:t.id},e).then(e=>{t.chartData=e});t.chartData=JSON.parse(t.chartData)})}),s};var ra={chartFailedCountByTestSetByDay(e,{testProjectId:t,timeFrame:s},a,r){const n=Qs(a),o=ta(s||"LAST2WEEKS"),i=sa();Ks(`called chartFailedCountByTestSetByDay ${o} - ${i}`);const c=`chartFailedCountByTestSetByDay_${JSON.stringify({fromDate:o,testProjectId:t,clientId:Zs(a)})}`;return a.chartsCache.get(c,()=>{const e=ea({status_in:["READY","FAILED"],createdAt_gte:_(o).toDate(),createdAt_lte:_(i).toDate(),jobs_every:{status:"READY"}},n.clients,Zs(a));return t&&(e.testProject={id:t}),a.db.query.testSessions({where:e},"{ id createdAt testSets { id name } chartData }").then(e=>aa(a,e).then(()=>e)).then(e=>{if(!e)return;const t=e.filter(e=>e.chartData).reduce((e,t)=>e.concat(t.testSets.map(e=>({testSet:e,createdAt:t.createdAt,chartData:t.chartData.countByTestSetId[e.id]}))),[]).filter(e=>e.chartData),s=x.groupBy(t,e=>e.testSet.id),a={};Object.keys(s).forEach(e=>{a[e]=s[e][0].testSet.name,s[e]=x.groupBy(s[e],e=>_.utc(e.createdAt).startOf("day")),Object.keys(s[e]).forEach(t=>{const a=s[e][t];s[e][t]=Math.ceil(a.reduce((e,t)=>e+t.chartData.failedCount,0)/a.length)})});const r=[];for(const e=_(o);e.isBefore(i);e.add(1,"days"))r.push(_(e));const n=Object.keys(s).map(e=>({id:e,name:a[e],data:r.map(t=>s[e][t])}));return x.sortBy(n,"name")})})},chartFailedCountByChatbotByDay(e,{timeFrame:t},s,a){const r=Qs(s),n=ta(t||"LAST2WEEKS"),o=sa();Ks(`called chartFailedCountByChatbotByDay ${n} - ${o}`);const i=`chartFailedCountByChatbotByDay_${JSON.stringify({fromDate:n,clientId:Zs(s)})}`;return s.chartsCache.get(i,()=>s.db.query.testSessions(ea({where:{status_in:["READY","FAILED"],createdAt_gte:_(n).toDate(),createdAt_lte:_(o).toDate(),jobs_every:{status:"READY"}}},r.clients,Zs(s)),"{ id createdAt chatbot { id name } chartData }").then(e=>aa(s,e).then(()=>e)).then(e=>{if(!e)return;const t=x.groupBy(e,e=>e.chatbot.id),s={};Object.keys(t).forEach(e=>{s[e]=t[e][0].chatbot.name,t[e]=x.groupBy(t[e],e=>_.utc(e.createdAt).startOf("day")),Object.keys(t[e]).forEach(s=>{const a=t[e][s];t[e][s]=Math.ceil(a.reduce((e,t)=>e+t.chartData.failedCount,0)/a.length)})});const a=[];for(const e=_(n);e.isBefore(o);e.add(1,"days"))a.push(_(e));const r=Object.keys(t).map(e=>({id:e,name:s[e],data:a.map(s=>t[e][s])}));return x.sortBy(r,"name")}).then(e=>e.filter(e=>e.data&&e.data.filter(e=>!isNaN(e)).length>0)))},chartTestSetResultCount(e,{testProjectId:t},s,a){const r=Qs(s),n=`chartTestSetResultCount_${JSON.stringify({testProjectId:t,clientId:Zs(s)})}`;return s.chartsCache.get(n,()=>s.db.query.testSets({orderBy:"name_ASC"},"{ id name }").then(e=>Promise.all(e.map(e=>{const a=ea({status_in:["READY","FAILED"],testSets_some:{id:e.id},jobs_every:{status:"READY"}},r.clients,Zs(s));return t&&(a.testProject={id:t}),s.db.query.testSessions({where:a,orderBy:"createdAt_DESC",skip:0,first:2},"{ id createdAt chartData }").then(e=>aa(s,e).then(()=>e)).then(t=>{const s={id:e.id,name:e.name,testCaseLastTotalCount:0,testCaseLastSuccessCount:0,testCaseLastSuccessRate:0,testCasePreviousTotalCount:0,testCasePreviousSuccessCount:0,testCasePreviousSuccessRate:0,testCaseTrend:"UNKNOWN"};if(t&&t.length>0){const a=t[0].chartData.countByTestSetId[e.id];s.lastRun=t[0].createdAt,s.lastTestSessionId=t[0].id,s.testCaseLastTotalCount=a?a.totalCount:0,s.testCaseLastSuccessCount=a?a.successCount:0,s.testCaseLastSuccessRate=s.testCaseLastTotalCount===s.testCaseLastSuccessCount?100:s.testCaseLastSuccessCount/s.testCaseLastTotalCount*100}if(t&&t.length>1){const a=t[1].chartData.countByTestSetId[e.id];s.previousRun=t[1].createdAt,s.previousTestSessionId=t[1].id,s.testCasePreviousTotalCount=a?a.totalCount:0,s.testCasePreviousSuccessCount=a?a.successCount:0,s.testCasePreviousSuccessRate=s.testCasePreviousTotalCount===s.testCasePreviousSuccessCount?100:s.testCasePreviousSuccessCount/s.testCasePreviousTotalCount*100,s.testCaseLastSuccessRate>s.testCasePreviousSuccessRate?s.testCaseTrend="GOOD":s.testCaseLastSuccessRate<s.testCasePreviousSuccessRate?s.testCaseTrend="BAD":s.testCaseTrend="CONSTANT"}return s})}))).then(e=>{const t=e.filter(e=>e.testCaseLastTotalCount>0);return x.orderBy(t,"lastRun","desc")}))},chartTestProjectTrainingStatusByTestSet(e,{testProjectId:t},s,a){const r=Qs(s),n=`chartTestProjectTrainingStatusByTestSet_${JSON.stringify({testProjectId:t,clientId:Zs(s)})}`;return s.chartsCache.get(n,async()=>{const e=ea({status_in:["READY","FAILED"],testProject:{id:t},jobs_every:{status:"READY"}},r.clients,Zs(s)),a=await s.db.query.testSessions({where:e,orderBy:"createdAt_DESC",skip:0,first:1},"{ id createdAt testSets { id name } chartData }");return a&&0!==a.length?(await aa(s,a),a[0].testSets.forEach(e=>{const t=a[0].chartData.countByTestSetId[e.id];e.totalCount=t?t.totalCount:0,e.successCount=t?t.successCount:0,e.failedCount=t?t.failedCount:0}),x.sortBy(a[0].testSets,"name")):[]})},chartTestProjectTrainingStatusByDeviceSet(e,{testProjectId:t},s,a){const r=Qs(s),n=`chartTestProjectTrainingStatusByDeviceSet_${JSON.stringify({testProjectId:t,clientId:Zs(s)})}`;return s.chartsCache.get(n,async()=>{const e=ea({status_in:["READY","FAILED"],testProject:{id:t},jobs_every:{status:"READY"}},r.clients,Zs(s)),a=await s.db.query.testSessions({where:e,orderBy:"createdAt_DESC",skip:0,first:1},"{ id createdAt deviceSets { id name } chartData }");if(!a||0===a.length)return[];await aa(s,a);const n=a[0].deviceSets||[];n.forEach(e=>{const t=a[0].chartData.countByDeviceSetId[e.id];e.totalCount=t?t.totalCount:0,e.successCount=t?t.successCount:0,e.failedCount=t?t.failedCount:0});const o=a[0].chartData.countByDeviceSetId.NULL;return o&&n.push({id:"",name:"No Device Set",totalCount:o.totalCount,successCount:o.successCount,failedCount:o.failedCount}),x.sortBy(n,"name")})}};const na=y.Strategy,{generateToken:oa}=(k("botium-box-server-passport"),bs);var ia={loadStrategy:async e=>{const t=e();b.use(new na(async(e,s,a)=>{try{const r={OR:[{name:e},{email:e}]},n=await t.db.query.users({where:r},"{ id name password email roles { id name permissions } clients { id name } }");if(!n||0===n.length)return a(null,!1,{message:`No such user found: ${e}`});const o=n[0];return o.password&&await C.compare(s,o.password)?(delete o.password,a(null,o)):a(null,!1,{message:"Invalid password."})}catch(e){return a(e)}}))},authenticate:(e,t)=>new Promise((s,a)=>{b.authenticate(t||"local",(e,t,r)=>e?a(e):t?void s({token:oa(t),user:t}):a(new Error(r.message)))(e.request,e.response,()=>{})})};const{authenticate:ca}=ia;var da={login:async(e,{name:t,email:s,password:a},r,n)=>(r.request.body={username:t||s,password:a},"admin"===t?ca(r,"local"):ca(r))},la={async createAgent(e,{agent:t},s,a){},async updateAgent(e,{id:t,agent:s},a,r){if(!await a.db.exists.Agent({id:t}))throw new Error(`Agent not found ${t}`);return a.db.mutation.updateAgent({where:{id:t},data:s},r)},async deleteAgent(e,{id:t},s){}},ua={createChatbot:async(e,{chatbot:t},s,a)=>s.db.mutation.createChatbot({data:t},a),async updateChatbot(e,{id:t,chatbot:s},a,r){if(!await a.db.exists.Chatbot({id:t}))throw new Error(`Chatbot not found ${t}`);return a.db.mutation.updateChatbot({where:{id:t},data:s},r)},deleteChatbot:async(e,{id:t},s)=>(await s.db.mutation.deleteChatbot({where:{id:t}},"{id}"),!0)};const pa=k("botium-box-server-mutation-testsession");var ha={createTestSession:async(e,{testSession:t},s,a)=>s.db.mutation.createTestSession({data:t},a).then(e=>new Promise((a,r)=>{s.queueConnector.create("box.createprocessingjobs",{title:`Job Creation Job for Test Session ${t.name}`,testSessionId:e.id}).removeOnComplete(!0).save(t=>{if(t)return r(t);a(e)})})),deleteTestSession:async(e,{id:t},s)=>new Promise((e,a)=>{s.db.mutation.deleteManyTestSessionJobLogs({where:{testSessionJob:{testSession:{id:t}}}}).then(()=>s.db.mutation.deleteManyTestSessionJobs({where:{testSession:{id:t}}})).then(()=>s.db.mutation.deleteManyTestSessionTestCaseResults({where:{testSession:{id:t}}})).then(()=>s.db.mutation.deleteTestSession({where:{id:t}},"{id}")).then(()=>e(!0)).catch(e=>(pa(`Error deleting test session ${t}: ${e}`),a(e)))}),async cancelTestSession(e,{id:t},s){const a=await s.db.query.testSession({where:{id:t}},"{ id name jobs { jobId } }");return!!a&&(a.jobs.filter(e=>e.jobId).forEach(async e=>{E.Job.remove(e.jobId,t=>{pa(t?`cancelTestSession - Failed to remove job ${e.jobId}: ${t}`:`cancelTestSession - removed job ${e.jobId}`)})}),(await s.db.query.agents({where:{}},"{ id name }")).forEach(async e=>{pa(`cancelTestSession - sending cancel test session event ${a.id}/${a.name} to agent ${e.id}/${e.name}`),await s.queueConnector.create(`process.cancel.${e.name}`,{title:`Cancel Test Session Job for Test Session ${a.id}/${a.name}, Agent ${e.name}`,testSessionId:a.id,testSessionName:a.name}).removeOnComplete(!0).save(e=>{if(e)throw e})}),!0)}};const Sa=ha.createTestSession,ma=k("botium-box-server-mutation-testproject"),fa=(e,t,s,a)=>{const r={testSession:Object.assign({},{status:"PENDING",chatbot:{connect:{id:t.chatbot.id}},testSets:{connect:t.testSets&&t.testSets.map(e=>({id:e.id}))},deviceSets:{connect:t.deviceSets&&t.deviceSets.map(e=>({id:e.id}))},registeredComponents:{connect:t.registeredComponents&&t.registeredComponents.map(e=>({id:e.id}))},testProject:{connect:{id:t.id}},batchCount:t.batchCount},s)};return t.client&&(r.testSession.client={connect:{id:t.client.id}}),t.agent&&(r.testSession.agent={connect:{id:t.agent.id}}),Sa(e,r,a,"{ id }")};var Ta={createTestProject:async(e,{testProject:t},s,a)=>s.db.mutation.createTestProject({data:{...t,code:D(t.name)}},a),startTestProject:async(e,{id:t,code:s},a)=>a.db.query.testProject({where:{id:t,code:s}},"{ id name client { id } chatbot { id } testSets { id } deviceSets { id } agent { id } registeredComponents { id } batchCount }").then(r=>{if(!r)throw new Error(`Test Project ${t}/${s} not found`);return fa(e,r,{name:r.name+" - Test Session",tags:{set:["BoxTriggered"]}},a)}).then(e=>e.id),quickstartTestProject:async(e,{testProject:t,startProject:s},a)=>a.db.mutation.createTestProject({data:{...t,code:D(t.name)}},"{ id name client { id } chatbot { id } testSets { id } deviceSets { id } agent { id } registeredComponents { id } batchCount }").then(t=>s?fa(e,t,{name:t.name+" - Initial Test Session",tags:{set:["QuickStart"]}},a).then(e=>e.id):t.id),async updateTestProject(e,{id:t,testProject:s},a,r){if(!await a.db.exists.TestProject({id:t}))throw new Error(`TestProject not found ${t}`);return a.db.mutation.updateTestProject({where:{id:t},data:{...s,code:D(s.name)}},r)},deleteTestProject:async(e,{id:t},s)=>new Promise((e,a)=>{s.db.mutation.deleteTestProject({where:{id:t}},"{id}").then(()=>e(!0)).catch(e=>(ma(`Error deleting TestProject ${t}: ${e}`),a(e)))})};const ba=k("botium-box-server-mutation-settings");let ya=["LOCALSELENIUM"];var ga={createUser:async(e,{user:t},s,a)=>(t.password&&(t.password=await C.hash(t.password,10)),s.db.mutation.createUser({data:t},a)),async updateUser(e,{id:t,user:s},a,r){const n=await a.db.query.user({where:{id:t}});if(!n)throw new Error(`User not found ${t}`);return s.password&&(s.password=await C.hash(s.password,10)),"admin"===n.name&&(s.name="admin",s.roles={connect:[{name:"ADMIN"}]}),a.db.mutation.updateUser({where:{id:t},data:s},r)},async deleteUser(e,{id:t},s){const a=await s.db.query.user({where:{id:t}});if(!a)return!0;if("admin"===a.name)throw new Error('Not allowed to delete user "admin"');return s.db.mutation.deleteUser({where:{id:t}},"{id}").then(()=>!0).catch(e=>{throw ba(`Error deleting User ${t}: ${e}`),e})},createApiKey:async(e,{apiKey:t},s,a)=>(t.key=w("Aa0",20),s.db.mutation.createApiKey({data:t},a)),async updateApiKey(e,{id:t,apiKey:s},a,r){if(!await a.db.exists.ApiKey({id:t}))throw new Error(`ApiKey not found ${t}`);return delete s.key,a.db.mutation.updateApiKey({where:{id:t},data:s},r)},deleteApiKey:async(e,{id:t},s)=>s.db.mutation.deleteApiKey({where:{id:t}},"{id}").then(()=>!0).catch(e=>{throw ba(`Error deleting ApiKey ${t}: ${e}`),e}),async createDeviceProvider(e,{deviceProvider:t},s,a){if("INTEGRATED"===t.type)throw new Error("DeviceProvider type INTEGRATED not allowed to create");if(ya.indexOf(t.type)<0)throw new Error(`DeviceProvider type ${t.type} not supported in this version`);return s.db.mutation.createDeviceProvider({data:t},a)},async updateDeviceProvider(e,{id:t,deviceProvider:s},a,r){if(!await a.db.exists.DeviceProvider({id:t}))throw new Error(`DeviceProvider not found ${t}`);if(ya.indexOf(s.type)<0)throw new Error(`DeviceProvider type ${s.type} not supported in this version`);return a.db.mutation.updateDeviceProvider({where:{id:t},data:s},r)},async deleteDeviceProvider(e,{id:t},s){const a=await s.db.query.deviceProvider({where:{id:t}});if(!a)return!0;if("INTEGRATED"===a.type)throw new Error("DeviceProvider type INTEGRATED not allowed to delete");try{return await s.db.mutation.deleteDeviceProvider({where:{id:t}},"{id}"),!0}catch(e){throw ba(`Error deleting DeviceProvider ${t}: ${e}`),e}},createRegisteredComponent:async(e,{registeredComponent:t},s,a)=>s.db.mutation.createRegisteredComponent({data:t},a),async updateRegisteredComponent(e,{id:t,registeredComponent:s},a,r){if(!await a.db.exists.RegisteredComponent({id:t}))throw new Error(`RegisteredComponent not found ${t}`);return a.db.mutation.updateRegisteredComponent({where:{id:t},data:s},r)},deleteRegisteredComponent:async(e,{id:t},s)=>s.db.mutation.deleteRegisteredComponent({where:{id:t}},"{id}").then(()=>!0).catch(e=>{throw ba(`Error deleting RegisteredComponent ${t}: ${e}`),e}),async updateSystemSettings(e,{systemSettings:t},s,a){const r=await s.db.query.systemSettingses({skip:0,first:1});return r&&r.length>0?s.db.mutation.updateSystemSettings({where:{id:r[0].id},data:t},a):s.db.mutation.createSystemSettings({data:t},a)}};const Ea=k("botium-box-server-mutation-deviceset");var wa={createDeviceSet:async(e,{deviceSet:t},s,a)=>s.db.mutation.createDeviceSet({data:t},a),async updateDeviceSet(e,{id:t,deviceSet:s},a,r){if(!await a.db.exists.DeviceSet({id:t}))throw new Error(`DeviceSet not found ${t}`);return a.db.mutation.updateDeviceSet({where:{id:t},data:s},r)},deleteDeviceSet:async(e,{id:t},s)=>new Promise((e,a)=>{s.db.query.deviceSet({where:{id:t}},"{ id devices { id } }").then(e=>{if(!e)throw new Error(`DeviceSet not found ${t}`);return s.db.mutation.deleteManyDeviceDescriptors({where:{id_in:e.devices.map(e=>e.id)}})}).then(()=>s.db.mutation.deleteDeviceSet({where:{id:t}},"{id}")).then(()=>e(!0)).catch(e=>(Ea(`Error deleting DeviceSet ${t}: ${e}`),a(e)))})};var Ca={};const{withFilter:va}=v;var Ia={testSessionProgress:{resolve:(e,{testSessionId:t},s,a)=>s.db.query.testSession({where:{id:t}},a),subscribe:va((e,{testSessionId:t},{pubsub:s})=>s.asyncIterator("TEST_SESSION_PROGRESS"),(e,{testSessionId:t})=>e&&e.testSessionProgress&&e.testSessionProgress.id===t)}},Oa={Query:{...gs,...Es,...Cs,...Ms,...Gs,...Vs,...zs,...Ws,...Xs,...ra},Mutation:{...da,...la,...ua,...Js,...ha,...Ot,...Ta,...ga,...wa},Subscription:{...Ca,...Fs,...Ia}};const{SchemaDirectiveVisitor:Aa}=I,{defaultFieldResolver:Ra}=O,{hasPermission:Pa,hasAnyPermission:$a}=Is,{isLoggedIn:Na,getClientIdFilter:Da,withClientConnect:_a,withClientFilter:xa,assertClient:ka}=Os,Ba=k("botium-box-server-directives");var qa={hasAnyPermission:class extends Aa{visitFieldDefinition(e){const{resolve:t=Ra}=e,{permissions:s}=this.args;e.resolve=(async(e,a,r,n)=>{const o=Na(r);if($a(o,s))return t.call(this,e,a,r,n);throw Ba(`User ${JSON.stringify(o)} missing any permissions ${s.join("|")}`),new Error(`Unauthorized, missing any permissions ${s.join("|")}`)})}},hasPermission:class extends Aa{visitFieldDefinition(e){const{resolve:t=Ra}=e,{permission:s}=this.args;e.resolve=(async(e,a,r,n)=>{const o=Na(r);if(Pa(o,s))return t.call(this,e,a,r,n);throw Ba(`User ${JSON.stringify(o)} missing permission ${s}`),new Error(`Unauthorized, missing permission ${s}`)})}},clientFilter:class extends Aa{visitFieldDefinition(e){const{resolve:t=Ra}=e;e.resolve=(async(e,{where:s,...a},r,n)=>{const o=Na(r),i=xa(s,o.clients,Da(r));return t.call(this,e,{where:i,...a},r,n)})}},assertClient:class extends Aa{visitFieldDefinition(e){const{resolve:t=Ra}=e,{query:s,argsBase:a,idParam:r,selector:n}=this.args,o=e=>e&&e.client?e.client.id:e&&Object.keys(e).length>0?o(e[Object.keys(e)[0]]):null;e.resolve=(async(e,i,c,d)=>{const l=Na(c),u=x.isArray(s)?s:[s],p=a&&(x.isArray(a)?a:[a]),h=r&&(x.isArray(r)?r:[r]),S=n&&(x.isArray(n)?n:[n]);for(let e in u){const t=p?x.get(i,p[e]):i;if(t)for(const s of x.isArray(t)?t:[t]){const t=x.get(s,h&&h[e]||"id");if(!t)continue;const a=await c.db.query[u[e]]({where:{id:t}},S&&S[e]||"{ client { id } }"),r=o(a);try{ka(r,l.clients)}catch(s){throw Ba(`User ${JSON.stringify(l)} missing client access, query ${u[e]}, id ${t}, clientId ${r}`),s}}}return t.call(this,e,i,c,d)})}},clientConnector:class extends Aa{visitFieldDefinition(e){const{resolve:t=Ra}=e,{dataParam:s}=this.args,a=x.isArray(s)?s:[s];e.resolve=(async(e,s,r,n)=>{const o=Na(r);return a.forEach(e=>{const t=x.get(s,e);if(!t)return;const a=Da(r);for(const e of x.isArray(t)?t:[t])_a(e,o.clients,a)}),t.call(this,e,s,r,n)})}},clientDisconnector:class extends Aa{visitFieldDefinition(e){const{resolve:t=Ra}=e,{dataParam:s}=this.args;e.resolve=(async(e,a,r,n)=>{const o=a[s];return o&&o.client&&delete o.client,t.call(this,e,a,r,n)})}}};const{jwtSettings:ja,tokenToUserId:La}=bs,Ua=k("botium-box-middleware-jwt");let Fa=null;var Ma=(e,t,s)=>{e.use((()=>R(Object.assign({},ja(),{credentialsRequired:!1,getToken:e=>e.headers.authorization&&"Bearer"===e.headers.authorization.split(" ")[0]?e.headers.authorization.split(" ")[1]:e.query&&e.query.token?e.query.token:e.body&&e.body.token?e.body.token:null})))()),e.use((e,t,a)=>(async(e,t,s,a)=>{if(e.user){const t=a({request:e}),r=e.user,n=await t.db.query.user({where:{id:La(r)}},"{ id name email roles { id name permissions } clients { id name } }");return e.user={...n,token:r},s()}if(process.env.JWT_AUTOLOGIN_USERNAME){if(!Fa){const t=a({request:e});Fa=await t.db.query.user({where:{name:process.env.JWT_AUTOLOGIN_USERNAME}},"{ id name email roles { id name permissions } clients { id name } }"),Ua(`Auto login user ${process.env.JWT_AUTOLOGIN_USERNAME}.`)}return e.user={...Fa,token:null},s()}return s()})(e,0,a,s)),e.use((e,t,a)=>(async(e,t,s,a)=>{const r=e.query.APIKEY||e.body&&e.body.APIKEY||e.headers.APIKEY,n=a({request:e});if(!r)return s();Vt.lookupApiKey(n.db,r).then(t=>t?(Ua(`Api Key found - ${A.inspect(t)}`),e.apiKey=t,s()):(Ua(`Api Key not found - ${r}`),s())).catch(e=>(Ua(`Api Key lookup error - ${r} - ${e}`),s()))})(e,0,a,s))};const{setupEndpoints:Ja,verifySignature:Ga}=$,Va=k("botium-box-server-fbproxy");const Ha=k("botium-box-server-endpoints-attachments"),{isLoggedIn:za,assertClient:Wa}=Os;const Xa=k("botium-box-server-endpoints-build"),{isLoggedIn:Ka,assertClient:Ya}=Os,Qa=ha.createTestSession,Za=e=>{if(!e)return"";return e.split("\n").map(e=>e.trim()).join("     ")},er=(e,t)=>e.query[t]||e.query[t.toLowerCase()]||e.body&&e.body[t]||e.body&&e.body[t.toLowerCase()]||e.headers[`X-BOTIUM-${t}`],tr=(e,t)=>{const s=(er(e,"REPORTER")||"json").toLowerCase();return"json"===s||"junit"===s||"csv"===s||"jiracsv"===s||"pdf"===s||(t.sendStatus(404).send("VALID REPORTER OPTIONS: json, junit, csv, jiracsv, pdf"),!1)},sr=(e,t)=>{return e.map(e=>`"${e.map(e=>x.isString(e)&&e.replace(/"/g,'""')).join(`"${t||";"}"`)}"`).join("\r\n")},ar=async(e,t,s,a)=>{try{const r=(er(s,"REPORTER")||"json").toLowerCase();if("json"===r){const{ts:s,output:n}=await nr(e,t,r);a.setHeader("Content-Type","application/json"),a.setHeader("Content-disposition",`attachment; filename="${D(s.name)}.json"`),a.status(200).send(n)}else if("junit"===r){const{ts:s,output:n}=await nr(e,t,r);a.setHeader("Content-Type","text/xml"),a.setHeader("Content-disposition",`attachment; filename="${D(s.name)}.xml"`),a.status(200).send(n)}else if("csv"===r||"jiracsv"===r){const{ts:s,output:n}=await nr(e,t,r);a.setHeader("Content-Type","text/csv"),a.setHeader("Content-disposition",`attachment; filename="${D(s.name)}.csv"`),a.status(200).send(n)}else if("pdf"===r){const{ts:s,output:n}=await nr(e,t,r);a.setHeader("Content-Type","application/pdf"),a.setHeader("Content-disposition",`attachment; filename=${D(s.name)}.pdf`),a.status(200).send(n)}}catch(t){Xa(`Test Session lookup error - ${e} - ${t}`),a.sendStatus(404)}},rr=async(e,t,s,a,r)=>{try{const n=(r||"json").toLowerCase(),o={uri:s,method:a,headers:{}};if("get"!==a.toLowerCase()){const{output:s}=await nr(e,t,n);"json"===n?(o.body=s,o.json=!0):"junit"===n?(o.headers["Content-Type"]="text/xml",o.body=s):"csv"===n||"jiracsv"===n?(o.headers["Content-Type"]="text/csv",o.body=s):"pdf"===n&&(o.headers["Content-Type"]="application/pdf",o.body=s)}await N(o),Xa(`sendTestSessionOutput callbackUrl ${s} ready for test session ${e}`)}catch(t){Xa(`sendTestSessionOutput callbackUrl ${s} failed for test session ${e} - ${t}`)}},nr=async(e,t,s)=>{const a=await Vt.findSimpleTestSessionResults(t.db,e);if(!a)throw new Error(`Test Session ${e} not found`);if("json"===s)return delete a.results,{ts:a,output:a};if("pdf"===s){const s=await Vt.findFullTestSession(t.db,e),r=new q({bufferPages:!0,margins:{top:50,bottom:50,left:72,right:72}});r.reset=(()=>r.font("Helvetica").fontSize(12).fillColor("black")),r.bold=(()=>r.font("Helvetica-Bold")),r.fontSize(25).text(s.name,{underline:!0}).reset(),r.text(`Test Session Started: ${_(s.createdAt).format("lll")}`),r.moveDown(),"READY"===a.status&&r.fillColor("green").fontSize(25).bold().text("TEST SESSION OK").reset(),"FAILED"===a.status&&r.fillColor("red").fontSize(25).bold().text("TEST SESSION FAILED").reset(),r.text(`${a.results.length} Test Case(s)`),r.fillColor("green").text(`${a.results.filter(e=>e.success).length} Test Case(s) succeeded`).reset(),r.fillColor("red").text(`${a.results.filter(e=>!e.success).length} Test Case(s) failed`).reset(),s.testProject&&(r.moveDown(),r.font("Helvetica-Bold").text(`Test Project: ${s.testProject.name}`).reset(),s.testProject.description&&r.text(s.testProject.description),s.testProject.tags&&r.fillColor("darkgrey").text(s.testProject.tags.join(" | ")).reset()),s.chatbot&&(r.moveDown(),r.font("Helvetica-Bold").text(`Chatbot Under Test: ${s.chatbot.name}`).reset(),s.chatbot.description&&r.text(s.chatbot.description),s.chatbot.tags&&r.fillColor("darkgrey").text(s.chatbot.tags.join(" | ")).reset()),s.testSets&&s.testSets.forEach(e=>{r.moveDown(),r.font("Helvetica-Bold").text(`Test Set: ${e.name}`).reset(),e.description&&r.text(e.description),e.scripts&&r.text(`Scripts: ${e.scripts.length}`),e.repositories&&e.repositories.forEach(e=>{r.text(`Repository: ${e.name}, ${e.gitbranch}`)}),e.folders&&e.folders.forEach(e=>{r.text(`Shared Folder: ${e.name}`)}),e.excels&&e.excels.forEach(e=>{r.text(`Excel File: ${e.name}, ${e.filename}`)}),e.tags&&r.fillColor("darkgrey").text(e.tags.join(" | ")).reset()});const n=r.bufferedPageRange();for(let e=n.start;e<n.start+n.count;e++)r.switchToPage(e),r.fontSize(8),r.image("media/botium-logo.png",r.page.width-35,10,{width:25}),r.text(`${s.name}, page ${e+1} of ${n.count}`,200,r.page.height-40,{height:25});return r.end(),new Promise(e=>{r.pipe(j(t=>e({ts:a,output:t})))})}if("junit"===s){const e=x.groupBy(a.results,e=>e.testSet?e.testSet.name:""),t=x.keys(e).map(t=>{const s=e[t];return{testsuite:[{_attr:{name:t||"unnamed",tests:s.length,failures:s.filter(e=>!e.success).length,time:s.reduce((e,t)=>t.duration?e+t.duration:e,0)/1e3}}]}}),s=B({testsuites:[{_attr:{name:a.name,tests:a.results.length,failures:a.results.filter(e=>!e.success).length,time:a.results.reduce((e,t)=>t.duration?e+t.duration:e,0)/1e3}}].concat(t)},{declaration:!0});return{ts:a,output:s}}if("csv"===s){delete a.results;const e=[];e.push(["testSessionId","testSessionStatus","testSessionName","testCaseId","testCaseName","testCaseSource","testCaseSuccess","testCaseErr","testCaseDuration","testSetId","testSetName","testSetTags","testSetRepository","testSetRepositoryBranch","testSetFolder","testSetExcel","testSetFilename"]);const t=(e,t)=>{t?(e.push(t.id),e.push(t.testcaseName),e.push(Za(t.testcaseSource)),e.push(t.success),e.push(Za(t.err)),e.push(t.duration),t.testSet?(e.push(t.testSet.id),e.push(t.testSet.name),e.push(t.testSet.tags&&t.testSet.tags.join("|")),t.testSetRepository?(e.push(t.testSetRepository.name),e.push(t.testSetRepository.gitbranch)):e.push(null,null),t.testSetFolder?e.push(t.testSetFolder.name):e.push(null),t.testSetExcel?e.push(t.testSetExcel.name):e.push(null),e.push(t.testSetFilename)):e.push(null,null,null,null,null,null,null,null)):e.push(null,null,null,null,null,null,null,null,null,null,null,null,null,null)},s=[a.id,a.status,a.name];return a.results&&a.results.length>0?a.results.forEach(a=>{const r=s.slice(0);t(r,a),e.push(r)}):(t(s,null),e.push(s)),{ts:a,output:sr(e)}}if("jiracsv"===s){const e=[];return e.push(["Build","Date","Summary","Description"]),"FAILED"!==a.status&&e.push([a.name,a.createdAt,`${a.name}: Botium Test Session failed`,`${a.results.filter(e=>!e.success).length} Test Cases failed of ${a.results.length}`]),{ts:a,output:sr(e,",")}}},or=(e,t,s)=>{const a=t.pubsub.asyncIterator("TEST_SESSION_PROGRESS");!async function(){for(;;){const{value:r}=await a.next();if(r.testSessionProgress&&r.testSessionProgress.id===e){const a=await t.db.query.testSession({where:{id:e}},"{ id status }");if(Xa(`Test Project ${e} got status: ${a.status}`),"READY"===a.status)return s();if("FAILED"===a.status)return s()}}}()},ir=(e,t,s,a)=>{const r=er(s,"WAIT");"READY"!==e.status&&"FAILED"!==e.status&&"1"===r?or(e.id,t,()=>ar(e.id,t,s,a)):ar(e.id,t,s,a)},cr=(e,t,s)=>{const a=er(s,"CALLBACKURL"),r=er(s,"CALLBACKMETHOD")||"POST",n=er(s,"REPORTER");a&&("READY"!==e.status&&"FAILED"!==e.status?or(e.id,t,()=>rr(e.id,t,a,r,n)):rr(e.id,t,a,r,n))};var dr=(e,t)=>{const s=(e,s)=>{(({ctxFactory:e,testProjectCode:t,req:s,res:a})=>{if(!tr(s,a))return;const r=e({request:s}),n=Ka(r);r.db.query.testProject({where:{code:t}},"{ id name chatbot { id } testSets { id } deviceSets { id } agent { id } batchCount client { id } }").then(e=>{if(!e)throw new Error(`Test Project ${t} not found`);const a=x.get(e,"client.id");Ya(a,n.clients);const o=er(s,"BUILDID"),i=er(s,"BUILDCOMMENT"),c=er(s,"TAG"),d=e=>Object.keys(e).reduce((t,s)=>(t.push({name:s,type:"STRING",stringValue:e[s]}),t),[]),l=s.body&&s.body.CAPS&&d(s.body.CAPS)||[],u=s.body&&s.body.SOURCES&&d(s.body.SOURCES)||[],p=s.body&&s.body.ENVS&&d(s.body.ENVS)||[],h={name:o||e.name+" - Test Session",description:i,status:"PENDING",tags:{set:c?x.isArray(c)?c:[c]:[]},chatbot:{connect:{id:e.chatbot.id}},testSets:{connect:e.testSets&&e.testSets.map(e=>({id:e.id}))},deviceSets:{connect:e.deviceSets&&e.deviceSets.map(e=>({id:e.id}))},testProject:{connect:{id:e.id}},capabilities:{create:l},sources:{create:u},envs:{create:p},batchCount:e.batchCount};return e.agent&&(h.agent={connect:{id:e.agent.id}}),Xa(`Creating Test Session ${JSON.stringify(h,null,2)}`),Qa(null,{testSession:h},r,"{ id status }")}).then(e=>{ir(e,r,s,a),cr(e,r,s)}).catch(e=>{Xa(`Test Project start error - ${t} - ${e}`),a.sendStatus(404)})})({testProjectCode:e.params.code,ctxFactory:t,req:e,res:s})};e.post("/api/triggerbuild/:code",s),e.get("/api/triggerbuild/:code",s),e.get("/api/build/:nameOrId",(e,s)=>{(({ctxFactory:e,nameOrId:t,req:s,res:a})=>{if(!tr(s,a))return;const r=e({request:s}),n=Ka(r);r.db.query.testSessions({where:{OR:[{id:t},{name:t}]},orderBy:"createdAt_DESC",first:1},"{ id name status client { id } }").then(e=>{if(!e)return a.sendStatus(404);const t=e[0],o=x.get(t,"client.id");Ya(o,n.clients),ir(t,r,s,a),cr(t,r,s)}).catch(e=>{Xa(`Test Session lookup error - ${t} - ${e}`),a.sendStatus(404)})})({nameOrId:e.params.nameOrId,ctxFactory:t,req:e,res:s})}),e.get("/api/log/:nameOrId",(e,s)=>{(({ctxFactory:e,nameOrId:t,req:s,res:a})=>{const r=e({request:s}),n=Ka(r);r.db.query.testSessions({where:{OR:[{id:t},{name:t}]},orderBy:"createdAt_DESC",first:1},"{ id name jobs { id logs { createdAt log } } client { id } }").then(e=>{if(!e)return a.sendStatus(404);const t=e[0],s=x.get(t,"client.id");Ya(s,n.clients),a.set("Content-Type","text/plain"),t.jobs&&t.jobs.forEach(e=>{a.write(`Job Output (${e.id})\n`),e.logs&&e.logs.forEach(e=>{a.write(e.createdAt+": "+e.log+"\n")}),a.write("\n\n"),a.write("##############################################################\n"),a.write("##############################################################\n"),a.write("##############################################################\n"),a.write("\n\n")}),a.status(200).end()}).catch(e=>{Xa(`Test Session lookup error - ${t} - ${e}`),a.sendStatus(404)})})({nameOrId:e.params.nameOrId,ctxFactory:t,req:e,res:s})}),e.get("/api/joblog/:id",(e,s)=>{(({ctxFactory:e,id:t,req:s,res:a})=>{const r=e({request:s}),n=Ka(r);r.db.query.testSessionJob({where:{id:t},orderBy:"createdAt_ASC"},"{ id logs { createdAt log } testSession { client { id } } }").then(e=>{if(!e)return a.sendStatus(404);const t=x.get(e,"testSession.client.id");Ya(t,n.clients),a.set("Content-Type","text/plain"),e.logs&&e.logs.forEach(e=>{a.write(e.createdAt+": "+e.log+"\n")}),a.status(200).end()}).catch(e=>{Xa(`Test Session Job lookup error - ${t} - ${e}`),a.sendStatus(404)})})({id:e.params.id,ctxFactory:t,req:e,res:s})}),e.get("/api/transcript/:nameOrId",(e,s)=>{(({ctxFactory:e,nameOrId:t,req:s,res:a})=>{const r=e({request:s}),n=Ka(r);r.db.query.testSessions({where:{OR:[{id:t},{name:t}]},orderBy:"createdAt_DESC",first:1},"{ id status name client { id } results { id testcaseName createdAt success err duration steps { step expected not actual stepDuration botDuration err } } }").then(e=>{if(!e)return a.sendStatus(404);const t=e[0],r=x.get(t,"client.id");Ya(r,n.clients);const o=er(s,"REPORTER")||"json";if(delete t.results,t.results&&t.results.forEach(e=>{e.steps&&e.steps.forEach(e=>{e.actual&&x.isString(e.actual)&&(e.actual=JSON.parse(e.actual)),e.expected&&x.isString(e.expected)&&(e.expected=JSON.parse(e.expected))})}),"json"===o)a.setHeader("Content-disposition",`attachment; filename="${D(t.name)}.json"`),a.status(200).send(t);else if("csv"===o){const e=[];e.push(["testSessionId","testSessionStatus","testSessionName","testCaseId","testCaseName","testCaseCreatedAt","testCaseSuccess","testCaseErr","testCaseDuration","convoStepIndex","convoStepSender","convoStepActual","convoStepNot","convoStepExpected","convoStepDuration","convoStepBotDuration","convoStepErr"]);const s=(e,t)=>{t?(e.push(t.id),e.push(t.testcaseName),e.push(t.createdAt),e.push(t.success),e.push(Za(t.err)),e.push(t.duration)):e.push(null,null,null,null,null,null)},r=e=>{if("me"===e.sender){if(e.buttons&&e.buttons.length>0)return`BUTTON ${e.buttons[0].payload||e.buttons[0].text}`;if(e.media&&e.media.length>0)return`MEDIA ${e.media[0].mediaUri}`}return e.messageText},n=(e,t)=>{t?(e.push(t.step),e.push(t.actual&&t.actual.sender),e.push(t.actual&&Za(r(t.actual))),e.push(t.not),e.push(t.expected&&Za(r(t.expected))),e.push(t.stepDuration),e.push(t.botDuration),e.push(Za(t.err))):e.push(null,null,null,null,null,null,null,null)},o=[t.id,t.status,t.name];t.results&&t.results.length>0?t.results.forEach(t=>{const a=o.slice(0);s(a,t),t.steps&&t.steps.length>0?t.steps.forEach(t=>{const s=a.slice(0);n(s,t),e.push(s)}):(n(a,null),e.push(a))}):(s(o,null),n(o,null),e.push(o));const i=sr(e);a.setHeader("Content-disposition",`attachment; filename="${D(t.name)}.csv"`),a.status(200).send(i)}else a.sendStatus(404).send("VALID REPORTER OPTIONS: json, csv");a.status(200).end()}).catch(e=>{Xa(`Test Session lookup error - ${t} - ${e}`),a.sendStatus(404)})})({nameOrId:e.params.nameOrId,ctxFactory:t,req:e,res:s})})};const{hasPermission:lr}=Is,ur={"/api/attachment/excel/":"TESTSETS_SELECT","/api/attachment/screenshot/":"TESTSESSIONS_SELECT","/api/triggerbuild/":"TESTSESSIONS_CREATE","/api/build/":"TESTSESSIONS_REPORTS","/api/log/":"TESTSESSIONS_REPORTS","/api/joblog/":"TESTSESSIONS_REPORTS","/api/transcript/":"TESTSESSIONS_REPORTS"};var pr=async(e,t)=>{await(async(e,t)=>{const s=t();(await s.db.query.chatbots({where:{}}," { id name capabilities { name type stringValue intValue booleanValue jsonValue } } ")).filter(e=>e.capabilities&&e.capabilities.filter(e=>"CONTAINERMODE"===e.name&&"fbpagereceiver"===e.stringValue).length>0).forEach(t=>{const a={app:e,endpoint:"/api/fbproxy/"+t.capabilities.find(e=>"FBPAGERECEIVER_ENDPOINT"===e.name).stringValue,verifytoken:t.capabilities.find(e=>"FBPAGERECEIVER_VERIFYTOKEN"===e.name).stringValue,accesstoken:t.capabilities.find(e=>"FBPAGERECEIVER_ACCESSTOKEN"===e.name).stringValue,redisurl:s.queueSettings.redis},r=t.capabilities.find(e=>"FBPAGERECEIVER_APPSECRET"===e.name);r&&r.stringValue?e.use(a.endpoint,P.json({verify:Ga.bind(null,r.stringValue)})):e.use(a.endpoint,P.json()),Ja(a),Va(`Started FB Proxy for chatbot ${t.id}/${t.name}, endpoint: ${a.endpoint}`)})})(e,t),e.use(P.json({limit:"50mb",extended:!0})),e.use(["/api/attachment/*","/api/build/*","/api/triggerbuild/*","/api/log/*","/api/joblog/*","/api/transcript/*"],((e,t,s,a)=>{if(!t.apiKey&&!t.user)return s.sendStatus(401);if(t.apiKey)return a();for(const e in ur)if(t.baseUrl.startsWith(e)&&!lr(t.user,ur[e]))return s.sendStatus(401);return a()}).bind(null,t)),((e,t)=>{e.get("/api/attachment/excel/:id",async(e,s)=>{const a=e.params.id,r=t({request:e});try{const e=za(r),t=await Vt.getExcel(r.db,a);if(t){const a=x.get(t,"testSet.client.id");Wa(a,e.clients);const r=Buffer.from(t.filecontent,"base64");s.writeHead(200,{"Content-disposition":`attachment; filename="${t.filename}"`,"Content-Length":r.length}),s.end(r)}else Ha(`Excel not found - ${a}`),s.sendStatus(404)}catch(e){Ha(`Excel lookup error - ${a} - ${e}`),s.sendStatus(404)}}),e.get("/api/attachment/screenshot/:id",async(e,s)=>{const a=e.params.id,r=t({request:e});try{const e=za(r),t=await Vt.getAttachment(r.db,a);if(t){const a=x.get(t,"testSessionTestCaseResult.testSession.client.id");Wa(a,e.clients);const r=Buffer.from(t.base64,"base64");s.writeHead(200,{"Content-Disposition":`inline; filename="${t.name}"`,"Content-Type":t.mimeType,"Content-Length":r.length}),s.end(r)}else Ha(`Attachment not found - ${a}`),s.sendStatus(404)}catch(e){Ha(`Attachment lookup error - ${a} - ${e}`),s.sendStatus(404)}})})(e,t),dr(e,t),((e,t)=>{e.get("/api/version",(e,t)=>{t.status(200).send(V)})})(e)};L.config(),H();const{GraphQLServer:hr}=v,{RedisPubSub:Sr}=U,{Prisma:mr}=F,{validateToken:fr}=bs,Tr=k("botium-box-server-index"),br=()=>new mr({typeDefs:process.env.PRISMA_SCHEMA||"src/generated/prisma.graphql",endpoint:process.env.PRISMA_ENDPOINT,debug:process.env.PRISMA_DEBUG,secret:process.env.PRISMA_SECRET}),yr=(e,t)=>{e&&console.log(e),t&&console.log(t),process.exit(1)};let gr={};if(process.env.BOTIUMBOX_QUEUE_SETTINGS)try{gr=JSON.parse(process.env.BOTIUMBOX_QUEUE_SETTINGS),Tr(`Got queue settings '${JSON.stringify(gr)}'`)}catch(e){yr(`ERROR parsing queue settings "${process.env.BOTIUMBOX_QUEUE_SETTINGS}":`,e)}else process.env.BOTIUMBOX_QUEUE_PREFIX&&(gr.prefix=process.env.BOTIUMBOX_QUEUE_PREFIX),process.env.BOTIUMBOX_QUEUE_REDISURL&&(gr.redis=process.env.BOTIUMBOX_QUEUE_REDISURL);Tr(`connecting to Botium queue '${JSON.stringify(gr)}'`);const Er=E.createQueue(gr);Er.setMaxListeners(1e3),Er.watchStuckJobs(),Er.on("error",e=>{console.log(`ERROR on queue '${JSON.stringify(gr)}':`,e)}),process.env.BOTIUM_TEMPDIR=process.env.BOTIUM_TEMPDIR||"./botiumwork";try{c.sync(process.env.BOTIUM_TEMPDIR),Tr(`Using BOTIUM_TEMPDIR ${process.env.BOTIUM_TEMPDIR}`)}catch(e){yr(`ERROR verifying BOTIUM_TEMPDIR '${process.env.BOTIUM_TEMPDIR}':`,e)}process.env.TESTSETDIR=process.env.TESTSETDIR||"./testsets";try{c.sync(process.env.TESTSETDIR),Tr(`Using TESTSETDIR ${process.env.TESTSETDIR}`)}catch(e){yr(`ERROR verifying TESTSETDIR '${process.env.TESTSETDIR}':`,e)}Dt(br());const wr=new Sr({connection:gr.redis});wr.ee&&wr.ee.setMaxListeners&&wr.ee.setMaxListeners(0);const Cr=new W(43200),vr=e=>({...e||{},db:br(),queueConnector:Er,queueSettings:gr,pubsub:wr,chartsCache:Cr});Tr(`Using Prisma Endpoint ${process.env.PRISMA_ENDPOINT}`);const Ir=new hr({typeDefs:process.env.GRAPHQL_SCHEMA||"./src/schema.graphql",resolvers:Oa,resolverValidationOptions:{requireResolversForResolveType:!1},schemaDirectives:qa,context:vr,middlewares:[async(e,t,s,a,r)=>{try{const n=await e(t,s,a,r);return n instanceof Error&&Tr(n),n}catch(e){throw Tr(e),e}}]}),Or={port:process.env.PORT||4e3,endpoint:"/graphql",subscriptions:{path:"/subscriptions",onConnect:async(e,t,s)=>{if(e.Authorization){return{user:await fr(e.Authorization,br())}}throw new Error("Missing auth token!")},onDisconnect:(e,t)=>{}},playground:"/playground"};(async()=>{await ia.loadStrategy(vr),await Ma(Ir.express,0,vr),await pr(Ir.express,vr),Ir.start(Or,({port:e})=>{const s=process.env.BOTIUMBOX_STATIC_PATH?t.resolve(process.env.BOTIUMBOX_STATIC_PATH):t.resolve(t.join(__dirname,"../../botium-box-client/build"));Ir.express.use(J()),Ir.express.use("/",M.static(s)),console.log(`Server started, listening on port ${e} for incoming requests, static files served from ${s}`)})})(),new class{constructor(e){this.ctxFactory=e}start(){const e=this.ctxFactory();e.queueConnector.process("agent.heartbeat",1,(t,s)=>{as("agent.heartbeat: "+JSON.stringify(t.data)),((e,t,s)=>{Vt.findAgentFromJobData(e.db,t,"{ id, name }").then(a=>{if(!a){const e=`Agent ${t.data.name} not configured`;return ts(e),s(e)}e.db.mutation.updateAgent({where:{id:a.id},data:{heartbeat:new Date(Date.now()).toISOString()}}).then(()=>s())}).catch(e=>s(e))})(e,t,s)}),e.queueConnector.process("agent.register",1,(t,s)=>{as("agent.register: "+JSON.stringify(t.data)),(async(e,t,s)=>{const a=process.env.BOTIUMBOX_AGENTREGISTRATION&&"AUTO"===process.env.BOTIUMBOX_AGENTREGISTRATION||!0;try{let r=await Vt.findAgentFromJobData(e.db,t);if(!r){if(!a){const e=`Agent ${t.data.name} not configured`;return ss(e),s(e)}ss(`Agent ${t.data.name} not yet registered, automatically registering.`),r=await e.db.mutation.createAgent({data:{name:t.data.name}})}const n={debug:!1,botium:{Capabilities:Vt.composeBotiumCapabilities(r.capabilities)}};ss(`Agent ${t.data.name} registered, config: ${JSON.stringify(n)}`),s(null,n)}catch(e){ss(`Agent ${t.data.name} registration failed: ${A.inspect(e)}`),s(e)}})(e,t,s)}),e.queueConnector.process("box.createprocessingjobs",1,(t,s)=>{as("box.createprocessingjobs: "+JSON.stringify(t.data)),rs(e,t.data).then(()=>s()).catch(s)}),e.queueConnector.on("error",e=>{as("ERROR connecting to queue:"),as(e)}),e.queueConnector.on("job failed attempt",(e,t)=>{E.Job.get(e,(s,a)=>{s||(a=a.toJSON(),as(`Job ${e}/${a.type} failed attempt, ${JSON.stringify(a.attempts)} - Err: ${t}`))})}).on("job failed",(e,t)=>{E.Job.get(e,(s,a)=>{s||(a=a.toJSON(),as(`Job ${e}/${a.type} failed finally, ${JSON.stringify(a.attempts)} - Err: ${t} - Job Data: ${JSON.stringify(a.data)}`))})}),e.queueConnector.process("process.progress",1,async(t,s)=>{try{await cs(e,t.data),s()}catch(e){s(e)}}),e.queueConnector.process("process.log",1,async(t,s)=>{try{await is(e,t.data),s()}catch(e){s(e)}}),e.queueConnector.process("process.ready.success",1,async(t,s)=>{as("process.ready.success: "+JSON.stringify(t.data));try{await ns(e,t.data),await ds(e,t.data),s()}catch(e){s(e)}}),e.queueConnector.process("process.ready.failed",1,async(t,s)=>{as("process.ready.failed: "+JSON.stringify(t.data));try{await os(e,t.data),await ds(e,t.data),s()}catch(e){s(e)}})}}(vr).start(),new class{constructor(e){this.ctxFactory=e}start(){const e=this.ctxFactory();ms(e)}}(vr).start(),Mt.startListeners(vr()),process.on("uncaughtException",e=>{console.log("UNCAUGHTEXCEPTION",e),console.log(e.stack)}),process.on("warning",e=>{Tr("WARNING",e)});return{}});
