!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("node-cache"),require("botium-core/src/Capabilities"),require("nodegit"),require("botium-core/src/scripting/Constants"),require("natural"),require("mkdirp"),require("rimraf"),require("botium-core"),require("uuid/v1"),require("ioredis"),require("better-queue"),require("url"),require("kue"),require("jsonwebtoken"),require("watson-developer-cloud/assistant/v1"),require("botium-core/src/scripting/CompilerTxt"),require("fs"),require("path"),require("passport"),require("passport-local"),require("passport-ldapauth"),require("randomatic"),require("bcryptjs"),require("graphql-yoga"),require("graphql-tools"),require("graphql"),require("util"),require("express-jwt"),require("body-parser"),require("botium-connector-fbpagereceiver/src/proxy"),require("adm-zip"),require("request-promise-native"),require("moment"),require("xml"),require("pdfkit"),require("concat-stream"),require("slugify"),require("debug"),require("lodash"),require("dotenv-flow"),require("graphql-redis-subscriptions"),require("prisma-binding"),require("express"),require("connect-history-api-fallback")):"function"==typeof define&&define.amd?define(["node-cache","botium-core/src/Capabilities","nodegit","botium-core/src/scripting/Constants","natural","mkdirp","rimraf","botium-core","uuid/v1","ioredis","better-queue","url","kue","jsonwebtoken","watson-developer-cloud/assistant/v1","botium-core/src/scripting/CompilerTxt","fs","path","passport","passport-local","passport-ldapauth","randomatic","bcryptjs","graphql-yoga","graphql-tools","graphql","util","express-jwt","body-parser","botium-connector-fbpagereceiver/src/proxy","adm-zip","request-promise-native","moment","xml","pdfkit","concat-stream","slugify","debug","lodash","dotenv-flow","graphql-redis-subscriptions","prisma-binding","express","connect-history-api-fallback"],t):e.main=t(e.nodeCache,e.Capabilities,e.nodegit,e.Constants,e.natural,e.mkdirp,e.rimraf,e.botiumCore,e.v1,e.ioredis,e.betterQueue,e.url,e.kue,e.jsonwebtoken,e.v1$1,e.CompilerTxt,e.fs,e.path,e.passport,e.passportLocal,e.passportLdapauth,e.randomatic,e.bcryptjs,e.graphqlYoga,e.graphqlTools,e.graphql,e.util,e.expressJwt,e.bodyParser,e.proxy,e.admZip,e.requestPromiseNative,e.moment,e.xml,e.pdfkit,e.concatStream,e.slugify,e.debug,e.lodash,e.dotenvFlow,e.graphqlRedisSubscriptions,e.prismaBinding,e.express,e.connectHistoryApiFallback)}(this,function(e,t,s,n,a,r,o,i,c,d,u,l,p,h,S,m,f,T,g,b,y,E,w,C,v,I,O,R,N,P,A,$,x,D,_,k,j,M,q,B,L,F,J,U){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t,s=s&&s.hasOwnProperty("default")?s.default:s,n=n&&n.hasOwnProperty("default")?n.default:n,a=a&&a.hasOwnProperty("default")?a.default:a,r=r&&r.hasOwnProperty("default")?r.default:r,o=o&&o.hasOwnProperty("default")?o.default:o,i=i&&i.hasOwnProperty("default")?i.default:i,c=c&&c.hasOwnProperty("default")?c.default:c,d=d&&d.hasOwnProperty("default")?d.default:d,u=u&&u.hasOwnProperty("default")?u.default:u,l=l&&l.hasOwnProperty("default")?l.default:l,p=p&&p.hasOwnProperty("default")?p.default:p,h=h&&h.hasOwnProperty("default")?h.default:h,S=S&&S.hasOwnProperty("default")?S.default:S,m=m&&m.hasOwnProperty("default")?m.default:m,f=f&&f.hasOwnProperty("default")?f.default:f,T=T&&T.hasOwnProperty("default")?T.default:T,g=g&&g.hasOwnProperty("default")?g.default:g,b=b&&b.hasOwnProperty("default")?b.default:b,y=y&&y.hasOwnProperty("default")?y.default:y,E=E&&E.hasOwnProperty("default")?E.default:E,w=w&&w.hasOwnProperty("default")?w.default:w,C=C&&C.hasOwnProperty("default")?C.default:C,v=v&&v.hasOwnProperty("default")?v.default:v,I=I&&I.hasOwnProperty("default")?I.default:I,O=O&&O.hasOwnProperty("default")?O.default:O,R=R&&R.hasOwnProperty("default")?R.default:R,N=N&&N.hasOwnProperty("default")?N.default:N,P=P&&P.hasOwnProperty("default")?P.default:P,A=A&&A.hasOwnProperty("default")?A.default:A,$=$&&$.hasOwnProperty("default")?$.default:$,x=x&&x.hasOwnProperty("default")?x.default:x,D=D&&D.hasOwnProperty("default")?D.default:D,_=_&&_.hasOwnProperty("default")?_.default:_,k=k&&k.hasOwnProperty("default")?k.default:k,j=j&&j.hasOwnProperty("default")?j.default:j,M=M&&M.hasOwnProperty("default")?M.default:M,q=q&&q.hasOwnProperty("default")?q.default:q,B=B&&B.hasOwnProperty("default")?B.default:B,L=L&&L.hasOwnProperty("default")?L.default:L,F=F&&F.hasOwnProperty("default")?F.default:F,J=J&&J.hasOwnProperty("default")?J.default:J,U=U&&U.hasOwnProperty("default")?U.default:U;const G={buildTarget:"COMMUNITY EDITION",buildBranch:"release/1.6.0",buildRevision:"65ffaa3fe2442427262dae64218358ec4aa6105b",buildDate:"2019-05-23T15:52:37+02:00"};var V=G,H=()=>{console.log("BOTIUM BOX - SERVER"),console.log(`BUILD_TARGET: ${G.buildTarget}`),console.log(`BUILD_BRANCH: ${G.buildBranch}`),console.log(`BUILD_REVISION: ${G.buildRevision}`),console.log(`BUILD_TIMESTAMP: ${G.buildDate}`)};const Y=M("botium-box-server-cache");var X=class{constructor(t){this.cache=new e({stdTTL:t,checkperiod:.2*t,useClones:!1}),this.loading={}}get(e,t){const s=this.cache.get(e);if(s)return Y(`Serving key ${e} from cache`),Promise.resolve(s);if(this.loading[e]){return Y(`Load process for key ${e} already running, waiting ...`),new Promise((t,s)=>{this.loading[e].listeners.push({resolve:t,reject:s})})}this.loading[e]=this.loading[e]||{listeners:[]};const n=new Promise((t,s)=>{this.loading[e].listeners.push({resolve:t,reject:s})});return Y(`Load process for key ${e} started, waiting ...`),t().then(t=>{Y(`Load process for key ${e} ready, notifying listeners ...`),this.cache.set(e,t),this.loading[e].listeners.forEach(({resolve:e})=>e(t)),delete this.loading[e]}).catch(t=>{this.loading[e].listeners.forEach(({reject:e})=>e(t)),delete this.loading[e]}),n}del(e){this.cache.del(e)}delStartWith(e=""){if(!e)return;const t=this.cache.keys();for(const s of t)0===s.indexOf(e)&&this.del(s)}flush(){this.cache.flushAll()}};const z=M("botium-box-server-utils");var W={FindFullTestSet:(e,t)=>e.query.testSet({where:{id:t}}," \n{\n  id\n  name\n  client { id }\n  expandConvos\n  expandUtterancesToConvos\n  expandUtterancesIncomprehension\n  selectionType\n  tags\n  scripts { id name script scriptType }\n  repositories { id name giturl gitbranch gitdir gituser gitpassword globFilter }\n  folders { id name path globFilter }\n  excels { id name filename filecontent hasConvos hasPartialConvos hasUtterances worksheetsConvos worksheetsPartialConvos worksheetsUtterances startRow startCol }\n}"),RetrieveTestSetDetails:e=>({id:e.id,name:e.name,expandConvos:e.expandConvos,expandUtterancesToConvos:e.expandUtterancesToConvos,expandScriptingMemory:e.expandScriptingMemory,convos:"SELECTION_TYPE_REMOTE_ONLY"!==e.selectionType&&e.scripts&&e.scripts.filter(e=>"SCRIPTING_TYPE_CONVO"===e.scriptType).map(t=>({format:"SCRIPTING_FORMAT_TXT",content:t.script,sourceTag:{testSetId:e.id,testSetScriptId:t.id}})),pconvos:"SELECTION_TYPE_REMOTE_ONLY"!==e.selectionType&&e.scripts&&e.scripts.filter(e=>"SCRIPTING_TYPE_PCONVO"===e.scriptType).map(t=>({format:"SCRIPTING_FORMAT_TXT",content:t.script,sourceTag:{testSetId:e.id,testSetScriptId:t.id}})),utterances:"SELECTION_TYPE_REMOTE_ONLY"!==e.selectionType&&e.scripts&&e.scripts.filter(e=>"SCRIPTING_TYPE_UTTERANCES"===e.scriptType).map(t=>({format:"SCRIPTING_FORMAT_TXT",content:t.script,sourceTag:{testSetId:e.id,testSetScriptId:t.id}})),scriptingMemories:e.scripts&&e.scripts.filter(e=>"SCRIPTING_TYPE_SCRIPTING_MEMORY"===e.scriptType).map(t=>({format:"SCRIPTING_FORMAT_TXT",content:t.script,sourceTag:{testSetId:e.id,testSetScriptId:t.id}})),folders:"SELECTION_TYPE_LOCAL_ONLY"!==e.selectionType&&e.folders&&e.folders.map(t=>({id:t.id,path:t.path,globFilter:t.globFilter,sourceTag:{testSetId:e.id,testSetFolderId:t.id}})),excels:"SELECTION_TYPE_REMOTE_ONLY"!==e.selectionType&&e.excels&&e.excels.map(t=>({id:t.id,filename:t.filename,filecontent:t.filecontent,hasConvos:t.hasConvos,hasPartialConvos:t.hasPartialConvos,hasUtterances:t.hasUtterances,worksheetsConvos:t.worksheetsConvos,worksheetsPartialConvos:t.worksheetsPartialConvos,worksheetsUtterances:t.worksheetsUtterances,startRow:t.startRow,startCol:t.startCol,sourceTag:{testSetId:e.id,testSetExcelId:t.id,filename:t.filename}}))}),ExtractQueueSettings:()=>{let e={};if(process.env.BOTIUMBOX_QUEUE_SETTINGS)try{e=JSON.parse(process.env.BOTIUMBOX_QUEUE_SETTINGS),z(`Got queue settings '${JSON.stringify(e)}'`)}catch(e){((e,t)=>{e&&console.log(e),t&&console.log(t),process.exit(1)})(`ERROR parsing queue settings "${process.env.BOTIUMBOX_QUEUE_SETTINGS}":`,e)}else process.env.BOTIUMBOX_QUEUE_PREFIX&&(e.prefix=process.env.BOTIUMBOX_QUEUE_PREFIX),process.env.BOTIUMBOX_QUEUE_REDISURL&&(e.redis=process.env.BOTIUMBOX_QUEUE_REDISURL);return e}};var K,Q=(function(e){const s=M("botium-box-server-agents-utils"),n=e.exports,{RetrieveTestSetDetails:a}=W;e.exports.getServerDefaultCapabilities=(e=>({FBPAGERECEIVER_REDISURL:e&&e.queueSettings&&e.queueSettings.redis})),e.exports.getAttachment=((e,t)=>e.query.testSessionTestCaseResultAttachment({where:{id:t}},"{ id name mimeType base64 testSessionTestCaseResult { testSession { client { id } } } }")),e.exports.getExcel=((e,t)=>e.query.testSetExcel({where:{id:t}},"{ id filename filecontent testSet { client { id } } }")),e.exports.lookupApiKey=((e,t)=>{const s=new Date(Date.now()).toISOString();if(!t)return;const n={where:{AND:[{key:t},{OR:[{validFrom:null},{validFrom_lte:s}]},{OR:[{validTo:null},{validTo_gte:s}]}]}};return e.query.apiKeys(n,"{ id name clients { id name } }").then(e=>e&&0!==e.length?(e[0].roles=[{id:"APIKEY",name:"APIKEY",permissions:["*"]}],e[0]):null)}),e.exports.findFullPerformanceTestSession=((e,t)=>e.query.performanceTestSession({where:{id:t}},"{ \n    id \n    client { id name }\n    createdAt\n    name\n    description\n    tags\n    chatbot { \n      id \n      name\n      description \n      tags\n      capabilities { name type stringValue intValue booleanValue jsonValue } \n      sources { name type stringValue intValue booleanValue jsonValue } \n      envs { name type stringValue intValue booleanValue jsonValue } \n    } \n    testSets { \n      id \n      name\n    }\n    registeredComponents { id name type default src ref global args }\n    testProject { id name description tags capabilities { name type stringValue intValue booleanValue jsonValue } }\n    results {id stepIndex convo execCount execDurationMin execDurationMax execDurationSum waitCount waitDurationMin waitDurationMax waitDurationSum}\n    jobs {id status err started finished agentName}\n    capabilities { name type stringValue intValue booleanValue jsonValue } \n    sources { name type stringValue intValue booleanValue jsonValue } \n    envs { name type stringValue intValue booleanValue jsonValue }\n    parallelConvoCount\n    parallelJobCount\n    tickRepeatInitial\n    tickRepeatPerTick\n    tickMaxTime\n    tickTime\n    dataDensity     \n    }")),e.exports.findFullTestSession=((e,t)=>e.query.testSession({where:{id:t}},"{ \n    id \n    name\n    client { id name }\n    description\n    createdAt\n    tags\n    batchCount\n    bail\n    chatbot { \n      id \n      name\n      description \n      tags\n      capabilities { name type stringValue intValue booleanValue jsonValue } \n      sources { name type stringValue intValue booleanValue jsonValue } \n      envs { name type stringValue intValue booleanValue jsonValue } \n    } \n    testSets { \n      id \n      name\n    }\n    deviceSets { id name description tags provider { id name type url username password } devices { id name capabilities } } \n    testProject { id name description tags capabilities { name type stringValue intValue booleanValue jsonValue } }\n    registeredComponents { id name type default src ref global args }\n    agent { id name } \n    capabilities { name type stringValue intValue booleanValue jsonValue } \n    sources { name type stringValue intValue booleanValue jsonValue } \n    envs { name type stringValue intValue booleanValue jsonValue } \n    }")),e.exports.findSimpleTestSessionResults=((e,t)=>e.query.testSession({where:{id:t}},"{ id name status createdAt\n    client { id name }\n    results { \n      id testcaseName createdAt testcaseSource success err duration \n      testSet { id name tags } \n      testSetRepository { id name gitbranch }\n      testSetFolder { id name }\n      testSetExcel { id name }\n      testSetFilename\n    } }")),e.exports.findSimplePerformanceTestSessionResults=((e,t)=>e.query.performanceTestSession({where:{id:t}},"{ id name createdAt\n    client { id name }\n    results {id stepIndex convo execCount execDurationMin execDurationMax execDurationSum waitCount waitDurationMin waitDurationMax waitDurationSum stepStartAt job {id}}\n    jobs {id status err started finished agentName}\n    }")),e.exports.findAgentFromJobData=((e,t,n)=>{if(!t.data.name||!t.data.group){const e=`invalid agent event, name or group not given ${t.data}`;return s(e),Promise.reject(e)}return e.query.agent({where:{name:t.data.name}},n||"{ id name debug capabilities { name type stringValue intValue booleanValue jsonValue } }")}),e.exports.findAgentFromName=((e,t,s)=>e.query.agent({where:{name:t}},s||"{ id name debug capabilities { name type stringValue intValue booleanValue jsonValue } }"));const r=e=>({ref:e.ref,src:e.src,global:e.global,args:e.args&&JSON.parse(e.args)});e.exports.combineRegisteredComponents=((...e)=>{const t={ASSERTERS:[],LOGIC_HOOKS:[],USER_INPUTS:[]},s={ASSERTER:"ASSERTERS",LOGICHOOK:"LOGIC_HOOKS",USERINPUT:"USER_INPUTS"};return e&&e.forEach(e=>{e&&e.forEach(e=>{const n=s[e.type];if(!n)return;const a=t[n].findIndex(t=>t.ref===e.ref);a>=0?t[n][a]=r(e):t[n].push(r(e))})}),t}),e.exports.composeBotiumCapabilities=(e=>e&&e.reduce((e,t)=>("STRING"!==t.type&&"TEXT"!==t.type&&"JS"!==t.type||(e[t.name]=t.stringValue?t.stringValue.replace(/\\n/g,"\n"):""),"INT"===t.type&&(e[t.name]=parseInt(t.intValue)),"BOOLEAN"===t.type&&(e[t.name]=!!t.booleanValue),"JSON"===t.type&&(e[t.name]=t.jsonValue),e),{})),e.exports.combineBotiumCapabilities=((...e)=>{const t={};return e&&e.forEach(e=>{e&&Object.keys(e).forEach(s=>{t[s]=e[s]})}),t}),e.exports.extractTestSessionLike=(async(t,r)=>{const o=await t.db.query.registeredComponents({where:{default:!0}}),i=n.combineRegisteredComponents(o,r.registeredComponents),c=n.combineBotiumCapabilities(i,{PROJECTNAME:r.name},n.composeBotiumCapabilities(r.chatbot.capabilities),n.combineScriptingCapabilities(r.testSets),r.testProject&&n.composeBotiumCapabilities(r.testProject.capabilities)||[],n.composeBotiumCapabilities(r.capabilities),n.getServerDefaultCapabilities(t));s(`extractTestSessionLike ${r.id} testSessionCaps: ${JSON.stringify(c)}`);const d=n.combineBotiumCapabilities(n.composeBotiumCapabilities(r.chatbot.sources),n.composeBotiumCapabilities(r.sources));s(`extractTestSessionLike ${r.id} testSessionSources: ${JSON.stringify(d)}`);const u=n.combineBotiumCapabilities(n.composeBotiumCapabilities(r.chatbot.envs),n.composeBotiumCapabilities(r.envs));s(`extractTestSessionLike ${r.id} testSessionEnvs: ${JSON.stringify(u)}`);const l=(await e.exports.extractAllInvolvedTestSets(t,r.testSets)).map(e=>a(e));return s(`extractTestSessionLike ${r.id} testSessionTestSets: ${JSON.stringify(l)}`),{testSessionCaps:c,testSessionSources:d,testSessionEnvs:u,testSessionTestSets:l}}),e.exports.extractAllInvolvedTestSets=(async(e,t)=>{const s=[],n=async t=>{if(s.findIndex(e=>e.id===t)>=0)return;const a=await e.db.query.testSet({where:{id:t}},"{ \n        id \n        name\n        description \n        tags\n        useMatchingMode\n        expandConvos\n        expandConvosMode\n        expandConvosModeRandomCount\n        expandUtterancesToConvos\n        expandUtterancesIncomprehension\n        useScriptingMemory\n        useScriptingMemoryMatchingMode\n        expandScriptingMemory\n        normalizeText\n        selectionType\n        scripts { id name script scriptType } \n        repositories { id name giturl gitbranch gitdir gituser gitpassword globFilter } \n        folders { id name path globFilter }\n        excels { id name filename filecontent hasConvos hasPartialConvos hasUtterances worksheetsConvos worksheetsPartialConvos worksheetsUtterances startRow startCol }\n        dependencies { id }\n      }");if(s.push(a),a.dependencies)for(const e of a.dependencies)await n(e.id)};for(const e of t)await n(e.id);return s});const o={UTTEXPANSION_MODE_ALL:"all",UTTEXPANSION_MODE_FIRST:"first",UTTEXPANSION_MODE_RANDOM:"random"},i={MATCHING_MODE_REGEXP:"regexp",MATCHING_MODE_INCLUDE:"include",MATCHING_MODE_INCLUDELOWERCASE:"includeLowerCase"},c={MATCHING_MODE_NON_WHITESPACE:"non_whitespace",MATCHING_MODE_WORD:"word"};e.exports.combineScriptingCapabilities=(e=>{if(!e)return{};const s={},n=e.filter(e=>e.useMatchingMode).map(e=>e.useMatchingMode);if(q.uniq(n).length>1)throw new Error(`Test Sets not compatible, found multiple SCRIPTING_MATCHING_MODE: ${O.inspect(n)} ...`);n.length>0&&(s[t.SCRIPTING_MATCHING_MODE]=i[n[0]]),s[t.SCRIPTING_NORMALIZE_TEXT]=!!(e.findIndex(e=>e.normalizeText)>=0),s[t.SCRIPTING_ENABLE_MEMORY]=!!(e.findIndex(e=>e.useScriptingMemory)>=0);const a=q.uniq(e.filter(e=>e.useScriptingMemory&&e.useScriptingMemoryMatchingMode).map(e=>e.useScriptingMemoryMatchingMode));if(a.length>1)throw new Error(`Test Sets not compatible, found multiple SCRIPTING_MEMORY_MATCHING_MODE: ${O.inspect(a)} ...`);a.length>0&&(s[t.SCRIPTING_MEMORY_MATCHING_MODE]=c[a[0]]);const r=q.uniq(e.filter(e=>e.expandConvos&&e.expandConvosMode).map(e=>e.expandConvosMode));if(r.length>1)throw new Error(`Test Sets not compatible, found multiple SCRIPTING_UTTEXPANSION_MODE: ${O.inspect(r)} ...`);r.length>0&&(s[t.SCRIPTING_UTTEXPANSION_MODE]=o[r[0]]);const d=q.uniq(e.filter(e=>e.expandConvos&&"UTTEXPANSION_MODE_RANDOM"===e.expandConvosMode&&e.expandConvosModeRandomCount).map(e=>e.expandConvosModeRandomCount));if(d.length>1)throw new Error(`Test Sets not compatible, found multiple SCRIPTING_UTTEXPANSION_RANDOM_COUNT: ${O.inspect(d)} ...`);d.length>0&&(s[t.SCRIPTING_UTTEXPANSION_RANDOM_COUNT]=d[0]);const u=q.uniq(e.filter(e=>e.expandUtterancesToConvos&&e.expandUtterancesIncomprehension).map(e=>e.expandUtterancesIncomprehension));if(u&&u.length>1)throw new Error(`Test Sets not compatible, found multiple SCRIPTING_UTTEXPANSION_INCOMPREHENSION: ${O.inspect(u)} ...`);return u&&u.length>0&&(s[t.SCRIPTING_UTTEXPANSION_INCOMPREHENSION]=u[0]),s})}(K={exports:{}},K.exports),K.exports);Q.getServerDefaultCapabilities,Q.getAttachment,Q.getExcel,Q.lookupApiKey,Q.findFullPerformanceTestSession,Q.findFullTestSession,Q.findSimpleTestSessionResults,Q.findSimplePerformanceTestSessionResults,Q.findAgentFromJobData,Q.findAgentFromName,Q.combineRegisteredComponents,Q.composeBotiumCapabilities,Q.combineBotiumCapabilities,Q.extractTestSessionLike,Q.extractAllInvolvedTestSets,Q.combineScriptingCapabilities;const Z=M("botium-retrieve-all-test-cases");var ee=(e,s,a)=>{e.convos&&e.convos.forEach(t=>{let a=[];try{t.format===n.SCRIPTING_FORMAT_TXT&&(a=s.Compile(t.content,n.SCRIPTING_FORMAT_TXT,n.SCRIPTING_TYPE_CONVO)),a&&a.forEach(e=>{e.sourceTag=t.sourceTag})}catch(t){throw Z(t),new Error(`${e.name}: Convo Script compilation failed: ${O.inspect(t)}`)}}),e.pconvos&&e.pconvos.forEach(t=>{let a=[];try{t.format===n.SCRIPTING_FORMAT_TXT&&(a=s.Compile(t.content,n.SCRIPTING_FORMAT_TXT,n.SCRIPTING_TYPE_PCONVO)),a&&a.forEach(e=>{e.sourceTag=t.sourceTag})}catch(t){throw Z(t),new Error(`${e.name}: Partial Convo Script compilation failed: ${O.inspect(t)}`)}}),e.utterances&&e.utterances.forEach(t=>{let a=[];try{t.format===n.SCRIPTING_FORMAT_TXT&&(a=s.Compile(t.content,n.SCRIPTING_FORMAT_TXT,n.SCRIPTING_TYPE_UTTERANCES)),a&&a.forEach(e=>{e.sourceTag=t.sourceTag})}catch(t){throw Z(t),new Error(`${e.name}: Utterance script compilation failed: ${O.inspect(t)}`)}}),e.scriptingMemories&&e.scriptingMemories.forEach(t=>{let a=[];try{t.format===n.SCRIPTING_FORMAT_TXT&&(a=s.Compile(t.content,n.SCRIPTING_FORMAT_TXT,n.SCRIPTING_TYPE_SCRIPTING_MEMORY)),a&&a.forEach(e=>{e.sourceTag=t.sourceTag})}catch(t){throw Z(t),new Error(`${e.name}: Scripting Memory script compilation failed: ${O.inspect(t)}`)}}),e.folders&&e.folders.forEach(t=>{try{const{convos:n,pconvos:a,utterances:r}=s.ReadScriptsFromDirectory(t.path,t.globFilter);n&&n.forEach(e=>{e.sourceTag=Object.assign({},e.sourceTag,t.sourceTag)}),a&&a.forEach(e=>{e.sourceTag=Object.assign({},e.sourceTag,t.sourceTag)}),r&&r.forEach(e=>{e.sourceTag=Object.assign({},e.sourceTag,t.sourceTag)})}catch(s){throw Z(s),new Error(`${e.name}: Folder ${t} script compilation failed: ${O.inspect(s)}`)}});let r=Promise.resolve();e.excels&&e.excels.length>0&&(r=Promise.all(e.excels.map(({id:e,filename:a,filecontent:r,hasConvos:o,hasPartialConvos:i,hasUtterances:c,worksheetsConvos:d,worksheetsPartialConvos:u,worksheetsUtterances:l,startRow:p,startCol:h,sourceTag:S})=>new Promise(e=>{const a=Buffer.from(r,"base64");let m=[],f=[],T=[];o&&(d&&(s.caps[t.SCRIPTING_XLSX_SHEETNAMES]=d),isNaN(p)||(s.caps[t.SCRIPTING_XLSX_STARTROW]=p),isNaN(h)||(s.caps[t.SCRIPTING_XLSX_STARTCOL]=h),m=s.Compile(a,n.SCRIPTING_FORMAT_XSLX,n.SCRIPTING_TYPE_CONVO)),i&&(u&&(s.caps[t.SCRIPTING_XLSX_SHEETNAMES_PCONVOS]=u),isNaN(p)||(s.caps[t.SCRIPTING_XLSX_STARTROW]=p),isNaN(h)||(s.caps[t.SCRIPTING_XLSX_STARTCOL]=h),f=s.Compile(a,n.SCRIPTING_FORMAT_XSLX,n.SCRIPTING_TYPE_PCONVO)),c&&(l&&(s.caps[t.SCRIPTING_XLSX_SHEETNAMES_UTTERANCES]=l),isNaN(p)||(s.caps[t.SCRIPTING_XLSX_STARTROW]=p),isNaN(h)||(s.caps[t.SCRIPTING_XLSX_STARTCOL]=h),T=s.Compile(a,n.SCRIPTING_FORMAT_XSLX,n.SCRIPTING_TYPE_UTTERANCES)),m&&m.forEach(e=>{e.sourceTag=Object.assign({},e.sourceTag,S)}),f&&f.forEach(e=>{e.sourceTag=Object.assign({},e.sourceTag,S)}),T&&T.forEach(e=>{e.sourceTag=Object.assign({},e.sourceTag,S)}),e()}))));let o=Promise.resolve();return Promise.all([o,r])};const te=new a.RegexpTokenizer({pattern:/([A-zÀ-ÿ-$]+|[0-9._]+|.|!|\?|'|"|:|;|,|-)/i}),se=e=>te.tokenize(e),ne=e=>se(e).filter(e=>!re(e));const ae=(e,t,s)=>[e.substr(0,t),s,e.substr(t+1)].join("");const re=e=>e&&e.length>1&&e.startsWith("$");var oe={tokenize:ne,evaluateProbability:e=>Math.random()<e,getLongestToken:e=>{const t=ne(e).sort((e,t)=>t.length-e.length);return t.length?t[0]:""},replaceCharAtCaseSensitive:(e,t,s)=>{const n=(e=>e===e.toLocaleLowerCase())(e.charAt(t))?s.toLocaleLowerCase():s.toLocaleUpperCase();return ae(e,t,n)},replaceCharAt:ae,insertAt:(e,t,s)=>[e.substr(0,t),s,e.substr(t)].join(""),replaceWith:(e,t,s)=>{const n=e.indexOf(t);return[e.substr(0,n),s,e.substr(n+t.length)].join("")},reverse:e=>{return e.split("").reverse().join("")},keymap:{1:["2","q"],2:["1","q","w","3"],3:["2","w","e","4"],4:["3","e","r","5"],5:["4","r","t","6"],6:["5","t","y","z","7"],7:["6","y","z","u","8"],8:["7","u","i","9"],9:["8","i","o","0"],0:["9","o","p"],q:["1","2","w","a"],w:["q","a","s","e","3","2"],e:["w","s","d","r","4","3"],r:["e","d","f","t","5","4"],t:["r","f","g","y","z","6","5"],y:["t","g","h","u","7","6","x","s","a"],u:["y","z","h","j","i","8","7"],i:["u","j","k","o","9","8"],o:["i","k","l","p","0","9"],p:["o","l","0"],a:["y","z","s","w","q"],s:["a","y","z","x","d","e","w"],d:["s","x","c","f","r","e"],f:["d","c","v","g","t","r"],g:["f","v","b","h","y","z","t"],h:["g","b","n","j","u","y","z"],j:["h","n","m","k","i","u"],k:["j","m","l","o","i"],l:["k","p","o"],z:["x","s","a","t","g","h","u","7","6"],x:["y","z","c","d","s"],c:["x","v","f","d"],v:["c","b","g","f"],b:["v","n","h","g"],n:["b","m","j","h"],m:["n","k","j"],"ö":["l","p","ü","ä","-","."],"ä":["-","ö","ü","+","#"],"ü":["p","ö","ä","+","´","ß"],"ß":["ü","p","0"]},normalizeNumberOfResult:(e,t=3)=>{if(e.length<=t)return e;const s=[],n=(e.length-t)/t/2;for(let a=0;a<t;a++)s.push(e[Math.round(n+a*(e.length/t))]);return s},isModifiableWord:(e,t)=>{const s=((e,t)=>{const s=se(e).sort((e,t)=>t.length-e.length);for(let n=0;n<s.length;n++){const a=s[n];let r=0;do{if((r=e.indexOf(a,r))>=0){if(r<=t&&t<r+a.length)return a;r++}}while(r>=0)}return null})(e,t);return!!s&&!re(s)}};const{normalizeNumberOfResult:ie,isModifiableWord:ce}=oe;var de={execute:e=>{let t=[""];const s=e.toLocaleLowerCase();for(let n=0;n<e.length;n++){const a=e.charAt(n)!==s.charAt(n)&&ce(e,n);a&&(t=t.concat(t));for(let r=0;r<t.length;r++){const o=a&&r<t.length/2;t[r]=t[r].concat(o?s.charAt(n):e.charAt(n))}}return t=t.slice(1),ie(t)},metadata:{id:"Case sensitivity"}};const{normalizeNumberOfResult:ue}=oe;var le={execute:e=>{const t=e.split(/(?<! ) (?! )/);let s=[t[0]];for(let e=1;e<t.length;e++){s=s.concat(s);for(let n=0;n<s.length;n++)s[n]=s[n]+(n<s.length/2?" ":"  "),s[n]=s[n]+t[e]}return s=s.slice(1),ue(s)},metadata:{id:"Duplicate space"}},pe={execute:e=>[e+" :)"],metadata:{id:"Emojis"}};const{normalizeNumberOfResult:he}=oe;var Se=[de,le,pe,{execute:e=>{let t=[""];const s=e.replace(/(.) /g,"$1\n");for(let n=0;n<e.length;n++){e.charAt(n)!==s.charAt(n)&&(t=t.concat(t));for(let a=0;a<t.length;a++)t[a]=t[a].concat(a<t.length/2?e.charAt(n):s.charAt(n))}return t=t.slice(1),he(t)},metadata:{id:"Enter instead of space"}},{execute:e=>[e.replace(" ,"," ").replace(", "," ").replace(","," ")],metadata:{id:"Missing punctuation mark"}}];const{getLongestToken:me,insertAt:fe,replaceWith:Te}=oe;const ge=e=>{const t=[];let s=e;return[2,e.length-2].forEach(n=>{t.push(fe(e,n,e[n])),s=fe(s,n,s[n])}),t.push(s),t};var be={execute:e=>{const t=[],s=me(e);return s.length<5?t:(ge(s).forEach(n=>{t.push(Te(e,s,n))}),t)},metadata:{id:"Double character"}};const{getLongestToken:ye,replaceWith:Ee,reverse:we}=oe;const Ce=e=>{const t=new Set([e]);return[1,2].forEach(s=>{let n=s,a=!1;do{const s=e.substr(n,3),r=Ee(e,s,we(s));t.has(r)||(t.add(r),a=!0),++n>=e.length-2&&(a=!0)}while(!a)}),t.delete(e),t};var ve={execute:e=>{const t=[],s=ye(e);return s.length<7?t:(Ce(s).forEach(n=>{t.push(Ee(e,s,n))}),t)},metadata:{id:"Duplicate space"}};const{tokenize:Ie,replaceWith:Oe}=oe,Re=["Aale, Ahle","Ai, Ei","Annalen, analen","aß, Aas","Bad, bat","bald, ballt","Bällen, bellen","Band, bannt","Beete, bete","bis, Biss","Block, Blog","Boot, bot","Boote, Bote","Bug, buk","Bund, bunt","Chor, Korps","Code, Kot","das, dass","dehnen, denen","erhält, erhellt","Fähre, faire","Fälle, Felle","fällt, Feld","Färse, Ferse, Verse","fast, fasst","fetter, Vetter","fiel, viel","fließt, fliehst, fliest","frisst, Frist","Fühler, Phyla","Geld, gellt","Gewand, gewandt","Grad, Grat","Graf, Graph","Halt, hallt","hallte, halte","hält, Held, hellt","Hämmer, Hemmer","hängst, Hengst","harrt, hart","hasst, hast","Häute, heute","Heer, hehr, her","Hemd, hemmt","hohl, hol","Hund, Hunt","isst, ist","kannte, Kante","konnten, Konten","Kuh, Coup","küsste, Küste","Laib, Leib","Laie, Leihe","laichen, Leichen","lasst, Last","läuten, Leuten","Lärche, Lerche","Leere, Lehre","leeren, lehren","Leerstelle, Lehrstelle","Leid, leiht","Lid, Lied","lies, ließ","liest, least","Mahl, Mal","Mähre, Märe, Meere","mahlen, malen","man, Mann","Märkte, merkte","Meer, mehr","Miene, Mine","misst, Mist","Mohr, Moor","mühten, Mythen","Mund, Munt","Nachnahme, Nachname","nahmen, Namen","packt, Pakt","pisste, Piste","rächen, Rechen","rächt, Recht","Rad, Rat","Rain, rein","Rede, Reede","Reis, reiß","reist, reißt","ruhte, Rute, Route","säen, sähen","Sämann, Seemann","Sätzen, setzen","Saite, Seite","seid, seit","schafft, Schaft","schallten, schalten","Schänke, schenke","schellte, Schelte","Schlächter, schlechter","Schlämme, schlemme","Schwälle, Schwelle","Schwämme, Schwemme","Seen, sehen","seid, seiht, seit","sie, sieh","Siegel, Sigel","Sohle, Sole","Sold, sollt","späht, spät","Stadt, statt","Städte, Stätte","Ställe, Stelle","starrt, Start","stehlen, Stelen","stiehl, Stiel, Stil","Tod, tot","Trend, trennt","Uhrzeit, Urzeit","Verband, verbannt","Verben, werben","verließ, Verlies","verwaist, verweist","Villen, Willen","Waage, vage","Waagen, wagen","Wahl, Wal","wahr, war","wahre, Ware","Waise, Weise","Wald, wallt","Wälle, Welle","Wände, Wende","Weck, weg","Wehr, wer","wehrt, Wert","weiht, weit","weis, weiß","weist, weißt","wieder, wider","wird, Wirt","Zunahme, Zuname","accept,except","acclamation,acclimation","acts,ax,axe","adolescence,adolescents","aeration,erration","aerie,airy","affect,effect","aid,aide","ail,ale","air,heir,err,ere","aisle,isle,I'll","all,awl","allowed,aloud","allude,elude","altar,alter","appose,oppose","arc,ark","are,our","ascent,assent","ate,eight","away,aweigh","aye,I,eye","bade,bayed","bail,bale","bait,bate","bald,bawled,balled","ball,bawl","band,banned","bard,barred","bare,bear","baron,barren","base,bass","based,baste","bazaar,bizarre","be,bee","beach,beech","bean,been","beat,beet","been,bin","beer,bier","bell,belle","berry,bury","berth,birth","better,bettor","bight,bite","billed,build","bird,burred","blew,blue","boar,bore,boor","board,bored","boarder,border","bode,bowed","bold,bowled","bolder,boulder,bowlder","bole,bowl","boos,booze","bough,bow","boy,buoy","braid,brayed","braise,braze,brays,braize","brake,break","breach,breech","bread,bred","brewed,brood","brews,bruise","bridal,bridle","burro,burrow","bus,buss","bused,bust","but,butt","buy,bye,by","cache,cash","callous,callus","can't,cant","cannon,canon","canter,cantor","carat,carrot,caret","caries,carries","cast,caste","cede,seed","cell,sell","cellar,seller","censor,sensor","cent,sent,scent","cents,sense,scents","cereal,serial","cession,session","chaise,chase","chalk,chock","chance,chants","chased,chaste","cheap,cheep","chews,choose","chic,sheik","choir,quire","chord,cored,cord","chute,shoot","cite,site,sight","clause,claws","click,clique","close,clothes","coal,cole","coaled,cold","coarse,course","coated,coded","cocks,cox","complement,compliment","contingence,contingents","coo,coup","coop,coupe","correspondence,correspondents","cosign,cosine","council,counsel","councilor,counselor","creak,creek","crewed,crude","crews,cruise","cue,queue","currant,current","curser,cursor","dam,damn","Dane,deign","days,daze","dear,deer","dense,dents","dependence,dependents","dew,due,do","die,dye","dire,dyer","discreet,discrete","doe,dough","does,doze,doughs","done,dun","dual,duel","ducked,duct","earn,urn","either,ether","emigrant,immigrant","eutopia,utopia","ewe,you,yew","eyed,I'd","fain,feign","faint,feint","fair,fare","fairy,ferry","fate,fete","faze,phase","feat,feet","feudal,futile","find,fined","finish,Finnish","fir,fur","flair,flare","flea,flee","flecks,flex","flew,flue","flour,flower","foaled,fold","for,four,fore","forego,forgo","foreword,forward","forth,fourth","foul,fowl","frees,frieze,freeze","friar,fryer","gage,gauge","gait,gate","gel,jell","gene,jean","gild,guild","gneiss,nice","gored,gourd","grade,grayed,greyed","grate,great","grays,greys,graze","grisly,grizzly","groan,grown","guessed,guest","guide,guyed","guise,guys","hail,hale","hair,hare","hairy,harry","hall,haul","halve,have","hangar,hanger","hay,hey","hays,haze","he'd,heed","he'll,heel,heal","hear,here","heard,herd","heated,heeded","hew,hue","hi,high","higher,hire","him,hymn","ho,hoe","hoar,whore","hoard,horde","hoarse,horse","hoes,hose","hold,holed","hole,whole","holey,wholly,holy","hostel,hostile","hour,our","idle,idol","immanent,imminent","in,inn","incidence,incidents","incite,insight","instance,instants","intense,intents","intension,intention","it's,its","jam,jamb","knave,nave","knead,need,kneed","knew,new","knight,night","knit,nit","knot,not,naught","know,no","knows,nose","lacks,lax","lade,laid","lain,lane","lair,layer","lam,lamb","laps,lapse","lay,lei","lays,laze","leach,leech","lead,led","leak,leek","lean,lien","leased,least","lends,lens","lessen,lesson","lesser,lessor","let's,lets","levee,levy","liar,lyre","lichen,liken","lickerish,licorice","lie,lye","links,lynx","lo,low","load,lode","loan,lone","loch,lock","locks,lox","loop,loupe","loos,lose","lose,loose","made,maid","mail,male","main,mane","maize,maze,Mays","mall,maul","manner,manor","marshal,martial","massed,mast","mat,matte","mean,mien","meat,mete,meet","medal,mettle,meddle,metal","might,mite","mince,mints","mind,mined","miner,minor","missed,mist","moat,mote","mood,mooed","moor,more","morning,mourning","muscle,mussel","mussed,must","naval,navel","nay,neigh","nicks,nix","none,nun","oar,ore,or","ode,owed","oh,owe","once,wants","one,won","oohs,ooze","overseas,oversees","paced,paste","packed,pact","pail,pale","pain,pane","pair,pear,pare","palate,pallet,palette","parish,perish","passed,past","patience,patients","pause,paws","peace,piece","peak,pique,peek","peal,peel","pearl,purl","pedal,petal,peddle","peer,pier","penance,pennants","per,purr","pi,pie","plain,plane","plainer,planer,planar","plait,plate","pleas,please","pole,poll","poor,pour,pore","populace,populous","praise,preys,prays","pray,prey","precedence,precedents","premier,premiere","presence,presents","pride,pried","prier,prior","pries,prize","prince,prints","principal,principle","profit,prophet","rack,wrack","raid,rayed","rail,rale","rain,rein,reign","raise,raze,rays","rap,wrap","rapt,wrapped,wrapt","re-cover,recover","re-lay,relay","read,red","read,reed","real,reel","recede,reseed","reek,wreak","residence,residents","rest,wrest","retch,wretch","rhyme,rime","right,write,rite,wright","ring,wring","ringer,wringer","rise,ryes","road,rowed,rode","roe,row","roil,royal","role,roll","roomer,rumor,rumour","root,route","rose,rows","rote,wrote","rude,rued","rues,ruse","rung,wrung","rye,wry","sail,sale","scene,seen","sea,see","seam,seem","sear,seer","seas,seize,sees","sects,sex","sew,sow,so","shake,sheik","shear,sheer","shoe,shoo","sic,sick","sics,six","side,sighed","sighs,size","sign,sine","slay,sleigh","sleight,slight","slew,slough","soar,sore","soared,sword","sold,soled","sole,soul","some,sum","son,sun","stair,stare","stake,steak","steal,steel","step,steppe","storey,story","straight,strait","suite,sweet","tacked,tact","tacks,tax","tail,tale","taper,tapir","tarry,terry","taught,taut","tea,tee","team,teem","tears,tiers","teas,tees,tease","tense,tents","than,then","there,they're,their","threw,through","throne,thrown","thyme,time","tide,tied","tier,tire","tighten,titan","to,two,too","toad,towed,toed","toe,tow","told,tolled","tracked,tract","tray,trey","udder,utter","vain,vein,vane","vale,veil","vial,vile","vice,vise","wade,weighed","wail,whale","waist,waste","wait,weight","waive,wave","waiver,waver","wale,whale","war,wore","ward,warred","ware,where,wear","warn,worn","wax,whacks","way,whey,weigh","we,wee","we'd,weed","we'll,wheel,weal,wheal","we're,weir,were","we're,whir","we've,weave","weak,week","wearer,where're","weather,whether","wet,whet","wheeled,wield","which,witch","while,wile","whiled,wild","whine,wine","whined,wined,wind","whirled,world","whit,wit","whither,wither","who's,whose","whoa,woe","wood,would","yack,yak","yaw,your,yore,you're","yoke,yolk","yore,your,you're","you'll,Yule","aahed,odd","adieu,ado","ant,aunt","aural,oral","marry,merry","rout,route","seated,seeded","shone,shown","tidal,title","trader,traitor","vary and very"];let Ne;const Pe=()=>{if(Ne)return Ne;const e=Re.map(function(e){return e.toLocaleLowerCase().trim().split(",")});return Ne=[],e.forEach(function(e){e.forEach(function(t){Ne[t]=e.filter(e=>e!==t)})}),Ne},Ae=e=>{const t=Pe();if((e=e.toLocaleLowerCase())in t)return t[e][0]};var $e={execute:e=>{const t=Ie(e);let s=e;return t.forEach(e=>{const t=Ae(e);t&&(s=Oe(s,e,t))}),s!==e?[s]:[]},metadata:{id:"Homophones"}};const{getLongestToken:xe,replaceCharAtCaseSensitive:De,replaceWith:_e,keymap:ke}=oe;const je=e=>{const t=[];return[2,e.length-2].forEach(s=>{const n=e[s].toLocaleLowerCase();if(n in ke){const a=ke[n];[a[0],a[a.length-1]].forEach(n=>{t.push(De(e,s,n))})}}),t};var Me={execute:e=>{const t=[],s=xe(e);return s.length<5?t:(je(s).forEach(n=>{t.push(_e(e,s,n))}),t)},metadata:{id:"Mishit"}};const{getLongestToken:qe,replaceCharAtCaseSensitive:Be,replaceWith:Le}=oe;const Fe=e=>{const t=[];return[2,e.length-2].forEach(s=>{t.push(Be(e,s,""))}),t};var Je={execute:e=>{const t=[],s=qe(e);return s.length<5?t:(Fe(s).forEach(n=>{t.push(Le(e,s,n))}),t)},metadata:{id:"Missing character"}};const{getLongestToken:Ue,replaceWith:Ge,reverse:Ve}=oe;const He=e=>{const t=new Set([e]);return[2,e.length-2].forEach(s=>{let n=s,a=!1;do{const s=e.substr(n,2),r=Ge(e,s,Ve(s));t.has(r)||(t.add(r),a=!0),++n>=e.length-2&&(a=!0)}while(!a)}),t.delete(e),t};var Ye={execute:e=>{const t=[],s=Ue(e);return s.length<5?t:(He(s).forEach(n=>{t.push(Ge(e,s,n))}),t)},metadata:{id:"Mixing character"}};const{replaceCharAt:Xe}=oe,ze={z:"y",Z:"Y",y:"z",Y:"Z"};var We={execute:e=>{let t=e;for(let e=0;e<t.length;e++){const s=t.charAt(e);s in ze&&(t=Xe(t,e,ze[s]))}return t===e?[]:[t]},metadata:{id:"qwertz vs qwerty keyboard"}};const{getLongestToken:Ke,replaceCharAtCaseSensitive:Qe,replaceWith:Ze,keymap:et}=oe;const tt=e=>{const t=[],s=Math.round(e.length/2),n=e[s].toLocaleLowerCase();if(n in et){const a=et[n];[a[0],a[a.length-1]].forEach(n=>{t.push(Qe(e,s,e[s]+n))})}return t};var st={execute:e=>{const t=[],s=Ke(e);return s.length<5?t:(tt(s).forEach(n=>{t.push(Ze(e,s,n))}),t)},metadata:{id:"Sausage fingers"}};const{getLongestToken:nt,replaceWith:at}=oe;const rt=e=>{const t=new Set([e]);return[1,2].forEach(s=>{let n=s,a=!1;do{const s=e.substr(n,3).split("");let r=Array.from(s);r.push(r[0]),r.shift();const o=at(e,s.join(""),r.join(""));t.has(o)||(t.add(o),a=!0),++n>=e.length-2&&(a=!0)}while(!a)}),t.delete(e),t};var ot=[be,ve,$e,Me,Je,Ye,We,st,{execute:e=>{const t=[],s=nt(e);return s.length<7?t:(rt(s).forEach(n=>{t.push(at(e,s,n))}),t)},metadata:{id:"Shift characters"}}];const it=Se.concat(ot),ct={};it.forEach(e=>{ct[e.metadata.id]=e});const dt={};Se.forEach(e=>{dt[e.metadata.id]="habits"}),ot.forEach(e=>{dt[e.metadata.id]="typo"});var ut={GetMutatorById:e=>{if(!(e in dt))throw Error(`Unknown ID: ${e}`);return ct[e]},allMutatorNames:Object.keys(ct),pipelineAllMutatorCombined:[[Se,ot],[Se],[ot]],pipelineAllMutatorNotCombined:[[Se],[ot]]};const{pipelineAllMutatorCombined:lt,pipelineAllMutatorNotCombined:pt,GetMutatorById:ht,allMutatorNames:St}=ut;const mt=(e,t)=>{let s=new Set;for(const n of t){let t=[e];for(const e of n){let s=[];for(const n of e)for(const e of t)s=s.concat(n.execute(e));t=s}for(const e of t)s.has(e)?console.log("duplicate utterance : <"+e+"> created by "+JSON.stringify(n,2)):s.add(e)}return[...s]};const ft=e=>{if(!e.humanifiersToExecute||!e.humanifiersToExecute.length)return[[pt]];return[[(e=>e.map(e=>ht(e)))(e.humanifiersToExecute)]]};var Tt={pipelineAllMutatorCombined:lt,pipelineAllMutatorNotCombined:pt,allHumanifiers:St,Execute:(e,t)=>{const s=ft(t);return mt(e,s)},ExecutePipeline:mt};const gt=M("botium-box-clone-testset"),{BotDriver:bt,Capabilities:yt}=i,{RetrieveTestSetDetails:Et}=W,{combineScriptingCapabilities:wt}=Q;const Ct=(e,t)=>{const s={all:e.utterances,me:new Set,bot:new Set,both:null,neither:null,toHumanify:{},allUtteranceCount:0,utterancesToHumanifyCount:0};s.neither=new Set(Object.keys(s.all)),e.convos.forEach(e=>{e.conversation.forEach(e=>{e.messageText&&e.messageText in s.all&&(s[e.sender].add(e.messageText),s.neither.delete(e.messageText))})});const n=q.uniq(Array.from(s.me)).filter(e=>s.bot.has(e));s.both=new Set(n);const a={};let r=0,o=0;return t.humanifiersToExecute&&t.humanifiersToExecute.length&&[...s.me,...n,...s.neither].forEach(e=>{o+=s.all[e].utterances.length;let n=Math.round(o*t.percentToHumanify-r);0===r&&0===n&&(n=1),a[e]=n,r+=n}),s.toHumanify=a,s.allUtteranceCount=o,s.utterancesToHumanifyCount=r,s},vt=(e,t,s)=>{t.both.forEach(s=>{if(t.toHumanify[s]){let t=s+"_JUST_BOT";if(t in e.utterances)throw new Error(`There is already an utterance ${t} in the testset!`)}});const n={humanifiedRefs:[],humanifiedRefCount:0,humanifiedUtterancesCount:0,duplicates:0};t.both.forEach(s=>{t.toHumanify[s]&&(e.utterances[s+"_JUST_BOT"]=q.cloneDeep(e.utterances[s]))});Object.keys(t.toHumanify).forEach(a=>{if(t.toHumanify[a]){const r=(n=>{e.utterances[n].utterances=q.uniq(e.utterances[n].utterances);const a=t.toHumanify[n],r=e.utterances[n].utterances;let o=0;for(let t=0;t<a;t++){const a=Tt.Execute(r[t],{humanifiersToExecute:s.humanifiersToExecute});e.utterances[n].utterances=e.utterances[n].utterances.concat(a),o+=a.length}let i=e.utterances[n].utterances.length;return e.utterances[n].utterances=q.uniq(e.utterances[n].utterances),{humanifiedRefCount:a,humanifiedUtterancesCount:o,duplicates:i-e.utterances[n].length}})(a);n.humanifiedRefs.push(a),n.humanifiedRefCount+=r.humanifiedRefCount,n.humanifiedUtterancesCount+=r.humanifiedUtterancesCount,n.duplicates+=r.duplicates}});const a=[];return e.convos.forEach(e=>{((e,t)=>(e.conversation.forEach(e=>{if(e.messageText&&t.both.has(e.messageText))return!0}),!1))(e,t)}),e.convos=e.convos.concat(a),n.clonedConvoCount=a.length,n};var It={possibleOptions:{humanifiers:Tt.allHumanifiers},CloneTestset:async(e,t)=>{const s=wt([e]),n=new bt(s).BuildCompiler(),a=T.join(process.env.BOTIUM_TEMPDIR,`${j(e.name)}_CLONED_${E("Aa0",5)}`);r.sync(a),await ee(Et(e),n),o(a,e=>{e&&gt(`Failed rimraf ${a}: ${e}`)});const i={},c=Ct(n,t);return i.utterances={all:Object.keys(c.all).length,me:c.me.size,bot:c.bot.size,both:c.both.size,neither:c.neither.size,toHumanify:Object.values(c.toHumanify).filter(e=>e).length,allUtteranceCount:c.allUtteranceCount,utterancesToHumanifyCount:c.utterancesToHumanifyCount},i.process=vt(n,c,t),gt(`Cloning finished: ${JSON.stringify(i)}`),n},ExportTestsetToFolder:async(e,t)=>{const s=T.join(process.env.TESTSETDIR,`${j(t)}_${E("Aa0",5)}`);r.sync(s);const a=e.caps[yt.SCRIPTING_TXT_EOL],o=Object.keys(e.utterances);for(let t=0;t<o.length;t++){let n=[o[t]].concat(e.utterances[o[t]].utterances).join(a);f.writeFileSync(T.join(s,`${o[t]}.utterances.txt`),n)}const i=e.GetCompiler(n.SCRIPTING_FORMAT_TXT);return e.convos&&e.convos.forEach((e,t)=>{let n=i.Decompile([e]);f.writeFileSync(T.join(s,`c${t}_${j(e.header.name)}.convo.txt`),n)}),e.partialConvos&&Object.values(e.partialConvos).forEach((e,t)=>{let n=i.Decompile([e]);f.writeFileSync(T.join(s,`p_${j(e.header.name)}.pconvo.txt`),n)}),s},ExportTestsetToLocalRepository:async e=>{const t=[],s=e.caps[yt.SCRIPTING_TXT_EOL],a=Object.keys(e.utterances);for(let n=0;n<a.length;n++){let r=[a[n]].concat(e.utterances[a[n]].utterances).join(s);t.push({name:a[n],script:r,scriptType:"SCRIPTING_TYPE_UTTERANCES"})}const r=e.GetCompiler(n.SCRIPTING_FORMAT_TXT);return e.convos&&e.convos.forEach((e,s)=>{let n=r.Decompile([e]);t.push({name:e.header.name,description:e.header.description,script:n,scriptType:"SCRIPTING_TYPE_CONVO"})}),e.partialConvos&&Object.values(e.partialConvos).forEach((e,s)=>{let n=r.Decompile([e]);t.push({name:e.header.name,description:e.header.description,script:n,scriptType:"SCRIPTING_TYPE_PCONVO"})}),t}};const{BotDriver:Ot}=i,{FindFullTestSet:Rt,RetrieveTestSetDetails:Nt}=W,Pt=M("botium-box-mutate-testset");var At={createTestSet:async(e,{testSet:t},s,n)=>s.db.mutation.createTestSet({data:t},n),async updateTestSet(e,{id:t,testSet:s},n,a){if(!await n.db.exists.TestSet({id:t}))throw new Error(`TestSet not found ${t}`);return n.db.mutation.updateTestSet({where:{id:t},data:s},a)},deleteTestSet:async(e,{id:t},s)=>new Promise((e,n)=>{s.db.mutation.deleteTestSet({where:{id:t}},"{id}").then(()=>e(!0)).catch(e=>n(e))}),createTestSetScript:async(e,{testSetScript:t},s,n)=>s.db.mutation.createTestSetScript({data:t},n),async updateTestSetScript(e,{id:t,testSetScript:s},n,a){if(!await n.db.exists.TestSetScript({id:t}))throw new Error(`TestSetScript not found ${t}`);return n.db.mutation.updateTestSetScript({where:{id:t},data:s},a)},deleteTestSetScript:async(e,{id:t},s)=>new Promise((e,n)=>{s.db.mutation.deleteTestSetScript({where:{id:t}},"{id}").then(()=>e(!0)).catch(e=>n(e))}),async createTestSetRepository(e,{testSetRepository:t},s,n){},async updateTestSetRepository(e,{id:t,testSetRepository:s},n,a){},async deleteTestSetRepository(e,{id:t},s){},createTestSetFolder:async(e,{testSetFolder:t},s,n)=>s.db.mutation.createTestSetFolder({data:t},n),async updateTestSetFolder(e,{id:t,testSetFolder:s},n,a){if(!await n.db.exists.TestSetFolder({id:t}))throw new Error(`TestSetFolder not found ${t}`);return n.db.mutation.updateTestSetFolder({where:{id:t},data:s},a)},deleteTestSetFolder:async(e,{id:t},s)=>new Promise((e,n)=>{s.db.mutation.deleteTestSetFolder({where:{id:t}},"{id}").then(()=>e(!0)).catch(e=>n(e))}),createTestSetExcel:async(e,{testSetExcel:t},s,n)=>s.db.mutation.createTestSetExcel({data:t},n),async updateTestSetExcel(e,{id:t,testSetExcel:s},n,a){if(!await n.db.exists.TestSetExcel({id:t}))throw new Error(`TestSetExcel not found ${t}`);return n.db.mutation.updateTestSetExcel({where:{id:t},data:s},a)},deleteTestSetExcel:async(e,{id:t},s)=>new Promise((e,n)=>{s.db.mutation.deleteTestSetExcel({where:{id:t}},"{id}").then(()=>e(!0)).catch(e=>n(e))}),async cloneTestSet(e,{id:t,options:s},n,a){const r=await Rt(n.db,t);if(!r)throw new Error(`TestSet not found ${t}`);const o=await It.CloneTestset(r,s),i=[`Cloned from "${r.name}"`];s.humanifiersToExecute&&s.humanifiersToExecute.length>0&&(i.push(`Humanifiers "${s.humanifiersToExecute.join(", ")}"`),i.push(`Percentage ${100*s.percentToHumanify}%`));const c={data:{...r,name:s.name,client:r.client&&{connect:{id:r.client.id}}||null,description:i.join(", "),tags:{set:r.tags?[...r.tags,"Cloned"]:["Cloned"]},folders:{},repositories:{},scripts:[],excels:{}}};if("FOLDER"===s.output){const e=await It.ExportTestsetToFolder(o,s.name);c.data.folders.create=[{name:"Test Set Scripts",path:T.resolve(e)}]}else if("LOCAL"===s.output){const e=await It.ExportTestsetToLocalRepository(o);c.data.scripts.create=e}return delete c.data.id,n.db.mutation.createTestSet(c,a)},exportTestSetToGit:async(e,{id:t,options:s},n,a)=>!0,async exportTestSetToFolder(e,{id:t,options:s},n,a){const o=await Rt(n.db,t);if(!o)throw new Error(`TestSet not found ${t}`);const i=o.folders&&o.folders.find(e=>e.id===s.id);if(!i)throw new Error(`Folder ${s.id} not found in Test Set ${t}`);let c=i.path;s.subdirectory&&(c=T.join(c,s.subdirectory));try{r.sync(c),Pt(`Created output directory ${c}`)}catch(e){throw new Error(`Failed to create output directory ${c}: ${e}`)}const d=(e,t)=>{try{f.writeFileSync(T.join(c,e),t),Pt(`Wrote file ${e} to output directory ${c}`)}catch(t){throw new Error(`Failed to write file ${e} to output directory ${c}: ${t}`)}};return o.scripts&&o.scripts.forEach(e=>{"SCRIPTING_TYPE_CONVO"===e.scriptType&&d(`${j(e.name)}.convo.txt`,e.script),"SCRIPTING_TYPE_PCONVO"===e.scriptType&&d(`${j(e.name)}.pconvo.txt`,e.script),"SCRIPTING_TYPE_UTTERANCES"===e.scriptType&&d(`${j(e.name)}.utterances.txt`,e.script),"SCRIPTING_TYPE_SCRIPTING_MEMORY"===e.scriptType&&d(`${j(e.name)}.scriptingmemory.txt`,e.script)}),o.excels&&o.excels.forEach(e=>{const t=Buffer.from(e.filecontent,"base64");d(`${j(e.name)}.xlsx`,t)}),!0},async updateTestSetStats(e,{id:t},s,n){const a=await Rt(s.db,t);if(!a)throw new Error(`TestSet not found ${t}`);const i=(new Ot).BuildCompiler(),c=T.join(process.env.BOTIUM_TEMPDIR,`${j(a.name)}_STATS_${E("Aa0",5)}`);r.sync(c);const d=Nt(a);try{await ee(d,i);const e=i.convos&&i.convos.map(e=>({name:e.header.name,order:e.header.order,description:e.header.description,sourceTag:JSON.stringify(e.sourceTag),stepCount:e.conversation&&e.conversation.length||0}))||[],a=i.partialConvos&&Object.values(i.partialConvos).map(e=>({name:e.header.name,description:e.header.description,sourceTag:JSON.stringify(e.sourceTag),stepCount:e.conversation&&e.conversation.length||0}))||[],r=e.length,u=a.length,l=Object.keys(i.utterances).reduce((e,t)=>e+i.utterances[t].utterances.length,0),p=i.scriptingMemories.length,h=await s.db.query.testSet({where:{id:t}},"{ statsCompiledConvos { id } }");return await s.db.mutation.updateTestSet({where:{id:t},data:{statsUpdatedAt:new Date,statsConvoCount:r||0,statsPartialConvoCount:u||0,statsUtterancesCount:l||0,statsScriptingMemoryCount:p||0,statsCompiledConvos:{create:e.concat(a),deleteMany:{id_in:h.statsCompiledConvos&&h.statsCompiledConvos.map(e=>e.id)||[]}}}},n)}finally{o(c,e=>{e&&Pt(`Failed rimraf ${c}: ${e}`)})}}};const{updateTestSetStats:$t}=At,xt=M("botium-box-testset-scanner"),Dt=(e,t)=>process.env.TESTSETDIR_PUBLIC?T.resolve(process.env.TESTSETDIR_PUBLIC,t):T.resolve(e,t),_t=(e,t)=>f.readdirSync(e).reduce((s,n)=>{const a=T.join(e,n);return t(a)&&s.push(n),s},[]),kt=async(e,t,s)=>{const n=T.join(t,s);xt(`scanDirForTestSets scanning ${n} ...`);const a=(e=>_t(e,e=>f.statSync(e).isDirectory()))(n),r=(e=>_t(e,e=>f.statSync(e).isFile()))(n);if(a&&a.length>0)await a.forEach(async n=>{const a=Dt(t,T.join(s,n));await(async(e,t)=>{let s=await e.query.testSetFolders({where:{path:t}},"{ id name testSet { id name } }");return s&&0!==s.length||(s=await e.query.testSetFolders({where:{path:t+T.sep}},"{ id name testSet { id name } }")),!!(s&&s.length>0)&&(xt(`Folder ${t} already in use - ${s[0].name} in Test Set ${s[0].testSet.name}`),!0)})(e,a)||await kt(e,t,T.join(s,n))});else if(r&&r.length>0){const a={data:{name:s.split(T.sep).join("/"),description:`Imported from directory ${n}, ${r.length} files`,expandConvos:!0,expandUtterancesToConvos:!0,expandScriptingMemory:!1,tags:{set:s.split(T.sep)},folders:{create:[{name:s,path:Dt(t,s)}]}}};try{const t=await e.mutation.createTestSet(a,"{ id }");xt(`scanDirForTestSets ${s} Imported Test Set ${t.id} with ${r.length} files`),await $t(void 0,{id:t.id},{db:e}),xt(`scanDirForTestSets ${s} Updated Test Set Stats ${t.id}`)}catch(e){xt(`scanDirForTestSets ${s} Failed to create ${a.data}: ${e}`)}}};var jt=e=>{(async()=>{kt(e,process.env.TESTSETDIR,".")})().catch(e=>{xt(`scanForTestSets failed: ${e}`)})};const Mt=M("botium-box-server-livechat"),qt=i.BotDriver,Bt=process.env.BOTIUMBOX_LIVECHAT_IDLE_TIMEOUT||3e5,Lt={},Ft={},Jt=({conversationId:e,queueSettings:t,pubsub:s})=>{Ft[e]&&clearTimeout(Ft[e]),Ft[e]=setTimeout(async()=>{const n=new d(t.redis);Mt(`Auto cleanup of conversation ${e} after ${Bt}ms idle time`),Ut(e),await n.del(e),s.publish(e,{liveChatConvoStepAdded:{err:`Automatically closed chatbot connection after ${Bt}ms idle time`}})},Bt)},Ut=async e=>{Ft[e]&&clearTimeout(Ft[e]),delete Ft[e];const t=Lt[e];if(t){try{await t.Stop()}catch(t){Mt(`stopConversation(${e}) Stop failed: ${t}`)}try{await t.Clean()}catch(t){Mt(`stopConversation(${e}) Clean failed: ${t}`)}Mt(`stopConversation(${e}) container stopped.`),delete Lt[e]}},Gt=async({conversationId:e},{queueSettings:t})=>{const s=new d(t.redis),n=await s.get(e);return n&&JSON.parse(n)},Vt=async(e,t,s)=>{await s.set(e,JSON.stringify(t)),await s.expire(e,Bt/1e3);const n=await s.ttl(e);Mt(`updateConversation(${e}) TTL(seconds): ${n}`)};var Ht={startListeners:async({db:e,pubsub:t,queueSettings:s})=>new Promise((e,n)=>{const a=new d(s.redis);a.subscribe("livechat.send","livechat.stop",(t,s)=>{t?n(new Error(`Redis subscribe failed: ${t}`)):(Mt(`Livechat Redis connected to ${s} channels.`),e())}),a.on("message",async(e,s)=>{const{conversationId:n,convoStep:a}=JSON.parse(s);if(!Lt[n])return;const r=Lt[n];if("livechat.send"===e){Mt(`liveChatSendToBot(${n}) sending convoStep ${a}`);try{await r.UserSays(a)}catch(e){Mt(`liveChatSendToBot UserSays failed: ${e}`),t.publish(n,{liveChatConvoStepAdded:{err:`${e}`}})}}else"livechat.stop"===e&&Ut(n)})}),startBot:async({caps:e},{pubsub:t,queueSettings:s})=>{const n=new d(s.redis),a=c(),r=new qt(e);var o=new u(async(e,r)=>{try{const r=await Gt({conversationId:a},{queueSettings:s}),o=r.length,i=JSON.stringify(Object.assign(e,{convoStepIndex:o}));t.publish(a,{liveChatConvoStepAdded:{convoStep:i}}),r.push(i),Vt(a,r,n),Jt({conversationId:a,queueSettings:s,pubsub:t})}catch(e){Mt(`listenerQueue err: ${e}`)}r()});r.on("MESSAGE_SENTTOBOT",(e,t)=>o.push(t)),r.on("MESSAGE_RECEIVEDFROMBOT",(e,t)=>o.push(t));const i=await r.Build();return Lt[a]=i,Mt(`liveChatStartBot(${a}) container built, now starting`),await i.Start(),Mt(`liveChatStartBot(${a}) container started.`),Vt(a,[],n),Jt({conversationId:a,queueSettings:s,pubsub:t}),a},sendToBot:async({conversationId:e,convoStep:t},{queueSettings:s})=>{new d(s.redis).publish("livechat.send",JSON.stringify({conversationId:e,convoStep:t}))},stopBot:async({conversationId:e},{queueSettings:t})=>{new d(t.redis).publish("livechat.stop",JSON.stringify({conversationId:e}))},getConversation:Gt,getConversationScript:async({caps:e,conversationId:t,testCaseName:s},{queueSettings:n})=>{const a=await Gt({conversationId:t},{queueSettings:n});if(!q.isArray(a))throw new Error("Conversation not available (anymore).");const r=new qt(e).BuildCompiler(),o={header:{name:s},conversation:a.map(e=>(e=>(e.asserters||(e.asserters=[]),e.nlp&&(e.nlp.intent&&e.asserters.push({name:"INTENT",args:[e.nlp.intent.name]}),e.nlp.entities&&e.asserters.push({name:"ENTITIES",args:e.nlp.entities.map(e=>e.name)})),e))(JSON.parse(e)))},i=r.Decompile([o],"SCRIPTING_FORMAT_TXT");return Mt(`Decompiled script: ${i}`),i}};const Yt=M("botium-box-server-agents-performancetestsession"),Xt=(e,t)=>null===e?t:Math.min(e,t),zt=(e,t)=>null===e?t:Math.max(e,t),Wt=new u(async(e,t)=>{Yt(`progressProcessorQueue  starting with ${e.length} entries`);const s=async e=>{Yt(`progressProcessorQueue  update entry: ${O.inspect(e.data)}`),await e.ctx.db.mutation.updatePerformanceTestSessionJob({data:e.data,where:{id:e.performanceTestSessionJobId}})};let n=0;for(const t of e)t.data&&"RUNNING"===t.data.status&&(await s(t),n++);const a=e[0].ctx,r=q.uniq(e.filter(e=>e.dataRaw).map(e=>e.performanceTestSessionId));let o=null;const i=new Map;if(0!==r.length){Yt("progressProcessorQueue  aggregating");const t=e=>{if(!e.performanceTestSessionId)throw new Error("performanceTestSessionId is not set");if(!e.performanceTestSessionJobId)throw new Error("performanceTestSessionJobId is not set");if(!e.convo)throw new Error("convo is not set");const t={performanceTestSessionId:e.performanceTestSessionId,performanceTestSessionJobId:e.performanceTestSessionJobId,convo:e.convo,stepIndex:e.stepIndex?e.stepIndex:0};return JSON.stringify(t)},s=(e,t,s,n)=>{e<s&&Yt(`Bad state, ${s} (${s.getTime()}) should be after ${e} (${e.getTime()})!`);const a=(e,t,s,n)=>!(t<s||n<e);let r=0;const o=[];for(;;){let i=x(s).add(n,"ms").toDate();if(o.length>=1e3)return Yt("getSteps terminating at 1000 steps"),o;if(a(s,i,e,t))o.push(r);else if(o.length>0)return o;r++,s=i}},n=async()=>{const e=await a.db.query.performanceTestSessions({where:{id_in:r}}),t=new Map;for(const s of e)t.set(s.id,s);return t},c=await n();Yt(`progressProcessorQueue  affected sessions ${c.size}`);for(const n of e.filter(e=>e.dataRaw)){if(!c.has(n.performanceTestSessionId))throw new Error(`progressProcessorQueue PerformanceTestSession not found by ID ${n.performanceTestSessionId}`);const{dataDensity:e,createdAt:a}=c.get(n.performanceTestSessionId),r=(s,r,o)=>{const c=o?"wait":"exec",d=o?s.testBegin.getTime()-s.queueBegin.getTime():s.runtime,u=t({performanceTestSessionId:n.performanceTestSessionId,performanceTestSessionJobId:n.performanceTestSessionJobId,convo:n.dataRaw.convo,stepIndex:r});i.has(u)||i.set(u,{temporary:{performanceTestSessionJobId:n.performanceTestSessionJobId,firstStepAt:a},stepIndex:r,execCount:0,execDurationSum:0,execDurationMin:null,execDurationMax:null,waitCount:0,waitDurationSum:0,waitDurationMin:null,waitDurationMax:null,stepStartAt:x(a).add(e*r,"ms").toDate()});const l=i.get(u);l[c+"Count"]++,l[c+"DurationSum"]+=d,l[c+"DurationMin"]=Xt(l[c+"DurationMin"],d),l[c+"DurationMax"]=zt(l[c+"DurationMax"],d)},o=s(n.dataRaw.queueBegin,n.dataRaw.testBegin,a,e);for(const e of o)r(n.dataRaw,e,!0);const d=s(n.dataRaw.testBegin,n.dataRaw.testEnd,a,e);for(const e of d)r(n.dataRaw,e,!1)}Yt(`progressProcessorQueue  aggregated to ${i.size} records`);const d=new u(async(e,t)=>{Yt(`progressProcessorQueue  upserting ${e.length} records`);let s=0,n=0;for(const[t,r]of e){const{performanceTestSessionId:e,performanceTestSessionJobId:o,convo:i,stepIndex:c}=JSON.parse(t),d=await a.db.query.performanceTestSessionAggregatedResults({where:{AND:[{testSession:{id:e}},{job:{id:o}},{stepIndex:c},{convo:i}]}});if(d.length>1)throw new Error(`Expected result: 0 or 1. Found: ${d.length} by ${t}`);if(0===d.length){n++;const t=Object.assign([],r);delete t.temporary,await a.db.mutation.createPerformanceTestSessionAggregatedResult({data:{testSession:{connect:{id:e}},job:{connect:{id:o}},stepIndex:c,convo:i,...t}})}else{s++;const e=d[0],t=r;await a.db.mutation.updatePerformanceTestSessionAggregatedResult({data:{execCount:t.execCount+e.execCount,execDurationMin:Xt(t.execDurationMin,e.execDurationMin),execDurationMax:zt(t.execDurationMax,e.execDurationMax),execDurationSum:t.execDurationSum+e.execDurationSum,waitCount:t.waitCount+e.waitCount,waitDurationMin:Xt(t.waitDurationMin,e.waitDurationMin),waitDurationMax:zt(t.waitDurationMax,e.waitDurationMax),waitDurationSum:t.waitDurationSum+e.waitDurationSum},where:{id:e.id}})}}Yt(`progressProcessorQueue  upserted ${e.length} records, inserts ${n} updates: ${s}`),t()},{batchSize:100});for(const e of i.entries())d.push(e);o=new Promise(e=>{d.on("drain",()=>{e()})})}else Yt("No progress data found in batch");o&&await o;for(const t of e)t.data&&"READY"===t.data.status&&(await s(t),n++);Yt(`progressProcessorQueue  batch processed. Full size: ${e.length} stat entries: ${e.length-n} aggregated: ${i.size}`),t()},{batchSize:1e3,batchDelay:1e3});var Kt={startPerformanceTestSession:async(e,{performanceTestSessionId:t})=>{try{const s=await Q.findFullPerformanceTestSession(e.db,t);if(!s)throw new Error(`Performance Test Session ${t} not configured`);const n=s.agent?"performanceprocess.run."+s.agent.name:"performanceprocess.run";Yt(`startPerformanceTestSession ${s.id} queueToSend: ${n}`);const{testSessionCaps:a,testSessionSources:r,testSessionEnvs:o,testSessionTestSets:i}=await Q.extractTestSessionLike(e,s),c=async(t,a)=>{Yt(`startPerformanceTestSession ${s.id} creating ${s.parallelJobCount} jobs`);for(let i=0;i<s.parallelJobCount;i++){const c=await e.db.mutation.createPerformanceTestSessionJob({data:{status:"PENDING",testSession:{connect:{id:s.id}}}},"{ id }"),d=e.queueConnector.create(n,{title:`Processing Job #${i+1}/${s.parallelJobCount} for Performance Test Session ${s.name}`,performanceTestSessionId:s.id,performanceTestSessionName:s.name,performanceTestSessionJobId:c.id,botium:{Capabilities:t,Sources:r,Envs:o},testSets:a,parallelConvoCount:s.parallelConvoCount,parallelJobCount:s.parallelJobCount,tickRepeatInitial:s.tickRepeatInitial,tickRepeatPerTick:s.tickRepeatPerTick,tickMaxTime:s.tickMaxTime,tickTime:s.tickTime}).removeOnComplete(!0).save(t=>{if(t)return Yt(`Saving batchJob failed: ${t}`);const n=d.id;e.db.mutation.updatePerformanceTestSessionJob({data:{jobId:n},where:{id:c.id}}).then(()=>{Yt(`PerformanceTestSessionJob for PerformanceTestSession ${s.name} registered (jobId: ${n} id: ${c.id})`)}).catch(e=>{Yt(`PerformanceTestSessionJob for PerformanceTestSession ${s.name} registration failed (jobId: ${n}): ${e}`)})})}};await c(a,i)}catch(e){throw Yt(`startPerformanceTestSession failed: ${e}`),e}},performanceTestSessionAgentStart:async(e,{performanceTestSessionId:t,performanceTestSessionJobId:s,agentName:n})=>{Wt.push({ctx:e,performanceTestSessionId:t,performanceTestSessionJobId:s,data:{agentName:n,status:"RUNNING",started:new Date(Date.now()).toISOString()}})},performanceTestSessionProgress:async(e,t)=>{const s=Object.assign({},t);s.queueBegin&&(s.queueBegin=new Date(s.queueBegin)),s.testBegin&&(s.testBegin=new Date(s.testBegin)),s.testEnd&&(s.testEnd=new Date(s.testEnd)),Wt.push({ctx:e,performanceTestSessionId:t.performanceTestSessionId,performanceTestSessionJobId:t.performanceTestSessionJobId,dataRaw:s})},performanceTestSessionSetJobReadySuccess:async(e,{performanceTestSessionId:t,performanceTestSessionJobId:s})=>{Wt.push({ctx:e,performanceTestSessionId:t,performanceTestSessionJobId:s,data:{status:"READY",finished:new Date(Date.now()).toISOString()}})},performanceTestSessionSetJobReadyFailed:async(e,{performanceTestSessionId:t,performanceTestSessionJobId:s,err:n})=>{Wt.push({ctx:e,performanceTestSessionId:t,performanceTestSessionJobId:s,data:{status:"FAILED",finished:new Date(Date.now()).toISOString(),err:n}})}};const Qt=M("botium-box-server-charts-mutation");var Zt={updateChartCacheForTestSession:(e,{testSessionId:t},s,n)=>s.db.query.testSession({where:{id:t}},"{ id status results { success testSet { id } } jobs { status totalCount failedCount successCount } }").then(e=>{if(!e)return;const n={};return"READY"===e.status||"FAILED"===e.status?(n.totalCount=e.jobs.filter(e=>"READY"===e.status||"FAILED"===e.status).reduce((e,t)=>e+(t.totalCount||0),0)||0,n.failedCount=e.jobs.filter(e=>"READY"===e.status||"FAILED"===e.status).reduce((e,t)=>e+(t.failedCount||0),0)||0,n.successCount=e.jobs.filter(e=>"READY"===e.status||"FAILED"===e.status).reduce((e,t)=>e+(t.successCount||0),0)||0):(n.totalCount=e.results.length,n.failedCount=e.results.filter(e=>!e.success).length,n.successCount=e.results.filter(e=>e.success).length),n.countByTestSetId=e.results.reduce((e,t)=>{const s=t.testSet?t.testSet.id:"NULL";return e[s]||(e[s]={totalCount:0,failedCount:0,successCount:0}),e[s].totalCount++,t.success?e[s].successCount++:e[s].failedCount++,e},{}),n.countByDeviceSetId=e.results.reduce((e,t)=>{const s=t.deviceSet?t.deviceSet.id:"NULL";return e[s]||(e[s]={totalCount:0,failedCount:0,successCount:0}),e[s].totalCount++,t.success?e[s].successCount++:e[s].failedCount++,e},{}),Qt(`updateChartCacheForTestSession ${t} chartData updated: ${O.inspect(n)}`),s.db.mutation.updateTestSession({where:{id:e.id},data:{chartData:JSON.stringify(n)}}).then(()=>n)}).then(e=>(s.chartsCache.flush(),e))};const es=M("botium-box-server-mutation-testsession");var ts={createTestSession:async(e,{testSession:t},s,n)=>s.db.mutation.createTestSession({data:t},n).then(e=>new Promise((n,a)=>{s.queueConnector.create("box.createprocessingjobs",{title:`Job Creation Job for Test Session ${t.name}`,testSessionId:e.id}).removeOnComplete(!0).save(t=>{if(t)return a(t);n(e)})})),deleteTestSession:async(e,{id:t},s)=>new Promise((e,n)=>{s.db.mutation.deleteManyTestSessionJobLogs({where:{testSessionJob:{testSession:{id:t}}}}).then(()=>s.db.mutation.deleteManyTestSessionJobs({where:{testSession:{id:t}}})).then(()=>s.db.mutation.deleteManyTestSessionTestCaseResults({where:{testSession:{id:t}}})).then(()=>s.db.mutation.deleteTestSession({where:{id:t}},"{id}")).then(()=>e(!0)).catch(e=>(es(`Error deleting test session ${t}: ${e}`),n(e)))}),async cancelTestSession(e,{id:t},s){const n=await s.db.query.testSession({where:{id:t}},"{ id name jobs { jobId } }");if(!n)return!1;n.jobs.filter(e=>e.jobId).forEach(async e=>{p.Job.remove(e.jobId,t=>{es(t?`cancelTestSession - Failed to remove job ${e.jobId}: ${t}`:`cancelTestSession - removed job ${e.jobId}`)})});const a=await s.db.query.agents({where:{}},"{ id name }");for(const e of a)es(`cancelTestSession - sending cancel test session event ${n.id}/${n.name} to agent ${e.id}/${e.name}`),await s.queueConnector.create(`process.cancel.${e.name}`,{title:`Cancel Test Session Job for Test Session ${n.id}/${n.name}, Agent ${e.name}`,testSessionId:n.id,testSessionName:n.name}).removeOnComplete(!0).save(e=>{if(e)throw e});return!0},async stopTestSession(e,{id:t},s){const n=await s.db.query.testSession({where:{id:t}},"{ id name jobs { id status jobId } }");if(!n)return!1;await s.db.mutation.updateTestSession({where:{id:n.id},data:{status:"FAILED"}});for(const e of n.jobs)e.jobId&&p.Job.remove(e.jobId,t=>{es(t?`stopTestSession - Failed to remove job ${e.jobId}: ${t}`:`stopTestSession - removed job ${e.jobId}`)}),"PENDING"===e.status&&await s.db.mutation.updateTestSessionJob({data:{status:"READY",finished:new Date(Date.now()).toISOString(),progressPercent:100,totalCount:0,failedCount:0,successCount:0,err:"Job stopped"},where:{id:e.id}});const a=await s.db.query.agents({where:{}},"{ id name }");for(const e of a)es(`stopTestSession - sending stop test session event ${n.id}/${n.name} to agent ${e.id}/${e.name}`),await s.queueConnector.create(`process.stop.${e.name}`,{title:`Stop Test Session Job for Test Session ${n.id}/${n.name}, Agent ${e.name}`,testSessionId:n.id,testSessionName:n.name}).removeOnComplete(!0).save(e=>{if(e)throw e});return!0}};const{URL:ss}=l,ns=M("botium-box-server-agents-testsession"),{updateChartCacheForTestSession:as}=Zt,{stopTestSession:rs}=ts;const os=new u(async(e,t)=>{const s=q.uniq(e.map(e=>e.testSessionId));ns(`sendProgressProcessingQueue for testSessionIds: ${s}`),s.forEach(async t=>{try{await as(null,{testSessionId:t},e[0].ctx)}catch(e){ns(`updateChartCacheForTestSession failed: ${e}`)}e[0].ctx.pubsub.publish("TEST_SESSION_PROGRESS",{testSessionProgress:{id:t}})}),t()},{batchSize:1e3,batchDelay:3e3}),is=(e,t)=>{os.push({testSessionId:t,ctx:e})};var cs={startTestSession:async(e,{testSessionId:t})=>{try{const s=await Q.findFullTestSession(e.db,t);if(!s)throw new Error(`Test Session ${t} not configured`);const n=s.agent?"process.run."+s.agent.name:"process.run";ns(`startTestSession ${s.id} queueToSend: ${n}`);const{testSessionCaps:a,testSessionSources:r,testSessionEnvs:o,testSessionTestSets:i}=await Q.extractTestSessionLike(e,s);let c=1;const d=async(t,a)=>{for(let i=1;i<=c;i++){const d=await e.db.mutation.createTestSessionJob({data:{status:"PENDING",progressPercent:0,testSession:{connect:{id:s.id}}}},"{ id }"),u=e.queueConnector.create(n,{title:`Processing Job #${i}/${c} for Test Session ${s.name}`,testSessionId:s.id,testSessionName:s.name,testSessionJobId:d.id,botium:{Capabilities:t,Sources:r,Envs:o},testSets:a,batchNum:i,batchCount:c,bail:s.bail}).removeOnComplete(!0).save(async t=>{if(t)return ns(`Saving batchJob failed: ${t}`);const n=u.id;try{await e.db.mutation.updateTestSessionJob({data:{jobId:n},where:{id:d.id}}),ns(`TestSessionJob for TestSession ${s.name} registered (jobId: ${n} id: ${d.id})`)}catch(t){ns(`TestSessionJob for TestSession ${s.name} registration failed (jobId: ${n}): ${t}`)}try{await e.db.mutation.createTestSessionJobLog({data:{log:"Job queued for execution",testSessionJob:{connect:{id:d.id}}}},"{ id }")}catch(t){ns(`TestSessionJob for TestSession ${s.name} logging failed (jobId: ${n}): ${t}`)}})}};if(s.deviceSets&&s.deviceSets.length>0){const e=s.deviceSets.reduce((e,t)=>[...e,...t.devices.map(e=>{const n=t.provider.url&&new ss(t.provider.url),r=n?{protocol:n&&n.protocol.replace(":",""),host:n&&n.hostname,port:n&&n.port,path:n&&n.pathname}:{};return"SAUCELABS"===t.provider.type?{deviceSetId:t.id,deviceName:e.name,deviceOptions:Object.assign({desiredCapabilities:Object.assign({},JSON.parse(e.capabilities),{name:s.name,username:t.provider.username,accessKey:t.provider.password})},r)}:"TESTOBJECTS"===t.provider.type?{deviceSetId:t.id,deviceName:e.name,deviceOptions:Object.assign({desiredCapabilities:Object.assign({},JSON.parse(e.capabilities),{testobject_suite_name:s.name,testobject_api_key:t.provider.password})},r)}:"EXPERITEST"===t.provider.type?{deviceSetId:t.id,deviceName:e.name,deviceOptions:Object.assign({desiredCapabilities:Object.assign({},JSON.parse(e.capabilities),{testName:s.name,accessKey:t.provider.password})},r)}:"LOCALSELENIUM"===t.provider.type?{deviceSetId:t.id,deviceName:e.name,deviceOptions:Object.assign({desiredCapabilities:Object.assign({},JSON.parse(e.capabilities),{name:s.name})},r)}:("INTEGRATED"===t.provider.type&&(ns(`startTestSession ${s.id} adding capability for starting integrated PhantomJS`),a.WEBDRIVERIO_START_PHANTOMJS=!0),{deviceSetId:t.id,deviceName:e.name,deviceOptions:Object.assign({desiredCapabilities:Object.assign({},JSON.parse(e.capabilities),{name:s.name})},r)})})],[]);ns(`startTestSession ${s.id} testSessionDevices: ${JSON.stringify(e,null,2)}`);let t=Promise.resolve();e.forEach(e=>{const s=t=>t&&t.forEach(t=>{t.sourceTag=Object.assign({},t.sourceTag,{deviceSetId:e.deviceSetId,deviceName:e.deviceName})}),n=q.cloneDeep(i);n.forEach(e=>{s(e.convos),s(e.utterances),s(e.repositories),s(e.folders),s(e.excels)});const r=Object.assign({},a,{WEBDRIVERIO_OPTIONS:e.deviceOptions});t=t.then(()=>d(r,n))}),await t}else await d(a,i)}catch(s){ns(`startTestSession failed: ${s}`),await e.db.mutation.updateTestSession({where:{id:t},data:{status:"FAILED",jobs:{create:[{progressPercent:100,status:"FAILED",started:new Date(Date.now()).toISOString(),finished:new Date(Date.now()).toISOString(),err:`${s}`}]}}})}},testSessionLog:async(e,{testSessionJobId:t,log:s})=>{try{await e.db.mutation.createTestSessionJobLog({data:{log:s,testSessionJob:{connect:{id:t}}}},"{ id }")}catch(e){throw ns(`testSessionJobCompleted failed: ${e}`),e}},testSessionProgress:async(e,{testSessionId:t,testSessionJobId:s,batchNum:n,progress:a,...r})=>{try{const{count:a}=await e.db.mutation.updateManyTestSessions({data:{status:"RUNNING"},where:{id:t,status:"PENDING"}});a>0&&ns(`Test Session Job ${s}/#${n} set Test Session ${t} RUNNING.`)}catch(e){throw ns(`Test Session Job ${s}/#${n} set Test Session ${t} RUNNING failed: ${e}`),e}try{const{count:r}=await e.db.mutation.updateManyTestSessionJobs({data:{status:"RUNNING",started:new Date(Date.now()).toISOString(),progressPercent:q.isNumber(a)&&a},where:{id:s,status:"PENDING"}});r>0&&ns(`Test Session Job ${s}/#${n} set Test Session ${t} Job RUNNING.`)}catch(e){throw ns(`Test Session Job ${s}/#${n} set Test Session ${t} Job RUNNING failed: ${e}`),e}if(q.isNumber(a))try{const{count:t}=await e.db.mutation.updateManyTestSessionJobs({data:{progressPercent:a},where:{id:s,progressPercent_lt:a}});t>0&&ns(`Test Session Job ${s}/#${n} set Test Session Job progressPercent ${a}.`)}catch(e){throw ns(`Test Session Job ${s}/#${n} set Test Session Job progressPercent ${a} failed: ${e}`),e}if(r.testcase){const a={testcaseName:r.testcase,testcaseSource:r.source,success:r.success,err:r.err&&(q.isString(r.err)?r.err:JSON.stringify(r.err)),testSession:{connect:{id:t}}};r.transcript&&(r.transcript.convoBegin&&r.transcript.convoEnd&&(a.duration=x(r.transcript.convoEnd).diff(r.transcript.convoBegin)),r.transcript.steps&&(a.steps={create:r.transcript.steps.map((e,t)=>({step:t,sender:e.expected&&e.expected.sender,expected:e.expected&&(q.isString(e.expected)?e.expected:JSON.stringify(e.expected)),not:!!e.not,actual:e.actual&&(q.isString(e.actual)?e.actual:JSON.stringify(e.actual)),stepDuration:e.stepBegin&&e.stepEnd&&x(e.stepEnd).diff(e.stepBegin),botDuration:e.botBegin&&e.botEnd&&x(e.botEnd).diff(e.botBegin),err:e.err&&(q.isString(e.err)?e.err:JSON.stringify(e.err))}))})),r.sourceTag&&(r.sourceTag.filename&&(a.testSetFilename=r.sourceTag.filename),r.sourceTag.testSetId&&(a.testSet={connect:{id:r.sourceTag.testSetId}}),r.sourceTag.testSetScriptId&&(a.testSetScript={connect:{id:r.sourceTag.testSetScriptId}}),r.sourceTag.testSetRepositoryId&&(a.testSetRepository={connect:{id:r.sourceTag.testSetRepositoryId}}),r.sourceTag.testSetFolderId&&(a.testSetFolder={connect:{id:r.sourceTag.testSetFolderId}}),r.sourceTag.testSetExcelId&&(a.testSetExcel={connect:{id:r.sourceTag.testSetExcelId}}),r.sourceTag.deviceSetId&&(a.deviceSet={connect:{id:r.sourceTag.deviceSetId}}),r.sourceTag.deviceName&&(a.deviceName=r.sourceTag.deviceName)),r.attachments&&(a.attachments={create:r.attachments.map(e=>({name:e.name,mimeType:e.mimeType,base64:e.base64}))});try{const o=await e.db.mutation.createTestSessionTestCaseResult({data:a},"{ id }");ns(`TestResult for TestCase "${r.testcase}" in TestSession "${t}" registered (jobId: ${s}/#${n} id: ${o.id})`)}catch(e){throw ns(`TestResult for TestCase "${r.testcase}" in TestSession "${t}" registration failed (jobId: ${s}/#${n}): ${e}`),e}}if(r.stopTestSession)try{await rs(null,{id:t},e),ns(`Test Session "${t}" stopped (jobId: ${s}/#${n}.`)}catch(e){throw ns(`Test Session "${t}" stopping failed (jobId: ${s}/#${n}: ${e}`),e}ns(`testSessionProgress - Testsession "${t}", Job ${s}/#${n}, progress ${a}, ready.`),is(e,t)},testSessionSetJobCompletedResult:async(e,{testSessionId:t,testSessionJobId:s,result:n})=>{try{ns(`Test Session Job ${s}/${t} completed: ${JSON.stringify(n)}`),await e.db.mutation.updateTestSessionJob({data:{status:"READY",finished:new Date(Date.now()).toISOString(),progressPercent:100,totalCount:n&&n.totalCount,failedCount:n&&n.failedCount,successCount:n&&n.successCount},where:{id:s}},"{ id }"),await e.db.mutation.createTestSessionJobLog({data:{log:"Job completed",testSessionJob:{connect:{id:s}}}},"{ id }"),is(e,t)}catch(e){throw ns(`testSessionJobCompleted failed: ${e}`),e}},testSessionSetJobFailedErr:async(e,{testSessionId:t,testSessionJobId:s,result:n,err:a})=>{try{ns(`Test Session Job ${s}/${t} failed: ${a}.`),await e.db.mutation.updateTestSessionJob({data:{status:"FAILED",finished:new Date(Date.now()).toISOString(),progressPercent:100,totalCount:n&&n.totalCount,failedCount:n&&n.failedCount,successCount:n&&n.successCount,err:a&&(q.isString(a)?a:JSON.stringify(a))},where:{id:s}},"{ id }"),await e.db.mutation.createTestSessionJobLog({data:{log:`Job failed: ${a}`,testSessionJob:{connect:{id:s}}}},"{ id }"),is(e,t)}catch(a){throw ns(`testSessionJobFailed failed: ${a}`),a}},testSessionCheckFinished:async(e,{testSessionId:t,testSessionJobId:s})=>{try{const n=await e.db.query.testSession({where:{id:t}},"{ id name status jobs { status finished failedCount } }");if(!n)return;if(n.jobs&&n.jobs.find(e=>"READY"!==e.status&&"FAILED"!==e.status))return void ns(`Test Session testSessionCheckFinished ${t}/${s} waiting for other jobs to finish.`);const a=n.jobs&&!!n.jobs.find(e=>"FAILED"===e.status),r=n.jobs&&!!n.jobs.find(e=>e.failedCount>0);a||r?(ns(`testSessionCheckFinished test session ${t}/${n.name} failed (job failed: ${a}, result failed: ${r})`),await e.db.mutation.updateTestSession({where:{id:t},data:{status:"FAILED"}})):(ns(`testSessionCheckFinished test session ${t}/${n.name} success`),await e.db.mutation.updateTestSession({where:{id:t},data:{status:"READY"}})),is(e,t)}catch(e){throw ns(`testSessionCheckFinished ${t} failed: ${e}`),e}}};const ds=M("botium-box-server-agents-heartbeat");const us=M("botium-box-server-agents-registeragent");const ls=M("botium-box-server-agents"),{startPerformanceTestSession:ps,performanceTestSessionAgentStart:hs,performanceTestSessionProgress:Ss,performanceTestSessionSetJobReadyFailed:ms,performanceTestSessionSetJobReadySuccess:fs}=Kt,{startTestSession:Ts,testSessionSetJobCompletedResult:gs,testSessionSetJobFailedErr:bs,testSessionLog:ys,testSessionProgress:Es,testSessionCheckFinished:ws}=cs;const Cs=M("botium-box-server-testcasecleanup"),vs=async(e,t,s,n)=>{const a=await e.db.query.testSessionTestCaseResults({where:{createdAt_lte:t,success:n,attachments_some:{base64_not:""}}},"{ id attachments { id } }");a.length>0?(Cs(`Found ${a.length} screenshots to cleanup for ${s} (older than ${t}`),await e.db.mutation.deleteManyTestSessionTestCaseResultAttachments({where:{id_in:a.reduce((e,t)=>e.concat(t.attachments.map(e=>e.id)),[])}})):Cs(`Found no screenshots to cleanup for ${s} (older than ${t}`)},Is=async(e,t,s,n)=>{const a=await e.db.query.testSessionTestCaseResults({where:{createdAt_lte:t,success:n,steps_some:{expected_not:""}}},"{ id steps { id } }");a.length>0?(Cs(`Found ${a.length} transcripts to cleanup for ${s} (older than ${t}`),await e.db.mutation.deleteManyTestSessionTestCaseResultTranscripts({where:{id_in:a.reduce((e,t)=>e.concat(t.steps.map(e=>e.id)),[])}})):Cs(`Found no transcripts to cleanup for ${s} (older than ${t}`)},Os=async(e,t,s,n)=>{const a=await e.db.query.testSessionTestCaseResults({where:{createdAt_lte:t,success:n,testcaseSource_not:""}},"{ id }");a.length>0?(Cs(`Found ${a.length} results to cleanup for ${s} (older than ${t}`),await e.db.mutation.updateManyTestSessionTestCaseResults({data:{testcaseSource:""},where:{id_in:a.map(e=>e.id)}})):Cs(`Found no results to cleanup for ${s} (older than ${t}`)},Rs=async(e,t)=>{const s=await e.db.query.systemSettingses();if(isNaN(t)&&(!s||!s[0].cleanupJobIntervalMinutes))return void Cs("cleanupJobIntervalMinutes not configured, not scheduling cleanup task.");const n=isNaN(t)?60*s[0].cleanupJobIntervalMinutes*1e3:t;let a=[];try{a=await O.promisify(p.Job.rangeByType)("box.testcasecleanup","delayed",0,10,"")}catch(e){Cs(`error checking job states: ${e}`)}if(a&&a.length)for(const e of a)try{await O.promisify(e.remove).bind(e)(),Cs(`Removed duplicate Scheduled Test Case Cleanup Job ${e.id}.`)}catch(t){return Cs(`Removing Scheduled Test Case Cleanup Job ${e.id} failed: ${t}`),void Cs("Skipping cleanup job removal.")}return new Promise(t=>{const s=e.queueConnector.create("box.testcasecleanup",{title:"Scheduled Test Case Cleanup Job"}).removeOnComplete(!0).delay(n).save(e=>{if(e)Cs(`Scheduling Test Case Cleanup Job failed: ${e}`);else{const e=s.id;Cs(`Scheduled Test Case Cleanup Job ${e}, next run delay: ${n}`)}return t()})})};var Ns=async e=>{e.queueConnector.process("box.testcasecleanup",async(t,s)=>{try{await(async e=>{Cs("runCleanup started ...");const t=await e.db.query.systemSettingses();if(t&&!isNaN(t[0].keepTestCaseSuccessScreenshotsDays)){const s=x().subtract(t[0].keepTestCaseSuccessScreenshotsDays,"days").startOf("day").toDate();try{await vs(e,s,"keepTestCaseSuccessScreenshotsDays",!0)}catch(e){Cs(`runCleanupScreenshots keepTestCaseSuccessScreenshotsDays failed: ${e}`)}}if(t&&!isNaN(t[0].keepTestCaseFailedScreenshotsDays)){const s=x().subtract(t[0].keepTestCaseFailedScreenshotsDays,"days").startOf("day").toDate();try{await vs(e,s,"keepTestCaseFailedScreenshotsDays",!1)}catch(e){Cs(`runCleanupScreenshots keepTestCaseFailedScreenshotsDays failed: ${e}`)}}if(t&&!isNaN(t[0].keepTestCaseSuccessConversationDays)){const s=x().subtract(t[0].keepTestCaseSuccessConversationDays,"days").startOf("day").toDate();try{await Is(e,s,"keepTestCaseSuccessConversationDays",!0)}catch(e){Cs(`runCleanupTranscripts keepTestCaseSuccessConversationDays failed: ${e}`)}try{await Os(e,s,"keepTestCaseSuccessConversationDays",!0)}catch(e){Cs(`runCleanupDetails keepTestCaseSuccessConversationDays failed: ${e}`)}}if(t&&!isNaN(t[0].keepTestCaseFailedConversationDays)){const s=x().subtract(t[0].keepTestCaseFailedConversationDays,"days").startOf("day").toDate();try{await Is(e,s,"keepTestCaseFailedConversationDays",!1)}catch(e){Cs(`runCleanupTranscripts keepTestCaseFailedConversationDays failed: ${e}`)}try{await Os(e,s,"keepTestCaseFailedConversationDays",!1)}catch(e){Cs(`runCleanupDetails keepTestCaseFailedConversationDays failed: ${e}`)}}})(e),Cs("Test Case Cleanup ready."),s(),await Rs(e)}catch(t){Cs(`Test Case Cleanup failed: ${t}`),s(),await Rs(e)}}),await Rs(e,0)};const Ps=e=>({id:e}),As=e=>e&&e.id;var $s={jwtSettings:()=>({secret:process.env.JWT_SECRET,audience:process.env.JWT_AUDIENCE||"botiumbox",issuer:process.env.JWT_ISSUER||"botiumbox"}),userIdToToken:Ps,tokenToUserId:As,generateToken:e=>h.sign(Ps(e.id),process.env.JWT_SECRET,{expiresIn:86400*(process.env.JWT_EXPIRY_DAYS||30),audience:process.env.JWT_AUDIENCE||"botiumbox",issuer:process.env.JWT_ISSUER||"botiumbox",subject:e.id.toString()}),validateToken:async(e,t)=>{const s=h.verify(e,process.env.JWT_SECRET,{audience:process.env.JWT_AUDIENCE||"botiumbox",issuer:process.env.JWT_ISSUER||"botiumbox"});return await t.query.user({where:{id:As(s)}},"{ id name email roles { id name permissions } clients { id name } }")}};const{generateToken:xs}=$s;var Ds={me:async(e,t,s,n)=>s.request&&s.request.user,async autologin(e,t,s,n){if(s.request&&s.request.user)return{user:s.request.user,token:xs(s.request.user)}}},_s={agents:(e,{where:t,orderBy:s,skip:n,first:a},r,o)=>(s=s||"name_ASC",r.db.query.agents({where:t,orderBy:s,skip:n,first:a},o)),agent:(e,{id:t},s,n)=>s.db.query.agent({where:{id:t}},n)};const ks=M("botium-box-server-resolvers-chatbots");var js={chatbots:(e,{where:t,orderBy:s,skip:n,first:a},r,o)=>(s=s||"name_ASC",r.db.query.chatbots({where:t,orderBy:s,skip:n,first:a},o)),chatbot:(e,{id:t},s,n)=>s.db.query.chatbot({where:{id:t}},n),availablewatsonworkspaces:(e,{url:t,version:s,apikey:n,username:a,password:r})=>new Promise((e,o)=>{const i={url:t,version:s};n?Object.assign(i,{iam_apikey:n}):Object.assign(i,{username:a,password:r}),ks(`listWorkspaces for watson assistant: ${JSON.stringify(i)}`),new S(i).listWorkspaces((t,s)=>{if(t)o(t);else{const t=s.workspaces.map(e=>({name:e.name,description:e.description,value:e.workspace_id}));e(t)}})})};const Ms=(e,t)=>{if(!e)return!1;if(!e.roles)return!1;if("admin"!==e.name&&process&&process.env&&process.env.BOTIUMBOX_DISABLE_PERMISSIONS&&process.env.BOTIUMBOX_DISABLE_PERMISSIONS.indexOf(t)>=0)return!1;for(const s of e.roles)if(s.permissions)for(const e of s.permissions)if(e.endsWith("*")){if(t.startsWith(e.substr(0,e.length-1)))return!0}else if(e.startsWith("*")){if(t.endsWith(e.substr(1)))return!0}else if(e===t)return!0;return!1};var qs={permissionTypes:{AGENTS_SELECT:"AGENTS_SELECT",AGENTS_CREATE:"AGENTS_CREATE",AGENTS_UPDATE:"AGENTS_UPDATE",AGENTS_DELETE:"AGENTS_DELETE",CHATBOTS_SELECT:"CHATBOTS_SELECT",CHATBOTS_CREATE:"CHATBOTS_CREATE",CHATBOTS_UPDATE:"CHATBOTS_UPDATE",CHATBOTS_DELETE:"CHATBOTS_DELETE",CHATBOTS_LIVECHAT:"CHATBOTS_LIVECHAT",DEVICESETS_SELECT:"DEVICESETS_SELECT",DEVICESETS_CREATE:"DEVICESETS_CREATE",DEVICESETS_UPDATE:"DEVICESETS_UPDATE",DEVICESETS_DELETE:"DEVICESETS_DELETE",TESTPROJECTS_SELECT:"TESTPROJECTS_SELECT",TESTPROJECTS_CREATE:"TESTPROJECTS_CREATE",TESTPROJECTS_UPDATE:"TESTPROJECTS_UPDATE",TESTPROJECTS_DELETE:"TESTPROJECTS_DELETE",TESTSETS_SELECT:"TESTSETS_SELECT",TESTSETS_CREATE:"TESTSETS_CREATE",TESTSETS_UPDATE:"TESTSETS_UPDATE",TESTSETS_DELETE:"TESTSETS_DELETE",TESTSESSIONS_SELECT:"TESTSESSIONS_SELECT",TESTSESSIONS_CREATE:"TESTSESSIONS_CREATE",TESTSESSIONS_DELETE:"TESTSESSIONS_DELETE",TESTSESSIONS_REPORTS:"TESTSESSIONS_REPORTS",APIKEYS_SELECT:"APIKEYS_SELECT",APIKEYS_MANAGE:"APIKEYS_MANAGE",DEVICEPROVIDERS_SELECT:"DEVICEPROVIDERS_SELECT",DEVICEPROVIDERS_MANAGE:"DEVICEPROVIDERS_MANAGE",REGISTEREDCOMPONENTS_SELECT:"REGISTEREDCOMPONENTS_SELECT",REGISTEREDCOMPONENTS_MANAGE:"REGISTEREDCOMPONENTS_MANAGE",USERS_MANAGE:"USERS_MANAGE",SYSTEMSETTINGS_MANAGE:"SYSTEMSETTINGS_MANAGE"},hasPermission:Ms,hasAnyPermission:(e,t)=>{for(const s of t)if(Ms(e,s))return!0;return!1},hasAllPermissions:(e,t)=>{for(const s of t)if(!Ms(e,s))return!1;return!0}};var Bs={isLoggedIn:e=>{const t=(e=>q.get(e,"request.user"))(e),s=(e=>q.get(e,"request.apiKey"))(e),n=(e=>q.get(e,"connection.context.user"))(e);if(!t&&!s&&!n)throw new Error("Not logged in");return t||s||n},getClientIdFilter:e=>{return null},withClientConnect:(e,t,s)=>{if(s&&!e.client&&(e.client={connect:{id:s}}),e.client&&e.client.connect&&e.client.connect.id){if(!t)throw new Error("Unauthorized, missing client access");if(!t.find(t=>t.id===e.client.connect.id))throw new Error("Unauthorized, missing client access")}return e},withClientFilter:(e,t,s)=>{return{AND:[e||{}]}},assertClient:(e,t)=>{if(e&&(!t||!t.find(t=>t.id===e)))throw new Error("Unauthorized, missing client access")}};const Ls=M("botium-box-server-livechat"),{hasPermission:Fs}=qs,{isLoggedIn:Js,getClientIdFilter:Us,withClientConnect:Gs}=Bs,{startBot:Vs,sendToBot:Hs,stopBot:Ys,getConversation:Xs,getConversationScript:zs}=Ht,{composeBotiumCapabilities:Ws,combineBotiumCapabilities:Ks,getServerDefaultCapabilities:Qs}=Q,Zs=async(e,t,s)=>{const n=await t.query.chatbot({where:{id:e}},"{ id name capabilities { name type stringValue intValue booleanValue jsonValue } }");return Ks(Ws(n.capabilities),Qs({queueSettings:s}))};var en={liveChatConvoStepAdded:{subscribe:(e,{conversationId:t},{pubsub:s})=>s.asyncIterator(t)}},tn={async liveChatConvoSteps(e,{conversationId:t},s){try{return Xs({conversationId:t},s)}catch(e){throw Ls(e),new Error(`Conversation ${t} not available.`)}}},sn={async liveChatStartBot(e,{chatbotId:t},{db:s,pubsub:n,queueSettings:a}){const r=await Zs(t,s,a);return await Vs({caps:r},{pubsub:n,queueSettings:a})},liveChatSendToBot:async(e,{conversationId:t,convoStep:s},{queueSettings:n})=>(await Hs({conversationId:t,convoStep:JSON.parse(s)},{queueSettings:n}),!0),liveChatStopBot:async(e,{conversationId:t},{queueSettings:s})=>(await Ys({conversationId:t},{queueSettings:s}),!0),async liveChatSaveConvoSteps(e,{chatbotId:t,conversationId:s,testSetId:n,newTestSetName:a,testCaseName:r},o){const i=Js(o),c=await Zs(t,o.db,o.queueSettings);let d=null;if(a){if(!Fs(i,"TESTSETS_CREATE"))throw new Error("Missing permission TESTSETS_CREATE");d=await o.db.mutation.createTestSet({data:Gs({name:a},i.clients,Us(o))},"{ id name }")}else d=await o.db.query.testSet({where:{id:n}},"{ id name }");Ls(`liveChatSaveConvoSteps(${s}) saving test case for test set ${d.id}/${d.name}`);const u=await zs({caps:c,conversationId:s,testCaseName:r},o);let l=await o.db.mutation.createTestSetScript({data:{name:r,script:u,scriptType:"SCRIPTING_TYPE_CONVO",testSet:{connect:{id:d.id}}}},"{ id name }");return Ls(`liveChatSaveConvoSteps(${s}) saved test case for test set ${d.id}/${d.name} - ${l.id}/${l.name}`),l.id}},nn={testsessions:(e,{where:t,orderBy:s,skip:n,first:a},r,o)=>(s=s||"createdAt_DESC",n=isNaN(n)?0:n,a=isNaN(a)?100:a,r.db.query.testSessions({where:t,orderBy:s,skip:n,first:a},o)),testsession:(e,{id:t},s,n)=>s.db.query.testSession({where:{id:t}},n),testsessiontestcaseresult:(e,{id:t},s,n)=>s.db.query.testSessionTestCaseResult({where:{id:t}},n),testsessionjoblogs:(e,{jobId:t,orderBy:s,skip:n,first:a},r,o)=>r.db.query.testSessionJobLogs({where:{testSessionJob:{id:t}},orderBy:s,skip:n,first:a},o)},an={testsets:(e,{where:t,orderBy:s,skip:n,first:a},r,o)=>(s=s||"name_ASC",r.db.query.testSets({where:t,orderBy:s,skip:n,first:a},o).then(e=>(e&&e.forEach(e=>{e.repositories&&e.repositories.forEach(e=>{delete e.gitpassword})}),e))),testset:(e,{id:t},s,n)=>s.db.query.testSet({where:{id:t}},n).then(e=>(e.repositories&&e.repositories.forEach(e=>{delete e.gitpassword}),e)),testsetscripts:(e,{testSetId:t,skip:s,first:n},a,r)=>a.db.query.testSetScripts({where:{testSet:{id:t}},skip:s,first:n},r),testsetscript:(e,{id:t},s,n)=>s.db.query.testSetScript({where:{id:t}},n),validatetestsetscript(e,{script:t,scriptType:s}){const n=new m({AddConvos:()=>{},AddPartialConvos:()=>{},AddUtterances:()=>{},AddScriptingMemories:()=>{},IsAsserterValid:()=>!0,IsLogicHookValid:()=>!0,IsUserInputValid:()=>!0,GetPartialConvos:()=>[],scriptingEvents:{}},{SCRIPTING_TXT_EOL:"\n"}).Compile(t,s);return n&&n.length>0?"SCRIPTING_TYPE_UTTERANCES"===s?Promise.resolve({name:n[0].name,description:"Utterances",script:t,scriptType:s}):"SCRIPTING_TYPE_SCRIPTING_MEMORY"===s?Promise.resolve({name:"Scripting Memory",description:`Test Cases: ${n.map(e=>e.header.name).join("/")}`,script:t,scriptType:s}):Promise.resolve({name:n[0].header.name,description:n[0].header.description,script:t,scriptType:s}):Promise.reject(new Error("no script provided"))},testsetrepositories:(e,{testSetId:t,skip:s,first:n},a,r)=>a.db.query.testSetRepositories({where:{testSet:{id:t}},skip:s,first:n},r).then(e=>(e&&e.forEach(e=>{delete e.gitpassword}),e)),testsetrepository:(e,{id:t},s,n)=>s.db.query.testSetRepository({where:{id:t}},n).then(e=>(e&&delete e.password,e)),testsetfolders:(e,{testSetId:t,skip:s,first:n},a,r)=>a.db.query.testSetFolders({where:{testSet:{id:t}},skip:s,first:n},r),testsetfolder:(e,{id:t},s,n)=>s.db.query.testSetFolder({where:{id:t}},n),testsetexcels:(e,{testSetId:t,skip:s,first:n},a,r)=>a.db.query.testSetExcels({where:{testSet:{id:t}},skip:s,first:n},r),testsetexcel:(e,{id:t},s,n)=>s.db.query.testSetExcel({where:{id:t}},n),clonetestsetoptions:(e,t,s,n)=>It.possibleOptions};const rn=new X(3600);var on={devicesets:(e,{where:t,orderBy:s,skip:n,first:a},r,o)=>(s=s||"name_ASC",r.db.query.deviceSets({where:t,orderBy:s,skip:n,first:a},o)),deviceset:(e,{id:t},s,n)=>s.db.query.deviceSet({where:{id:t}},n),async availabledevices(e,{provider:t},s){const n=await s.db.query.deviceProvider({where:{id:t}});if(!n)return[];let a=[];"SAUCELABS"===n.type?a=await rn.get("SAUCELABS",()=>$({url:"https://saucelabs.com/rest/v1/info/platforms/all",json:!0}).then(e=>{return e.filter(e=>!e.device).map(e=>({name:`${e.long_name} ${e.short_version}, ${e.os}`,value:JSON.stringify({type:"DESKTOP",capabilities:{browserName:e.api_name,platform:e.os,version:e.short_version}})})).concat(e.filter(e=>e.device).map(e=>({name:`${e.long_name}, ${e.short_version}`,value:JSON.stringify({type:"MOBILEBROWSER",capabilities:{browserName:["iphone","ipad"].indexOf(e.api_name)>=0?"Safari":"Chrome",deviceName:e.device,platformName:["iphone","ipad"].indexOf(e.api_name)>=0?"iOS":"Android",platformVersion:e.short_version}})})))})):"TESTOBJECTS"===n.type?n.username&&n.password&&(a=await rn.get("TESTOBJECTS_"+n.url,()=>$({url:"https://app.testobject.com/api/rest/v2/devices",json:!0}).auth(n.username,n.password).then(e=>{return e[n.url.includes("eu1")?"EU":"US"].map(e=>({name:`${e.name}, ${e.os}, ${e.osVersion}`,value:JSON.stringify({type:"MOBILEAPP",capabilities:{deviceName:e.name,platformName:e.os,platformVersion:e.osVersion}})}))}))):"EXPERITEST"===n.type&&(a=await rn.get("EXPERITEST",()=>$({url:"https://cloud.seetest.io/api/v1/devices",headers:{Authorization:`Bearer ${n.password}`},json:!0}).then(e=>{return e.data&&e.data.filter(e=>e.deviceName).map(e=>({name:`${e.deviceName}, ${e.deviceOs} ${e.osVersion}`,value:JSON.stringify({type:"MOBILEBROWSER",capabilities:{browserName:"iOS"===e.deviceOs?"Safari":"Chrome",platformName:e.deviceOs,platformVersion:e.osVersion,deviceManufacturer:e.manufacturer,deviceModel:e.model,deviceCategory:e.deviceCategory}})}))})));const r=(a||[]).concat((e=>{const t=T.join("resources",`${e.type}.json`);if(f.existsSync(t)){const e=JSON.parse(f.readFileSync(t,"utf8"));if(q.isArray(e)){let t=e.filter(e=>e.name&&e.value).map(e=>({name:e.name,value:JSON.stringify(e.value)}));return q.uniqBy(q.orderBy(t,"name","asc"),"name")}}return[]})(n)||[]);return q.uniqBy(q.orderBy(r,"name","asc"),"name")}},cn={testprojects:(e,{where:t,orderBy:s,skip:n,first:a},r,o)=>(s=s||"name_ASC",r.db.query.testProjects({where:t,orderBy:s,skip:n,first:a},o)),testproject:(e,{id:t},s,n)=>s.db.query.testProject({where:{id:t}},n)},dn={users:(e,{where:t,orderBy:s,skip:n,first:a},r,o)=>(s=s||"name_ASC",r.db.query.users({where:t,orderBy:s,skip:n,first:a},o)),user:(e,{id:t},s,n)=>s.db.query.user({where:{id:t}},n),userroles:(e,{where:t,orderBy:s,skip:n,first:a},r,o)=>(s=s||"name_ASC",r.db.query.userRoles({where:t,orderBy:s,skip:n,first:a},o)),clients:(e,{where:t,orderBy:s,skip:n,first:a},r,o)=>(s=s||"name_ASC",r.db.query.clients({where:t,orderBy:s,skip:n,first:a},o)),apikeys:(e,{where:t,orderBy:s,skip:n,first:a},r,o)=>(s=s||"name_ASC",r.db.query.apiKeys({where:t,orderBy:s,skip:n,first:a},o)),apikey:(e,{id:t},s,n)=>s.db.query.apiKey({where:{id:t}},n),deviceproviders:(e,{where:t,orderBy:s,skip:n,first:a},r,o)=>(s=s||"name_ASC",r.db.query.deviceProviders({where:t,orderBy:s,skip:n,first:a},o).then(e=>(e&&e.forEach(e=>{delete e.password}),e))),deviceprovider:(e,{id:t},s,n)=>s.db.query.deviceProvider({where:{id:t}},n).then(e=>(e&&delete e.password,e)),registeredcomponents:(e,{where:t,orderBy:s,skip:n,first:a},r,o)=>(s=s||"name_ASC",r.db.query.registeredComponents({where:t,orderBy:s,skip:n,first:a},o)),registeredcomponent:(e,{id:t},s,n)=>s.db.query.registeredComponent({where:{id:t}},n),systemsettings:(e,t,s,n)=>s.db.query.systemSettingses({skip:0,first:1},n).then(e=>e&&e.length&&e[0]),availableconnectors(e,t,s,n){const a=[{name:"echo",description:"Botium Sample Chatbot (Echo)"},{name:"watson",description:"IBM Watson Assistant API"},{name:"directline3",description:"Microsoft Bot Framework (Directline 3)"},{name:"dialogflow",description:"Google Dialogflow"},{name:"koreai-webhook",description:"Kore.ai"},{name:"fbpagereceiver",description:"Facebook Messenger Bots"},{name:"botkit",description:"Botkit Anywhere"},{name:"botpress",description:"Botpress.io"},{name:"simplerest",description:"Generic HTTP/JSON Interface"},{name:"lex",description:"Amazon Lex"},{name:"alexa-avs",description:"Alexa Voice Service"},{name:"alexa-smapi",description:"Alexa Skill Management API"},{name:"luis",description:"Microsoft LUIS"},{name:"google-assistant",description:"Google Assistant"},{name:"wechat",description:"Wechat Webhook"},{name:"webdriverio",description:"WebdriverIO (Selenium or Appium)"}],r=[{name:"docker",description:"Dockerize Facebook/Slack/Botkit Chatbot"},{name:"fbdirect",description:"Connect Live Facebook Chatbot"},{name:"webspeech",description:"Webspeech (Talk/Listen)"}];if(process.env.BOTIUMBOX_DISABLE_CONNECTORS){process.env.BOTIUMBOX_DISABLE_CONNECTORS.split(",").forEach(e=>a.findIndex(t=>t.name===e)>=0&&a.splice(a.findIndex(t=>t.name===e),1))}if(process.env.BOTIUMBOX_ENABLE_CONNECTORS){process.env.BOTIUMBOX_ENABLE_CONNECTORS.split(",").forEach(e=>{a.findIndex(t=>t.name===e)>=0||(r.findIndex(t=>t.name===e)>=0?a.push(r.find(t=>t.name===e)):a.push({name:e,value:e,description:e}))})}return a.forEach(e=>{e.value=e.name}),q.sortBy(a,"description")}};const un=M("botium-box-server-charts-query"),{updateChartCacheForTestSession:ln}=Zt,{isLoggedIn:pn,getClientIdFilter:hn,withClientFilter:Sn}=Bs,mn=e=>"TODAY"===e?x().utc().startOf("day"):"LASTWEEK"===e?x().utc().subtract(6,"days").startOf("day"):"LAST2WEEKS"===e?x().utc().subtract(13,"days").startOf("day"):"LASTMONTH"===e?x().utc().subtract(30,"days").startOf("day"):"LAST2MONTHS"===e?x().utc().subtract(60,"days").startOf("day"):void 0,fn=e=>x().utc().endOf("day"),Tn=(e,t)=>{let s=Promise.resolve();return t&&t.forEach(t=>{s=s.then(()=>{if(!t.chartData)return ln(null,{testSessionId:t.id},e).then(e=>{t.chartData=e});t.chartData=JSON.parse(t.chartData)})}),s};var gn={chartFailedCountByTestSetByDay(e,{testProjectId:t,timeFrame:s},n,a){const r=pn(n),o=mn(s||"LAST2WEEKS"),i=fn();un(`called chartFailedCountByTestSetByDay ${o} - ${i}`);const c=`chartFailedCountByTestSetByDay_${JSON.stringify({fromDate:o,testProjectId:t,clientId:hn(n)})}`;return n.chartsCache.get(c,()=>{const e=Sn({status_in:["READY","FAILED"],createdAt_gte:x(o).toDate(),createdAt_lte:x(i).toDate(),jobs_every:{status:"READY"}},r.clients,hn(n));return t&&(e.testProject={id:t}),n.db.query.testSessions({where:e},"{ id createdAt testSets { id name } chartData }").then(e=>Tn(n,e).then(()=>e)).then(e=>{if(!e)return;const t=e.filter(e=>e.chartData).reduce((e,t)=>e.concat(t.testSets.map(e=>({testSet:e,createdAt:t.createdAt,chartData:t.chartData.countByTestSetId[e.id]}))),[]).filter(e=>e.chartData),s=q.groupBy(t,e=>e.testSet.id),n={};Object.keys(s).forEach(e=>{n[e]=s[e][0].testSet.name,s[e]=q.groupBy(s[e],e=>x.utc(e.createdAt).startOf("day")),Object.keys(s[e]).forEach(t=>{const n=s[e][t];s[e][t]=Math.ceil(n.reduce((e,t)=>e+t.chartData.failedCount,0)/n.length)})});const a=[];for(const e=x(o);e.isBefore(i);e.add(1,"days"))a.push(x(e));const r=Object.keys(s).map(e=>({id:e,name:n[e],data:a.map(t=>s[e][t])}));return q.sortBy(r,"name")})})},chartFailedCountByChatbotByDay(e,{timeFrame:t},s,n){const a=pn(s),r=mn(t||"LAST2WEEKS"),o=fn();un(`called chartFailedCountByChatbotByDay ${r} - ${o}`);const i=`chartFailedCountByChatbotByDay_${JSON.stringify({fromDate:r,clientId:hn(s)})}`;return s.chartsCache.get(i,()=>s.db.query.testSessions(Sn({where:{status_in:["READY","FAILED"],createdAt_gte:x(r).toDate(),createdAt_lte:x(o).toDate(),jobs_every:{status:"READY"}}},a.clients,hn(s)),"{ id createdAt chatbot { id name } chartData }").then(e=>Tn(s,e).then(()=>e)).then(e=>{if(!e)return;const t=q.groupBy(e,e=>e.chatbot.id),s={};Object.keys(t).forEach(e=>{s[e]=t[e][0].chatbot.name,t[e]=q.groupBy(t[e],e=>x.utc(e.createdAt).startOf("day")),Object.keys(t[e]).forEach(s=>{const n=t[e][s];t[e][s]=Math.ceil(n.reduce((e,t)=>e+t.chartData.failedCount,0)/n.length)})});const n=[];for(const e=x(r);e.isBefore(o);e.add(1,"days"))n.push(x(e));const a=Object.keys(t).map(e=>({id:e,name:s[e],data:n.map(s=>t[e][s])}));return q.sortBy(a,"name")}).then(e=>e.filter(e=>e.data&&e.data.filter(e=>!isNaN(e)).length>0)))},chartTestSetResultCount(e,{testProjectId:t},s,n){const a=pn(s),r=`chartTestSetResultCount_${JSON.stringify({testProjectId:t,clientId:hn(s)})}`;return s.chartsCache.get(r,()=>s.db.query.testSets({orderBy:"name_ASC"},"{ id name }").then(e=>Promise.all(e.map(e=>{const n=Sn({status_in:["READY","FAILED"],testSets_some:{id:e.id},jobs_every:{status:"READY"}},a.clients,hn(s));return t&&(n.testProject={id:t}),s.db.query.testSessions({where:n,orderBy:"createdAt_DESC",skip:0,first:2},"{ id createdAt chartData }").then(e=>Tn(s,e).then(()=>e)).then(t=>{const s={id:e.id,name:e.name,testCaseLastTotalCount:0,testCaseLastSuccessCount:0,testCaseLastSuccessRate:0,testCasePreviousTotalCount:0,testCasePreviousSuccessCount:0,testCasePreviousSuccessRate:0,testCaseTrend:"UNKNOWN"};if(t&&t.length>0){const n=t[0].chartData.countByTestSetId[e.id];s.lastRun=t[0].createdAt,s.lastTestSessionId=t[0].id,s.testCaseLastTotalCount=n?n.totalCount:0,s.testCaseLastSuccessCount=n?n.successCount:0,s.testCaseLastSuccessRate=s.testCaseLastTotalCount===s.testCaseLastSuccessCount?100:s.testCaseLastSuccessCount/s.testCaseLastTotalCount*100}if(t&&t.length>1){const n=t[1].chartData.countByTestSetId[e.id];s.previousRun=t[1].createdAt,s.previousTestSessionId=t[1].id,s.testCasePreviousTotalCount=n?n.totalCount:0,s.testCasePreviousSuccessCount=n?n.successCount:0,s.testCasePreviousSuccessRate=s.testCasePreviousTotalCount===s.testCasePreviousSuccessCount?100:s.testCasePreviousSuccessCount/s.testCasePreviousTotalCount*100,s.testCaseLastSuccessRate>s.testCasePreviousSuccessRate?s.testCaseTrend="GOOD":s.testCaseLastSuccessRate<s.testCasePreviousSuccessRate?s.testCaseTrend="BAD":s.testCaseTrend="CONSTANT"}return s})}))).then(e=>{const t=e.filter(e=>e.testCaseLastTotalCount>0);return q.orderBy(t,"lastRun","desc")}))},chartTestProjectTrainingStatusByTestSet(e,{testProjectId:t},s,n){const a=pn(s),r=`chartTestProjectTrainingStatusByTestSet_${JSON.stringify({testProjectId:t,clientId:hn(s)})}`;return s.chartsCache.get(r,async()=>{const e=Sn({status_in:["READY","FAILED"],testProject:{id:t},jobs_every:{status:"READY"}},a.clients,hn(s)),n=await s.db.query.testSessions({where:e,orderBy:"createdAt_DESC",skip:0,first:1},"{ id createdAt testSets { id name } chartData }");return n&&0!==n.length?(await Tn(s,n),n[0].testSets.forEach(e=>{const t=n[0].chartData.countByTestSetId[e.id];e.totalCount=t?t.totalCount:0,e.successCount=t?t.successCount:0,e.failedCount=t?t.failedCount:0}),q.sortBy(n[0].testSets,"name")):[]})},chartTestProjectTrainingStatusByDeviceSet(e,{testProjectId:t},s,n){const a=pn(s),r=`chartTestProjectTrainingStatusByDeviceSet_${JSON.stringify({testProjectId:t,clientId:hn(s)})}`;return s.chartsCache.get(r,async()=>{const e=Sn({status_in:["READY","FAILED"],testProject:{id:t},jobs_every:{status:"READY"}},a.clients,hn(s)),n=await s.db.query.testSessions({where:e,orderBy:"createdAt_DESC",skip:0,first:1},"{ id createdAt deviceSets { id name } chartData }");if(!n||0===n.length)return[];await Tn(s,n);const r=n[0].deviceSets||[];r.forEach(e=>{const t=n[0].chartData.countByDeviceSetId[e.id];e.totalCount=t?t.totalCount:0,e.successCount=t?t.successCount:0,e.failedCount=t?t.failedCount:0});const o=n[0].chartData.countByDeviceSetId.NULL;return o&&r.push({id:"",name:"No Device Set",totalCount:o.totalCount,successCount:o.successCount,failedCount:o.failedCount}),q.sortBy(r,"name")})}};const bn=e=>{const t=new Set(e?e.map(e=>e.status):[]);let s=null;if(t.has("RUNNING")?s="RUNNING":t.has("PENDING")?s="PENDING":t.has("READY")&&(s="READY"),t.has("FAILED")&&(null==s?s="FAILED":s+="/FAILED"),null===s){if(e&&e.length)throw new Error("illegal state, status cant be null");s="NO JOBS"}return s};var yn={performancetestsessions:(e,{where:t,orderBy:s,skip:n,first:a},r,o)=>(s=s||"createdAt_DESC",n=isNaN(n)?0:n,a=isNaN(a)?100:a,r.db.query.performanceTestSessions({where:t,orderBy:s,skip:n,first:a},o)),performancetestsessionssimplifiedwithstatus:(e,{where:t,orderBy:s,skip:n,first:a},r)=>(s=s||"createdAt_DESC",n=isNaN(n)?0:n,a=isNaN(a)?100:a,r.db.query.performanceTestSessions({where:t,orderBy:s,skip:n,first:a},"{ id createdAt updatedAt name description tags parallelConvoCount parallelJobCount tickRepeatInitial tickRepeatPerTick tickMaxTime tickTime dataDensity jobs {status} }").then(e=>e.map(e=>(e.status=bn(e.jobs),delete e.jobs,e))).then(e=>e)),performancetestsession:(e,{id:t},s,n)=>s.db.query.performanceTestSession({where:{id:t}},n),performancetestsessionstatus:(e,{id:t},s)=>s.db.query.performanceTestSession({where:{id:t}},"{ id jobs {status} }").then(e=>({id:e.id,status:bn(e.jobs)})),performancetestsessionjobs:(e,{where:t,orderBy:s,skip:n,first:a},r,o)=>(s=s||"createdAt_DESC",n=isNaN(n)?0:n,a=isNaN(a)?100:a,r.db.query.performanceTestSessionJobs({where:t,orderBy:s,skip:n,first:a},o)),performancetestsessionaggregatedresults:(e,{where:t,orderBy:s,skip:n,first:a},r,o)=>(s=s||"createdAt_DESC",n=isNaN(n)?0:n,a=isNaN(a)?100:a,r.db.query.performanceTestSessionAggregatedResults({where:t,orderBy:s,skip:n,first:a},o))};const En=b.Strategy,{generateToken:wn}=(M("botium-box-server-passport"),$s);var Cn={loadStrategy:async e=>{const t=e();g.use(new En(async(e,s,n)=>{try{const a={OR:[{name:e},{email:e}]},r=await t.db.query.users({where:a},"{ id name password email roles { id name permissions } clients { id name } }");if(!r||0===r.length)return n(null,!1,{message:`No such user found: ${e}`});const o=r[0];return o.password&&await w.compare(s,o.password)?(delete o.password,n(null,o)):n(null,!1,{message:"Invalid password."})}catch(e){return n(e)}}))},authenticate:(e,t)=>new Promise((s,n)=>{g.authenticate(t||"local",(e,t,a)=>e?n(e):t?void s({token:wn(t),user:t}):n(new Error(a.message)))(e.request,e.response,()=>{})})};const{authenticate:vn}=Cn;var In={login:async(e,{name:t,email:s,password:n},a,r)=>(a.request.body={username:t||s,password:n},"admin"===t?vn(a,"local"):vn(a))};const On=M("botium-box-server-agents-mutation"),Rn=(e,t)=>{e.forEach(e=>{const s=`agent.reconfigure.${e}`;t.queueConnector.create(s,{title:`Reconfigure Agent ${e}`}).removeOnComplete(!0).save(t=>{if(t)return On(`Saving reconfigure job failed: ${t}`);On(`Sent reconfigure job to ${e}`)})})};var Nn={async createAgent(e,{agent:t},s,n){},async updateAgent(e,{id:t,agent:s},n,a){if(!await n.db.exists.Agent({id:t}))throw new Error(`Agent not found ${t}`);const r=await n.db.mutation.updateAgent({where:{id:t},data:s},a),o=(await n.db.query.agent({where:{id:t}})).name;if("Default Agent"===o){const e=await n.db.query.agents({where:{name_not:"Default Agent"}});Rn(e.map(e=>e.name),n)}else Rn([o],n);return r},async deleteAgent(e,{id:t},s){}},Pn={createChatbot:async(e,{chatbot:t},s,n)=>s.db.mutation.createChatbot({data:t},n),async updateChatbot(e,{id:t,chatbot:s},n,a){if(!await n.db.exists.Chatbot({id:t}))throw new Error(`Chatbot not found ${t}`);return n.db.mutation.updateChatbot({where:{id:t},data:s},a)},deleteChatbot:async(e,{id:t},s)=>(await s.db.mutation.deleteChatbot({where:{id:t}},"{id}"),!0)};const An=ts.createTestSession,$n=M("botium-box-server-mutation-testproject"),xn=(e,t,s,n)=>{const a={testSession:Object.assign({},{status:"PENDING",chatbot:{connect:{id:t.chatbot.id}},testSets:{connect:t.testSets&&t.testSets.map(e=>({id:e.id}))},deviceSets:{connect:t.deviceSets&&t.deviceSets.map(e=>({id:e.id}))},registeredComponents:{connect:t.registeredComponents&&t.registeredComponents.map(e=>({id:e.id}))},testProject:{connect:{id:t.id}},batchCount:t.batchCount,bail:t.bail},s)};return t.client&&(a.testSession.client={connect:{id:t.client.id}}),t.agent&&(a.testSession.agent={connect:{id:t.agent.id}}),An(e,a,n,"{ id }")};var Dn={createTestProject:async(e,{testProject:t},s,n)=>s.db.mutation.createTestProject({data:{...t,code:j(t.name)}},n),startTestProject:async(e,{id:t,code:s},n)=>n.db.query.testProject({where:{id:t,code:s}},"{ id name client { id } chatbot { id } testSets { id } deviceSets { id } agent { id } registeredComponents { id } batchCount bail }").then(a=>{if(!a)throw new Error(`Test Project ${t}/${s} not found`);return xn(e,a,{name:a.name+" - Test Session",tags:{set:["BoxTriggered"]}},n)}).then(e=>e.id),quickstartTestProject:async(e,{testProject:t,startProject:s},n)=>n.db.mutation.createTestProject({data:{...t,code:j(t.name)}},"{ id name client { id } chatbot { id } testSets { id } deviceSets { id } agent { id } registeredComponents { id } batchCount bail }").then(t=>s?xn(e,t,{name:t.name+" - Initial Test Session",tags:{set:["QuickStart"]}},n).then(e=>e.id):t.id),async updateTestProject(e,{id:t,testProject:s},n,a){if(!await n.db.exists.TestProject({id:t}))throw new Error(`TestProject not found ${t}`);return n.db.mutation.updateTestProject({where:{id:t},data:{...s,code:j(s.name)}},a)},deleteTestProject:async(e,{id:t},s)=>new Promise((e,n)=>{s.db.mutation.deleteTestProject({where:{id:t}},"{id}").then(()=>e(!0)).catch(e=>($n(`Error deleting TestProject ${t}: ${e}`),n(e)))})};const _n=M("botium-box-server-mutation-settings");let kn=["LOCALSELENIUM"];var jn={createUser:async(e,{user:t},s,n)=>(t.password&&(t.password=await w.hash(t.password,10)),s.db.mutation.createUser({data:t},n)),async updateUser(e,{id:t,user:s},n,a){const r=await n.db.query.user({where:{id:t}});if(!r)throw new Error(`User not found ${t}`);return s.password&&(s.password=await w.hash(s.password,10)),"admin"===r.name&&(s.name="admin",s.roles={connect:[{name:"ADMIN"}]}),n.db.mutation.updateUser({where:{id:t},data:s},a)},async deleteUser(e,{id:t},s){const n=await s.db.query.user({where:{id:t}});if(!n)return!0;if("admin"===n.name)throw new Error('Not allowed to delete user "admin"');return s.db.mutation.deleteUser({where:{id:t}},"{id}").then(()=>!0).catch(e=>{throw _n(`Error deleting User ${t}: ${e}`),e})},createApiKey:async(e,{apiKey:t},s,n)=>(t.key=E("Aa0",20),s.db.mutation.createApiKey({data:t},n)),async updateApiKey(e,{id:t,apiKey:s},n,a){if(!await n.db.exists.ApiKey({id:t}))throw new Error(`ApiKey not found ${t}`);return delete s.key,n.db.mutation.updateApiKey({where:{id:t},data:s},a)},deleteApiKey:async(e,{id:t},s)=>s.db.mutation.deleteApiKey({where:{id:t}},"{id}").then(()=>!0).catch(e=>{throw _n(`Error deleting ApiKey ${t}: ${e}`),e}),async createDeviceProvider(e,{deviceProvider:t},s,n){if("INTEGRATED"===t.type)throw new Error("DeviceProvider type INTEGRATED not allowed to create");if(kn.indexOf(t.type)<0)throw new Error(`DeviceProvider type ${t.type} not supported in this version`);return s.db.mutation.createDeviceProvider({data:t},n)},async updateDeviceProvider(e,{id:t,deviceProvider:s},n,a){if(!await n.db.exists.DeviceProvider({id:t}))throw new Error(`DeviceProvider not found ${t}`);if(kn.indexOf(s.type)<0)throw new Error(`DeviceProvider type ${s.type} not supported in this version`);const r=await n.db.mutation.updateDeviceProvider({where:{id:t},data:s},a);return delete r.password,r},async deleteDeviceProvider(e,{id:t},s){const n=await s.db.query.deviceProvider({where:{id:t}});if(!n)return!0;if("INTEGRATED"===n.type)throw new Error("DeviceProvider type INTEGRATED not allowed to delete");try{return await s.db.mutation.deleteDeviceProvider({where:{id:t}},"{id}"),!0}catch(e){throw _n(`Error deleting DeviceProvider ${t}: ${e}`),e}},createRegisteredComponent:async(e,{registeredComponent:t},s,n)=>s.db.mutation.createRegisteredComponent({data:t},n),async updateRegisteredComponent(e,{id:t,registeredComponent:s},n,a){if(!await n.db.exists.RegisteredComponent({id:t}))throw new Error(`RegisteredComponent not found ${t}`);return n.db.mutation.updateRegisteredComponent({where:{id:t},data:s},a)},deleteRegisteredComponent:async(e,{id:t},s)=>s.db.mutation.deleteRegisteredComponent({where:{id:t}},"{id}").then(()=>!0).catch(e=>{throw _n(`Error deleting RegisteredComponent ${t}: ${e}`),e}),async updateSystemSettings(e,{systemSettings:t},s,n){const a=await s.db.query.systemSettingses({skip:0,first:1});return a&&a.length>0?s.db.mutation.updateSystemSettings({where:{id:a[0].id},data:t},n):s.db.mutation.createSystemSettings({data:t},n)}};const Mn=M("botium-box-server-mutation-deviceset");var qn={createDeviceSet:async(e,{deviceSet:t},s,n)=>s.db.mutation.createDeviceSet({data:t},n),async updateDeviceSet(e,{id:t,deviceSet:s},n,a){if(!await n.db.exists.DeviceSet({id:t}))throw new Error(`DeviceSet not found ${t}`);return n.db.mutation.updateDeviceSet({where:{id:t},data:s},a)},deleteDeviceSet:async(e,{id:t},s)=>new Promise((e,n)=>{s.db.query.deviceSet({where:{id:t}},"{ id devices { id } }").then(e=>{if(!e)throw new Error(`DeviceSet not found ${t}`);return s.db.mutation.deleteManyDeviceDescriptors({where:{id_in:e.devices.map(e=>e.id)}})}).then(()=>s.db.mutation.deleteDeviceSet({where:{id:t}},"{id}")).then(()=>e(!0)).catch(e=>(Mn(`Error deleting DeviceSet ${t}: ${e}`),n(e)))})},Bn={createPerformanceTestSession:async(e,{testProjectId:t,options:s},n,a)=>n.db.query.testProject({where:{id:t}},"{ id name client { id } chatbot { id } testSets { id } deviceSets { id } agent { id } registeredComponents { id } batchCount }").then(e=>{if(!e)throw Error(`Test project not found by id ${t}`);const a=Object.assign({},s,{chatbot:{connect:{id:e.chatbot.id}},testSets:{connect:e.testSets&&e.testSets.map(e=>({id:e.id}))},registeredComponents:{connect:e.registeredComponents&&e.registeredComponents.map(e=>({id:e.id}))},testProject:{connect:{id:e.id}}});return e.client&&(a.client={connect:{id:e.client.id}}),n.db.mutation.createPerformanceTestSession({data:a},"{id name}")}).then(e=>new Promise((t,s)=>{n.queueConnector.create("box.createperformanceprocessingjobs",{title:`Job Creation Job for Test Session ${e.name}`,performanceTestSessionId:e.id}).removeOnComplete(!0).save(n=>{if(n)return s(n);t(e.id)})})),deletePerformanceTestSession:async(e,{id:t},s)=>s.db.mutation.deletePerformanceTestSession({where:{id:t}},"{id}").then(()=>!0)};var Ln={};const{withFilter:Fn}=C;var Jn={testSessionProgress:{resolve:(e,{testSessionId:t},s,n)=>s.db.query.testSession({where:{id:t}},n),subscribe:Fn((e,{testSessionId:t},{pubsub:s})=>s.asyncIterator("TEST_SESSION_PROGRESS"),(e,{testSessionId:t})=>e&&e.testSessionProgress&&e.testSessionProgress.id===t)}},Un={Query:{...Ds,..._s,...js,...tn,...nn,...an,...on,...cn,...dn,...gn,...yn},Mutation:{...In,...Nn,...Pn,...sn,...ts,...At,...Dn,...jn,...qn,...Bn},Subscription:{...Ln,...en,...Jn}};const{SchemaDirectiveVisitor:Gn}=v,{defaultFieldResolver:Vn}=I,{hasPermission:Hn,hasAnyPermission:Yn}=qs,{isLoggedIn:Xn,getClientIdFilter:zn,withClientConnect:Wn,withClientFilter:Kn,assertClient:Qn}=Bs,Zn=M("botium-box-server-directives");var ea={hasAnyPermission:class extends Gn{visitFieldDefinition(e){const{resolve:t=Vn}=e,{permissions:s}=this.args;e.resolve=(async(e,n,a,r)=>{const o=Xn(a);if(Yn(o,s))return t.call(this,e,n,a,r);throw Zn(`User ${JSON.stringify(o)} missing any permissions ${s.join("|")}`),new Error(`Unauthorized, missing any permissions ${s.join("|")}`)})}},hasPermission:class extends Gn{visitFieldDefinition(e){const{resolve:t=Vn}=e,{permission:s}=this.args;e.resolve=(async(e,n,a,r)=>{const o=Xn(a);if(Hn(o,s))return t.call(this,e,n,a,r);throw Zn(`User ${JSON.stringify(o)} missing permission ${s}`),new Error(`Unauthorized, missing permission ${s}`)})}},clientFilter:class extends Gn{visitFieldDefinition(e){const{resolve:t=Vn}=e;e.resolve=(async(e,{where:s,...n},a,r)=>{const o=Xn(a),i=Kn(s,o.clients,zn(a));return t.call(this,e,{where:i,...n},a,r)})}},assertClient:class extends Gn{visitFieldDefinition(e){const{resolve:t=Vn}=e,{query:s,argsBase:n,idParam:a,selector:r}=this.args,o=e=>e&&e.client?e.client.id:e&&Object.keys(e).length>0?o(e[Object.keys(e)[0]]):null;e.resolve=(async(e,i,c,d)=>{const u=Xn(c),l=q.isArray(s)?s:[s],p=n&&(q.isArray(n)?n:[n]),h=a&&(q.isArray(a)?a:[a]),S=r&&(q.isArray(r)?r:[r]);for(let e in l){const t=p?q.get(i,p[e]):i;if(t)for(const s of q.isArray(t)?t:[t]){const t=q.get(s,h&&h[e]||"id");if(!t)continue;const n=await c.db.query[l[e]]({where:{id:t}},S&&S[e]||"{ client { id } }"),a=o(n);try{Qn(a,u.clients)}catch(s){throw Zn(`User ${JSON.stringify(u)} missing client access, query ${l[e]}, id ${t}, clientId ${a}`),s}}}return t.call(this,e,i,c,d)})}},clientConnector:class extends Gn{visitFieldDefinition(e){const{resolve:t=Vn}=e,{dataParam:s}=this.args,n=q.isArray(s)?s:[s];e.resolve=(async(e,s,a,r)=>{const o=Xn(a);return n.forEach(e=>{const t=q.get(s,e);if(!t)return;const n=zn(a);for(const e of q.isArray(t)?t:[t])Wn(e,o.clients,n)}),t.call(this,e,s,a,r)})}},clientDisconnector:class extends Gn{visitFieldDefinition(e){const{resolve:t=Vn}=e,{dataParam:s}=this.args;e.resolve=(async(e,n,a,r)=>{const o=n[s];return o&&o.client&&delete o.client,t.call(this,e,n,a,r)})}}};const{jwtSettings:ta,tokenToUserId:sa}=$s,na=M("botium-box-middleware-jwt");let aa=null;var ra=(e,t,s)=>{e.use((()=>R(Object.assign({},ta(),{credentialsRequired:!1,getToken:e=>e.headers.authorization&&"Bearer"===e.headers.authorization.split(" ")[0]?e.headers.authorization.split(" ")[1]:e.query&&e.query.token?e.query.token:e.body&&e.body.token?e.body.token:null})))()),e.use((e,t,n)=>(async(e,t,s,n)=>{if(e.user){const t=n({request:e}),a=e.user,r=await t.db.query.user({where:{id:sa(a)}},"{ id name email roles { id name permissions } clients { id name } }");return e.user={...r,token:a},s()}if(process.env.JWT_AUTOLOGIN_USERNAME){if(!aa){const t=n({request:e});aa=await t.db.query.user({where:{name:process.env.JWT_AUTOLOGIN_USERNAME}},"{ id name email roles { id name permissions } clients { id name } }"),na(`Auto login user ${process.env.JWT_AUTOLOGIN_USERNAME}.`)}return e.user={...aa,token:null},s()}return s()})(e,0,n,s)),e.use((e,t,n)=>(async(e,t,s,n)=>{const a=e.query.APIKEY||e.body&&e.body.APIKEY||e.headers.APIKEY,r=n({request:e});if(!a)return s();Q.lookupApiKey(r.db,a).then(t=>t?(na(`Api Key found - ${O.inspect(t)}`),e.apiKey=t,s()):(na(`Api Key not found - ${a}`),s())).catch(e=>(na(`Api Key lookup error - ${a} - ${e}`),s()))})(e,0,n,s))};const{setupEndpoints:oa,verifySignature:ia}=P,ca=M("botium-box-server-fbproxy");const da=M("botium-box-server-endpoints-testset"),{isLoggedIn:ua,assertClient:la}=Bs,{FindFullTestSet:pa}=W;const ha=M("botium-box-server-endpoints-attachments"),{isLoggedIn:Sa,assertClient:ma}=Bs;const fa=M("botium-box-server-endpoints-build"),{isLoggedIn:Ta,assertClient:ga}=Bs,ba=ts.createTestSession,ya=e=>{if(!e)return"";return e.split("\n").map(e=>e.trim()).join("     ")},Ea=(e,t)=>e.query[t]||e.query[t.toLowerCase()]||e.body&&e.body[t]||e.body&&e.body[t.toLowerCase()]||e.headers[`X-BOTIUM-${t}`],wa=(e,t)=>{const s=(Ea(e,"REPORTER")||"json").toLowerCase();return"json"===s||"junit"===s||"csv"===s||"jiracsv"===s||"pdf"===s||(t.sendStatus(404).send("VALID REPORTER OPTIONS: json, junit, csv, jiracsv, pdf"),!1)},Ca=(e,t)=>{return e.map(e=>`"${e.map(e=>q.isString(e)&&e.replace(/"/g,'""')).join(`"${t||";"}"`)}"`).join("\r\n")},va=async(e,t,s,n)=>{try{const a=(Ea(s,"REPORTER")||"json").toLowerCase();if("json"===a){const{ts:s,output:r}=await Oa(e,t,a);n.setHeader("Content-Type","application/json"),n.setHeader("Content-disposition",`attachment; filename="${j(s.name)}.json"`),n.status(200).send(r)}else if("junit"===a){const{ts:s,output:r}=await Oa(e,t,a);n.setHeader("Content-Type","text/xml"),n.setHeader("Content-disposition",`attachment; filename="${j(s.name)}.xml"`),n.status(200).send(r)}else if("csv"===a||"jiracsv"===a){const{ts:s,output:r}=await Oa(e,t,a);n.setHeader("Content-Type","text/csv"),n.setHeader("Content-disposition",`attachment; filename="${j(s.name)}.csv"`),n.status(200).send(r)}else if("pdf"===a){const{ts:s,output:r}=await Oa(e,t,a);n.setHeader("Content-Type","application/pdf"),n.setHeader("Content-disposition",`attachment; filename=${j(s.name)}.pdf`),n.status(200).send(r)}}catch(t){fa(`Test Session lookup error - ${e} - ${t}`),n.sendStatus(404)}},Ia=async(e,t,s,n,a)=>{try{const r=(a||"json").toLowerCase(),o={uri:s,method:n,headers:{}};if("get"!==n.toLowerCase()){const{output:s}=await Oa(e,t,r);"json"===r?(o.body=s,o.json=!0):"junit"===r?(o.headers["Content-Type"]="text/xml",o.body=s):"csv"===r||"jiracsv"===r?(o.headers["Content-Type"]="text/csv",o.body=s):"pdf"===r&&(o.headers["Content-Type"]="application/pdf",o.body=s)}await $(o),fa(`sendTestSessionOutput callbackUrl ${s} ready for test session ${e}`)}catch(t){fa(`sendTestSessionOutput callbackUrl ${s} failed for test session ${e} - ${t}`)}},Oa=async(e,t,s)=>{const n=await Q.findSimpleTestSessionResults(t.db,e);if(!n)throw new Error(`Test Session ${e} not found`);if("json"===s)return delete n.results,{ts:n,output:n};if("pdf"===s){const s=await Q.findFullTestSession(t.db,e),a=await Q.extractAllInvolvedTestSets(t,s.testSets),r=new _({bufferPages:!0,margins:{top:50,bottom:50,left:72,right:72}});r.reset=(()=>r.font("Helvetica").fontSize(12).fillColor("black")),r.bold=(()=>r.font("Helvetica-Bold")),r.fontSize(25).text(s.name,{underline:!0}).reset(),r.text(`Test Session Started: ${x(s.createdAt).format("lll")}`),r.moveDown(),"READY"===n.status&&r.fillColor("green").fontSize(25).bold().text("TEST SESSION OK").reset(),"FAILED"===n.status&&r.fillColor("red").fontSize(25).bold().text("TEST SESSION FAILED").reset(),r.text(`${n.results.length} Test Case(s)`),r.fillColor("green").text(`${n.results.filter(e=>e.success).length} Test Case(s) succeeded`).reset(),r.fillColor("red").text(`${n.results.filter(e=>!e.success).length} Test Case(s) failed`).reset(),s.testProject&&(r.moveDown(),r.font("Helvetica-Bold").text(`Test Project: ${s.testProject.name}`).reset(),s.testProject.description&&r.text(s.testProject.description),s.testProject.tags&&r.fillColor("darkgrey").text(s.testProject.tags.join(" | ")).reset()),s.chatbot&&(r.moveDown(),r.font("Helvetica-Bold").text(`Chatbot Under Test: ${s.chatbot.name}`).reset(),s.chatbot.description&&r.text(s.chatbot.description),s.chatbot.tags&&r.fillColor("darkgrey").text(s.chatbot.tags.join(" | ")).reset()),a&&a.forEach(e=>{r.moveDown(),r.font("Helvetica-Bold").text(`Test Set: ${e.name}`).reset(),e.description&&r.text(e.description),e.scripts&&r.text(`Scripts: ${e.scripts.length}`),e.repositories&&e.repositories.forEach(e=>{r.text(`Repository: ${e.name}, ${e.gitbranch}`)}),e.folders&&e.folders.forEach(e=>{r.text(`Shared Folder: ${e.name}`)}),e.excels&&e.excels.forEach(e=>{r.text(`Excel File: ${e.name}, ${e.filename}`)}),e.tags&&r.fillColor("darkgrey").text(e.tags.join(" | ")).reset()});const o=r.bufferedPageRange();for(let e=o.start;e<o.start+o.count;e++)r.switchToPage(e),r.fontSize(8),r.image("media/botium-logo.png",r.page.width-35,10,{width:25}),r.text(`${s.name}, page ${e+1} of ${o.count}`,200,r.page.height-40,{height:25});return r.end(),new Promise(e=>{r.pipe(k(t=>e({ts:n,output:t})))})}if("junit"===s){const e=q.groupBy(n.results,e=>e.testSet?e.testSet.name:""),t=q.keys(e).map(t=>{const s=e[t];return{testsuite:[{_attr:{name:t||"unnamed",tests:s.length,failures:s.filter(e=>!e.success).length,time:s.reduce((e,t)=>t.duration?e+t.duration:e,0)/1e3}}]}}),s=D({testsuites:[{_attr:{name:n.name,tests:n.results.length,failures:n.results.filter(e=>!e.success).length,time:n.results.reduce((e,t)=>t.duration?e+t.duration:e,0)/1e3}}].concat(t)},{declaration:!0});return{ts:n,output:s}}if("csv"===s){delete n.results;const e=[];e.push(["testSessionId","testSessionStatus","testSessionName","testCaseId","testCaseName","testCaseSource","testCaseSuccess","testCaseErr","testCaseDuration","testSetId","testSetName","testSetTags","testSetRepository","testSetRepositoryBranch","testSetFolder","testSetExcel","testSetFilename"]);const t=(e,t)=>{t?(e.push(t.id),e.push(t.testcaseName),e.push(ya(t.testcaseSource)),e.push(t.success),e.push(ya(t.err)),e.push(t.duration),t.testSet?(e.push(t.testSet.id),e.push(t.testSet.name),e.push(t.testSet.tags&&t.testSet.tags.join("|")),t.testSetRepository?(e.push(t.testSetRepository.name),e.push(t.testSetRepository.gitbranch)):e.push(null,null),t.testSetFolder?e.push(t.testSetFolder.name):e.push(null),t.testSetExcel?e.push(t.testSetExcel.name):e.push(null),e.push(t.testSetFilename)):e.push(null,null,null,null,null,null,null,null)):e.push(null,null,null,null,null,null,null,null,null,null,null,null,null,null)},s=[n.id,n.status,n.name];return n.results&&n.results.length>0?n.results.forEach(n=>{const a=s.slice(0);t(a,n),e.push(a)}):(t(s,null),e.push(s)),{ts:n,output:Ca(e)}}if("jiracsv"===s){const e=[];return e.push(["Build","Date","Summary","Description"]),"FAILED"!==n.status&&e.push([n.name,n.createdAt,`${n.name}: Botium Test Session failed`,`${n.results.filter(e=>!e.success).length} Test Cases failed of ${n.results.length}`]),{ts:n,output:Ca(e,",")}}},Ra=(e,t,s)=>{const n=t.pubsub.asyncIterator("TEST_SESSION_PROGRESS");!async function(){for(;;){const{value:a}=await n.next();if(a.testSessionProgress&&a.testSessionProgress.id===e){const n=await t.db.query.testSession({where:{id:e}},"{ id status }");if(fa(`Test Project ${e} got status: ${n.status}`),"READY"===n.status)return s();if("FAILED"===n.status)return s()}}}()},Na=(e,t,s,n)=>{const a=Ea(s,"WAIT");"READY"!==e.status&&"FAILED"!==e.status&&"1"===a?Ra(e.id,t,()=>va(e.id,t,s,n)):va(e.id,t,s,n)},Pa=(e,t,s)=>{const n=Ea(s,"CALLBACKURL"),a=Ea(s,"CALLBACKMETHOD")||"POST",r=Ea(s,"REPORTER");n&&("READY"!==e.status&&"FAILED"!==e.status?Ra(e.id,t,()=>Ia(e.id,t,n,a,r)):Ia(e.id,t,n,a,r))};var Aa=(e,t)=>{const s=(e,s)=>{(({ctxFactory:e,testProjectCode:t,req:s,res:n})=>{if(!wa(s,n))return;const a=e({request:s}),r=Ta(a);a.db.query.testProject({where:{code:t}},"{ id name chatbot { id } testSets { id } deviceSets { id } agent { id } batchCount client { id } }").then(e=>{if(!e)throw new Error(`Test Project ${t} not found`);const n=q.get(e,"client.id");ga(n,r.clients);const o=Ea(s,"BUILDID"),i=Ea(s,"BUILDCOMMENT"),c=Ea(s,"TAG"),d=e=>Object.keys(e).reduce((t,s)=>(t.push({name:s,type:"STRING",stringValue:e[s]}),t),[]),u=s.body&&s.body.CAPS&&d(s.body.CAPS)||[],l=s.body&&s.body.SOURCES&&d(s.body.SOURCES)||[],p=s.body&&s.body.ENVS&&d(s.body.ENVS)||[],h={name:o||e.name+" - Test Session",description:i,status:"PENDING",tags:{set:c?q.isArray(c)?c:[c]:[]},chatbot:{connect:{id:e.chatbot.id}},testSets:{connect:e.testSets&&e.testSets.map(e=>({id:e.id}))},deviceSets:{connect:e.deviceSets&&e.deviceSets.map(e=>({id:e.id}))},testProject:{connect:{id:e.id}},capabilities:{create:u},sources:{create:l},envs:{create:p},batchCount:e.batchCount,bail:e.bail};return e.agent&&(h.agent={connect:{id:e.agent.id}}),fa(`Creating Test Session ${JSON.stringify(h,null,2)}`),ba(null,{testSession:h},a,"{ id status }")}).then(e=>{Na(e,a,s,n),Pa(e,a,s)}).catch(e=>{fa(`Test Project start error - ${t} - ${e}`),n.sendStatus(404)})})({testProjectCode:e.params.code,ctxFactory:t,req:e,res:s})};e.post("/api/triggerbuild/:code",s),e.get("/api/triggerbuild/:code",s),e.get("/api/build/:nameOrId",(e,s)=>{(({ctxFactory:e,nameOrId:t,req:s,res:n})=>{if(!wa(s,n))return;const a=e({request:s}),r=Ta(a);a.db.query.testSessions({where:{OR:[{id:t},{name:t}]},orderBy:"createdAt_DESC",first:1},"{ id name status client { id } }").then(e=>{if(!e)return n.sendStatus(404);const t=e[0],o=q.get(t,"client.id");ga(o,r.clients),Na(t,a,s,n),Pa(t,a,s)}).catch(e=>{fa(`Test Session lookup error - ${t} - ${e}`),n.sendStatus(404)})})({nameOrId:e.params.nameOrId,ctxFactory:t,req:e,res:s})}),e.get("/api/log/:nameOrId",(e,s)=>{(({ctxFactory:e,nameOrId:t,req:s,res:n})=>{const a=e({request:s}),r=Ta(a);a.db.query.testSessions({where:{OR:[{id:t},{name:t}]},orderBy:"createdAt_DESC",first:1},"{ id name jobs { id logs { createdAt log } } client { id } }").then(e=>{if(!e)return n.sendStatus(404);const t=e[0],s=q.get(t,"client.id");ga(s,r.clients),n.set("Content-Type","text/plain"),t.jobs&&t.jobs.forEach(e=>{n.write(`Job Output (${e.id})\n`),e.logs&&e.logs.forEach(e=>{n.write(e.createdAt+": "+e.log+"\n")}),n.write("\n\n"),n.write("##############################################################\n"),n.write("##############################################################\n"),n.write("##############################################################\n"),n.write("\n\n")}),n.status(200).end()}).catch(e=>{fa(`Test Session lookup error - ${t} - ${e}`),n.sendStatus(404)})})({nameOrId:e.params.nameOrId,ctxFactory:t,req:e,res:s})}),e.get("/api/joblog/:id",(e,s)=>{(({ctxFactory:e,id:t,req:s,res:n})=>{const a=e({request:s}),r=Ta(a);a.db.query.testSessionJob({where:{id:t},orderBy:"createdAt_ASC"},"{ id logs { createdAt log } testSession { client { id } } }").then(e=>{if(!e)return n.sendStatus(404);const t=q.get(e,"testSession.client.id");ga(t,r.clients),n.set("Content-Type","text/plain"),e.logs&&e.logs.forEach(e=>{n.write(e.createdAt+": "+e.log+"\n")}),n.status(200).end()}).catch(e=>{fa(`Test Session Job lookup error - ${t} - ${e}`),n.sendStatus(404)})})({id:e.params.id,ctxFactory:t,req:e,res:s})}),e.get("/api/transcript/:nameOrId",(e,s)=>{(({ctxFactory:e,nameOrId:t,req:s,res:n})=>{const a=e({request:s}),r=Ta(a);a.db.query.testSessions({where:{OR:[{id:t},{name:t}]},orderBy:"createdAt_DESC",first:1},"{ id status name client { id } results { id testcaseName createdAt success err duration steps { step expected not actual stepDuration botDuration err } } }").then(e=>{if(!e)return n.sendStatus(404);const t=e[0],a=q.get(t,"client.id");ga(a,r.clients);const o=Ea(s,"REPORTER")||"json";if(delete t.results,t.results&&t.results.forEach(e=>{e.steps&&e.steps.forEach(e=>{e.actual&&q.isString(e.actual)&&(e.actual=JSON.parse(e.actual)),e.expected&&q.isString(e.expected)&&(e.expected=JSON.parse(e.expected))})}),"json"===o)n.setHeader("Content-disposition",`attachment; filename="${j(t.name)}.json"`),n.status(200).send(t);else if("csv"===o){const e=[];e.push(["testSessionId","testSessionStatus","testSessionName","testCaseId","testCaseName","testCaseCreatedAt","testCaseSuccess","testCaseErr","testCaseDuration","convoStepIndex","convoStepSender","convoStepActual","convoStepNot","convoStepExpected","convoStepDuration","convoStepBotDuration","convoStepErr"]);const s=(e,t)=>{t?(e.push(t.id),e.push(t.testcaseName),e.push(t.createdAt),e.push(t.success),e.push(ya(t.err)),e.push(t.duration)):e.push(null,null,null,null,null,null)},a=e=>{if("me"===e.sender){if(e.buttons&&e.buttons.length>0)return`BUTTON ${e.buttons[0].payload||e.buttons[0].text}`;if(e.media&&e.media.length>0)return`MEDIA ${e.media[0].mediaUri}`}return e.messageText},r=(e,t)=>{t?(e.push(t.step),e.push(t.actual&&t.actual.sender),e.push(t.actual&&ya(a(t.actual))),e.push(t.not),e.push(t.expected&&ya(a(t.expected))),e.push(t.stepDuration),e.push(t.botDuration),e.push(ya(t.err))):e.push(null,null,null,null,null,null,null,null)},o=[t.id,t.status,t.name];t.results&&t.results.length>0?t.results.forEach(t=>{const n=o.slice(0);s(n,t),t.steps&&t.steps.length>0?t.steps.forEach(t=>{const s=n.slice(0);r(s,t),e.push(s)}):(r(n,null),e.push(n))}):(s(o,null),r(o,null),e.push(o));const i=Ca(e);n.setHeader("Content-disposition",`attachment; filename="${j(t.name)}.csv"`),n.status(200).send(i)}else n.sendStatus(404).send("VALID REPORTER OPTIONS: json, csv");n.status(200).end()}).catch(e=>{fa(`Test Session lookup error - ${t} - ${e}`),n.sendStatus(404)})})({nameOrId:e.params.nameOrId,ctxFactory:t,req:e,res:s})})};const $a=M("botium-box-server-endpoints-performancebuild"),{isLoggedIn:xa,assertClient:Da}=Bs,_a=(e,t)=>{return e.map(e=>`"${e.map(e=>q.isString(e)?e.replace(/"/g,'""'):e).join(`"${t||";"}"`)}"`).join("\r\n")},ka=(e,t)=>e.query[t]||e.query[t.toLowerCase()]||e.body&&e.body[t]||e.body&&e.body[t.toLowerCase()]||e.headers[`X-BOTIUM-${t}`],ja=({ctxFactory:e,nameOrId:t,req:s,res:n})=>{if(!((e,t)=>{const s=(ka(e,"REPORTER")||"json").toLowerCase();return"json"===s||"csv"===s||(t.sendStatus(404).send("VALID REPORTER OPTIONS: json, csv"),!1)})(s,n))return;const a=e({request:s}),r=xa(a);a.db.query.performanceTestSessions({where:{OR:[{id:t},{name:t}]},orderBy:"createdAt_DESC",first:1},"{ id name client { id } }").then(e=>{if(!e)return n.sendStatus(404);const t=e[0],o=q.get(t,"client.id");Da(o,r.clients),Ma(t.id,a,s,n)}).catch(e=>{$a(`Test Session lookup error - ${t} - ${e}`),n.sendStatus(404)})},Ma=async(e,t,s,n)=>{try{const a=(ka(s,"REPORTER")||"json").toLowerCase();if("json"===a){const{ts:s,output:r}=await qa(e,t,a);n.setHeader("Content-Type","application/json"),n.setHeader("Content-disposition",`attachment; filename="${j(s.name)}.json"`),n.status(200).send(r)}else if("csv"===a){const{ts:s,output:r}=await qa(e,t,a);n.setHeader("Content-Type","text/csv"),n.setHeader("Content-disposition",`attachment; filename="${j(s.name)}.csv"`),n.status(200).send(r)}}catch(t){$a(`Test Session lookup error - ${e} - ${t}`),n.sendStatus(404)}},qa=async(e,t,s)=>{const n=await Q.findSimplePerformanceTestSessionResults(t.db,e);if(!n)throw new Error(`Test Session ${e} not found`);if("json"===s)return n.results.map(e=>({execCount:e.execCount,execDurationMin:e.execDurationMin,execDurationMax:e.execDurationMax,execDurationSum:e.execDurationSum})),{ts:n,output:n};if("csv"===s){const e=[],t=["testSessionId","testSessionName","testResultId","testResultJobId","testResultStepIndex","testResultStepStartAt","testResultConvo","execResultCount","execResultDurationMin","execResultDurationMax","execResultDurationSum"];e.push(t);const s=(e,t)=>{$a(`result ${JSON.stringify(t)}`),t?(e.push(t.id),e.push(t.job.id),e.push(t.stepIndex),e.push(t.stepStartAt),e.push(t.convo),e.push(t.execCount),e.push(t.execDurationMin),e.push(t.execDurationMax),e.push(t.execDurationSum)):e.push(null,null,null,null,null,null,null,null),$a(`result line ${JSON.stringify(e)}`)},a=[n.id,n.name];return n.results&&n.results.length>0?n.results.forEach(t=>{const n=a.slice(0);s(n,t),e.push(n)}):(s(a,null),e.push(a)),{ts:n,output:_a(e)}}};const{hasPermission:Ba}=qs,La={"/api/testset/":"TESTSETS_SELECT","/api/attachment/excel/":"TESTSETS_SELECT","/api/attachment/screenshot/":"TESTSESSIONS_SELECT","/api/triggerbuild/":"TESTSESSIONS_CREATE","/api/build/":"TESTSESSIONS_REPORTS","/api/performancebuild/":"PERFORMANCETESTSESSIONS_REPORTS","/api/log/":"TESTSESSIONS_REPORTS","/api/joblog/":"TESTSESSIONS_REPORTS","/api/transcript/":"TESTSESSIONS_REPORTS"};var Fa=async(e,t)=>{await(async(e,t)=>{const s=t();(await s.db.query.chatbots({where:{}}," { id name capabilities { name type stringValue intValue booleanValue jsonValue } } ")).filter(e=>e.capabilities&&e.capabilities.filter(e=>"CONTAINERMODE"===e.name&&"fbpagereceiver"===e.stringValue).length>0).forEach(t=>{const n={app:e,endpoint:"/api/fbproxy/"+t.capabilities.find(e=>"FBPAGERECEIVER_ENDPOINT"===e.name).stringValue,verifytoken:t.capabilities.find(e=>"FBPAGERECEIVER_VERIFYTOKEN"===e.name).stringValue,accesstoken:t.capabilities.find(e=>"FBPAGERECEIVER_ACCESSTOKEN"===e.name).stringValue,redisurl:s.queueSettings.redis},a=t.capabilities.find(e=>"FBPAGERECEIVER_APPSECRET"===e.name);a&&a.stringValue?e.use(n.endpoint,N.json({verify:ia.bind(null,a.stringValue)})):e.use(n.endpoint,N.json()),oa(n),ca(`Started FB Proxy for chatbot ${t.id}/${t.name}, endpoint: ${n.endpoint}`)})})(e,t),e.use(N.json({limit:"50mb",extended:!0})),e.use(["/api/testset/*","/api/attachment/*","/api/performancebuild/*","/api/build/*","/api/triggerbuild/*","/api/log/*","/api/joblog/*","/api/transcript/*"],((e,t,s,n)=>{if(!t.apiKey&&!t.user)return s.sendStatus(401);if(t.apiKey)return n();for(const e in La)if(t.baseUrl.startsWith(e)&&!Ba(t.user,La[e]))return s.sendStatus(401);return n()}).bind(null,t)),((e,t)=>{e.get("/api/testset/:id",async(e,s)=>{const n=e.params.id,a=t({request:e});try{const e=ua(a),t=await pa(a.db,n);if(t){const n=q.get(t,"client.id");la(n,e.clients);const a=new A;t.scripts&&t.scripts.forEach(e=>{"SCRIPTING_TYPE_CONVO"===e.scriptType&&a.addFile(`scripts/${e.name}.convo.txt`,Buffer.alloc(e.script.length,e.script)),"SCRIPTING_TYPE_PCONVO"===e.scriptType&&a.addFile(`scripts/${e.name}.pconvo.txt`,Buffer.alloc(e.script.length,e.script)),"SCRIPTING_TYPE_UTTERANCES"===e.scriptType&&a.addFile(`scripts/${e.name}.utterances.txt`,Buffer.alloc(e.script.length,e.script)),"SCRIPTING_TYPE_SCRIPTING_MEMORY"===e.scriptType&&a.addFile(`scripts/${e.name}.scriptingmemory.txt`,Buffer.alloc(e.script.length,e.script))});const r=a.toBuffer();s.writeHead(200,{"Content-disposition":`attachment; filename="${t.name}.zip"`,"Content-Length":r.length}),s.end(r)}else da(`TestSet not found - ${n}`),s.sendStatus(404)}catch(e){da(`TestSet lookup error - ${n} - ${e}`),s.sendStatus(404)}})})(e,t),((e,t)=>{e.get("/api/attachment/excel/:id",async(e,s)=>{const n=e.params.id,a=t({request:e});try{const e=Sa(a),t=await Q.getExcel(a.db,n);if(t){const n=q.get(t,"testSet.client.id");ma(n,e.clients);const a=Buffer.from(t.filecontent,"base64");s.writeHead(200,{"Content-disposition":`attachment; filename="${t.filename}"`,"Content-Length":a.length}),s.end(a)}else ha(`Excel not found - ${n}`),s.sendStatus(404)}catch(e){ha(`Excel lookup error - ${n} - ${e}`),s.sendStatus(404)}}),e.get("/api/attachment/screenshot/:id",async(e,s)=>{const n=e.params.id,a=t({request:e});try{const e=Sa(a),t=await Q.getAttachment(a.db,n);if(t){const n=q.get(t,"testSessionTestCaseResult.testSession.client.id");ma(n,e.clients);const a=Buffer.from(t.base64,"base64");s.writeHead(200,{"Content-Disposition":`inline; filename="${t.name}"`,"Content-Type":t.mimeType,"Content-Length":a.length}),s.end(a)}else ha(`Attachment not found - ${n}`),s.sendStatus(404)}catch(e){ha(`Attachment lookup error - ${n} - ${e}`),s.sendStatus(404)}})})(e,t),Aa(e,t),((e,t)=>{e.get("/api/performancebuild/:nameOrId",(e,s)=>{ja({nameOrId:e.params.nameOrId,ctxFactory:t,req:e,res:s})})})(e,t),((e,t)=>{e.get("/api/version",(e,t)=>{t.status(200).send(V)})})(e)};B.config(),H();const{GraphQLServer:Ja}=C,{RedisPubSub:Ua}=L,{Prisma:Ga}=F,{validateToken:Va}=$s,{ExtractQueueSettings:Ha}=W,Ya=M("botium-box-server-index"),Xa=()=>new Ga({typeDefs:process.env.PRISMA_SCHEMA||"src/generated/prisma.graphql",endpoint:process.env.PRISMA_ENDPOINT,debug:process.env.PRISMA_DEBUG,secret:process.env.PRISMA_SECRET}),za=(e,t)=>{e&&console.log(e),t&&console.log(t),process.exit(1)};let Wa=Ha();Ya(`connecting to Botium queue '${JSON.stringify(Wa)}'`);const Ka=p.createQueue(Wa);Ka.setMaxListeners(1e3),Ka.watchStuckJobs(),Ka.on("error",e=>{console.log(`ERROR on queue '${JSON.stringify(Wa)}':`,e)}),process.env.BOTIUM_TEMPDIR=process.env.BOTIUM_TEMPDIR||"./botiumwork";try{r.sync(process.env.BOTIUM_TEMPDIR),Ya(`Using BOTIUM_TEMPDIR ${process.env.BOTIUM_TEMPDIR}`)}catch(e){za(`ERROR verifying BOTIUM_TEMPDIR '${process.env.BOTIUM_TEMPDIR}':`,e)}process.env.TESTSETDIR=process.env.TESTSETDIR||"./testsets";try{r.sync(process.env.TESTSETDIR),Ya(`Using TESTSETDIR ${process.env.TESTSETDIR}`)}catch(e){za(`ERROR verifying TESTSETDIR '${process.env.TESTSETDIR}':`,e)}jt(Xa());const Qa=new Ua({connection:Wa.redis});Qa.ee&&Qa.ee.setMaxListeners&&Qa.ee.setMaxListeners(0);const Za=new X(43200),er=e=>({...e||{},db:Xa(),queueConnector:Ka,queueSettings:Wa,pubsub:Qa,chartsCache:Za});Ya(`Using Prisma Endpoint ${process.env.PRISMA_ENDPOINT}`);const tr=new Ja({typeDefs:process.env.GRAPHQL_SCHEMA||"./src/schema.graphql",resolvers:Un,resolverValidationOptions:{requireResolversForResolveType:!1},schemaDirectives:ea,context:er,middlewares:[async(e,t,s,n,a)=>{try{const r=await e(t,s,n,a);return r instanceof Error&&Ya(r),r}catch(e){throw Ya(e),e}}]}),sr={port:process.env.PORT||4e3,endpoint:"/graphql",subscriptions:{path:"/subscriptions",onConnect:async(e,t,s)=>{if(e.Authorization){return{user:await Va(e.Authorization,Xa())}}throw new Error("Missing auth token!")},onDisconnect:(e,t)=>{}},playground:"/playground"};(async()=>{await Cn.loadStrategy(er),await ra(tr.express,0,er),await Fa(tr.express,er),tr.start(sr,({port:e})=>{const t=process.env.BOTIUMBOX_STATIC_PATH?T.resolve(process.env.BOTIUMBOX_STATIC_PATH):T.resolve(T.join(__dirname,"../../botium-box-client/build"));tr.express.use(U()),tr.express.use("/",J.static(t)),console.log(`Server started, listening on port ${e} for incoming requests, static files served from ${t}`)})})(),new class{constructor(e){this.ctxFactory=e}start(){const e=this.ctxFactory();e.queueConnector.process("agent.heartbeat",1,(t,s)=>{ls("agent.heartbeat: "+JSON.stringify(t.data)),(async(e,t,s)=>{try{const{count:n}=await e.db.mutation.updateManyAgents({data:{heartbeat:new Date(Date.now()).toISOString()},where:{name:t.data.name}});if(!(n>0)){const e=`Agent ${t.data.name} not configured`;return ds(e),s(e)}s()}catch(e){s(e)}})(e,t,s)}),e.queueConnector.process("agent.register",1,(t,s)=>{ls("agent.register: "+JSON.stringify(t.data)),(async(e,t,s)=>{const n=process.env.BOTIUMBOX_AGENTREGISTRATION&&"AUTO"===process.env.BOTIUMBOX_AGENTREGISTRATION||!0;try{let a=await Q.findAgentFromJobData(e.db,t);if(!a){if(!n){const e=`Agent ${t.data.name} not configured`;return us(e),s(e)}us(`Agent ${t.data.name} not yet registered, automatically registering.`),a=await e.db.mutation.createAgent({data:{name:t.data.name}})}let r=await Q.findAgentFromName(e.db,"Default Agent");const o=Q.combineBotiumCapabilities(Q.composeBotiumCapabilities(r&&r.capabilities||[]),Q.composeBotiumCapabilities(a.capabilities)),i={debug:!!(a.debug||r&&r.debug),botium:{Capabilities:o}};us(`Agent ${t.data.name} registered, config: ${JSON.stringify(i)}`),s(null,i)}catch(e){us(`Agent ${t.data.name} registration failed: ${O.inspect(e)}`),s(e)}})(e,t,s)}),e.queueConnector.process("box.createprocessingjobs",1,(t,s)=>{ls("box.createprocessingjobs: "+JSON.stringify(t.data)),Ts(e,t.data).then(()=>s()).catch(s)}),e.queueConnector.process("box.createperformanceprocessingjobs",1,(t,s)=>{ls("box.createperformanceprocessingjobs: "+JSON.stringify(t.data)),ps(e,t.data).then(()=>s()).catch(s)}),e.queueConnector.on("error",e=>{ls("ERROR connecting to queue:"),ls(e)}),e.queueConnector.on("job failed attempt",(e,t)=>{p.Job.get(e,(s,n)=>{s||(n=n.toJSON(),ls(`Job ${e}/${n.type} failed attempt, ${JSON.stringify(n.attempts)} - Err: ${t}`))})}).on("job failed",(e,t)=>{p.Job.get(e,(s,n)=>{s||(n=n.toJSON(),ls(`Job ${e}/${n.type} failed finally, ${JSON.stringify(n.attempts)} - Err: ${t} - Job Data: ${JSON.stringify(n.data)}`))})}),e.queueConnector.process("process.progress",1,async(t,s)=>{try{await Es(e,t.data),s()}catch(e){s(e)}}),e.queueConnector.process("process.log",1,async(t,s)=>{try{await ys(e,t.data),s()}catch(e){s(e)}}),e.queueConnector.process("process.ready.success",1,async(t,s)=>{ls("process.ready.success: "+JSON.stringify(t.data));try{await gs(e,t.data),await ws(e,t.data),s()}catch(e){s(e)}}),e.queueConnector.process("process.ready.failed",1,async(t,s)=>{ls("process.ready.failed: "+JSON.stringify(t.data));try{await bs(e,t.data),await ws(e,t.data),s()}catch(e){s(e)}}),e.queueConnector.process("performanceprocess.started",1,async(t,s)=>{ls("performanceprocess.started: "+JSON.stringify(t.data));try{await hs(e,t.data),s()}catch(e){s(e)}}),e.queueConnector.process("performanceprocess.progress",1,async(t,s)=>{ls("performanceprocess.progress: "+JSON.stringify(t.data));try{await Ss(e,t.data),s()}catch(e){s(e)}}),e.queueConnector.process("performanceprocess.ready.success",1,async(t,s)=>{ls("performanceprocess.ready.success: "+JSON.stringify(t.data));try{await fs(e,t.data),s()}catch(e){s(e)}}),e.queueConnector.process("performanceprocess.ready.failed",1,async(t,s)=>{ls("performanceprocess.ready.failed "+JSON.stringify(t.data));try{await ms(e,t.data),s()}catch(e){s(e)}})}}(er).start(),new class{constructor(e){this.ctxFactory=e}start(){const e=this.ctxFactory();Ns(e)}}(er).start(),Ht.startListeners(er()),process.on("uncaughtException",e=>{console.log("UNCAUGHTEXCEPTION",e),console.log(e.stack)}),process.on("warning",e=>{Ya("WARNING",e)});return{}});
